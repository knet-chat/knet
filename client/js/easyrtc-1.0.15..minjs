"use strict";function trace(text){if("\n"===text[text.length-1]&&(text=text.substring(0,text.length-1)),window.performance){var now=(window.performance.now()/1e3).toFixed(3);webrtcUtils.log(now+": "+text)}else webrtcUtils.log(text)}function requestUserMedia(constraints){return new Promise(function(resolve,reject){getUserMedia(constraints,resolve,reject)})}var getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,webrtcMinimumVersion=null,webrtcUtils={log:function(){console.log.apply(console,arguments)},extractVersion:function(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)}};if("object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return"mozSrcObject"in this?this.mozSrcObject:this._srcObject},set:function(stream){"mozSrcObject"in this?this.mozSrcObject=stream:(this._srcObject=stream,this.src=URL.createObjectURL(stream))}}),getUserMedia=window.navigator&&window.navigator.getUserMedia),attachMediaStream=function(element,stream){element.srcObject=stream},reattachMediaStream=function(to,from){to.srcObject=from.srcObject},"undefined"!=typeof window&&window.navigator)if(navigator.mozGetUserMedia){if(webrtcUtils.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),webrtcMinimumVersion=31,window.RTCPeerConnection||(window.RTCPeerConnection=function(pcConfig,pcConstraints){if(webrtcDetectedVersion<38&&pcConfig&&pcConfig.iceServers){for(var newIceServers=[],i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];if(server.hasOwnProperty("urls"))for(var j=0;j<server.urls.length;j++){var newServer={url:server.urls[j]};0===server.urls[j].indexOf("turn")&&(newServer.username=server.username,newServer.credential=server.credential),newIceServers.push(newServer)}else newIceServers.push(pcConfig.iceServers[i])}pcConfig.iceServers=newIceServers}return new mozRTCPeerConnection(pcConfig,pcConstraints)},mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return arguments.length?mozRTCPeerConnection.generateCertificate.apply(null,arguments):mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),getUserMedia=function(constraints,onSuccess,onError){var constraintsToFF37=function(c){if("object"!=typeof c||c.require)return c;var require=[];return Object.keys(c).forEach(function(key){if("require"!==key&&"advanced"!==key&&"mediaSource"!==key){var r=c[key]="object"==typeof c[key]?c[key]:{ideal:c[key]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||require.push(key),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:c[key]=r.exact,delete r.exact),void 0!==r.ideal){c.advanced=c.advanced||[];var oc={};"number"==typeof r.ideal?oc[key]={min:r.ideal,max:r.ideal}:oc[key]=r.ideal,c.advanced.push(oc),delete r.ideal,Object.keys(r).length||delete c[key]}}}),require.length&&(c.require=require),c};return webrtcDetectedVersion<38&&(webrtcUtils.log("spec: "+JSON.stringify(constraints)),constraints.audio&&(constraints.audio=constraintsToFF37(constraints.audio)),constraints.video&&(constraints.video=constraintsToFF37(constraints.video)),webrtcUtils.log("ff37: "+JSON.stringify(constraints))),navigator.mozGetUserMedia(constraints,onSuccess,onError)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(resolve){var infos=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];resolve(infos)})},webrtcDetectedVersion<41){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}}else if(navigator.webkitGetUserMedia&&window.webkitRTCPeerConnection&&!window.RTCPeerConnection){webrtcUtils.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),webrtcMinimumVersion=38,window.RTCPeerConnection=function(pcConfig,pcConstraints){pcConfig&&pcConfig.iceTransportPolicy&&(pcConfig.iceTransports=pcConfig.iceTransportPolicy);var pc=new webkitRTCPeerConnection(pcConfig,pcConstraints),origGetStats=pc.getStats.bind(pc);return pc.getStats=function(selector,successCallback,errorCallback){var self=this,args=arguments;if(arguments.length>0&&"function"==typeof selector)return origGetStats(selector,successCallback);var fixChromeStats=function(response){var standardReport={},reports=response.result();return reports.forEach(function(report){var standardStats={id:report.id,timestamp:report.timestamp,type:report.type};report.names().forEach(function(name){standardStats[name]=report.stat(name)}),standardReport[standardStats.id]=standardStats}),standardReport};if(arguments.length>=2){var successCallbackWrapper=function(response){args[1](fixChromeStats(response))};return origGetStats.apply(this,[successCallbackWrapper,arguments[0]])}return new Promise(function(resolve,reject){1===args.length&&null===selector?origGetStats.apply(self,[function(response){resolve.apply(null,[fixChromeStats(response)])},reject]):origGetStats.apply(self,[resolve,reject])})},pc},webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return arguments.length?webkitRTCPeerConnection.generateCertificate.apply(null,arguments):webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){var self=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var opts=1===arguments.length?arguments[0]:void 0;return new Promise(function(resolve,reject){nativeMethod.apply(self,[resolve,reject,opts])})}return nativeMethod.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=webkitRTCPeerConnection.prototype[method];webkitRTCPeerConnection.prototype[method]=function(){var args=arguments,self=this;return new Promise(function(resolve,reject){nativeMethod.apply(self,[args[0],function(){resolve(),args.length>=2&&args[1].apply(null,[])},function(err){reject(err),args.length>=3&&args[2].apply(null,[err])}])})}});var constraintsToChrome=function(c){if("object"!=typeof c||c.mandatory||c.optional)return c;var cc={};return Object.keys(c).forEach(function(key){if("require"!==key&&"advanced"!==key&&"mediaSource"!==key){var r="object"==typeof c[key]?c[key]:{ideal:c[key]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var oldname=function(prefix,name){return prefix?prefix+name.charAt(0).toUpperCase()+name.slice(1):"deviceId"===name?"sourceId":name};if(void 0!==r.ideal){cc.optional=cc.optional||[];var oc={};"number"==typeof r.ideal?(oc[oldname("min",key)]=r.ideal,cc.optional.push(oc),oc={},oc[oldname("max",key)]=r.ideal,cc.optional.push(oc)):(oc[oldname("",key)]=r.ideal,cc.optional.push(oc))}void 0!==r.exact&&"number"!=typeof r.exact?(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname("",key)]=r.exact):["min","max"].forEach(function(mix){void 0!==r[mix]&&(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname(mix,key)]=r[mix])})}}),c.advanced&&(cc.optional=(cc.optional||[]).concat(c.advanced)),cc};if(getUserMedia=function(constraints,onSuccess,onError){return constraints.audio&&(constraints.audio=constraintsToChrome(constraints.audio)),constraints.video&&(constraints.video=constraintsToChrome(constraints.video)),webrtcUtils.log("chrome: "+JSON.stringify(constraints)),navigator.webkitGetUserMedia(constraints,onSuccess,onError)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,enumerateDevices:function(){return new Promise(function(resolve){var kinds={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(devices){resolve(devices.map(function(device){return{label:device.label,kind:kinds[device.kind],deviceId:device.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return webrtcUtils.log("spec:   "+JSON.stringify(c)),c.audio=constraintsToChrome(c.audio),c.video=constraintsToChrome(c.video),webrtcUtils.log("chrome: "+JSON.stringify(c)),origGetUserMedia(c)}}else navigator.mediaDevices.getUserMedia=function(constraints){return requestUserMedia(constraints)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){webrtcUtils.log("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){webrtcUtils.log("Dummy mediaDevices.removeEventListener called.")}),attachMediaStream=function(element,stream){webrtcDetectedVersion>=43?element.srcObject=stream:"undefined"!=typeof element.src?element.src=URL.createObjectURL(stream):webrtcUtils.log("Error attaching stream to element.")},reattachMediaStream=function(to,from){webrtcDetectedVersion>=43?to.srcObject=from.srcObject:to.src=from.src}}else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)){if(webrtcUtils.log("This appears to be Edge"),webrtcDetectedBrowser="edge",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),webrtcMinimumVersion=10547,window.RTCIceGatherer){var generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},localCName=generateIdentifier(),SDPUtils={};SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map(function(line){return line.trim()})},SDPUtils.splitSections=function(blob){var parts=blob.split("\r\nm=");return parts.map(function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"})},SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter(function(line){return 0===line.indexOf(prefix)})},SDPUtils.parseCandidate=function(line){var parts;parts=0===line.indexOf("a=candidate:")?line.substring(12).split(" "):line.substring(10).split(" ");for(var candidate={foundation:parts[0],component:parts[1],protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],port:parseInt(parts[5],10),type:parts[7]},i=8;i<parts.length;i+=2)switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1]}return candidate},SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation),sdp.push(candidate.component),sdp.push(candidate.protocol.toUpperCase()),sdp.push(candidate.priority),sdp.push(candidate.ip),sdp.push(candidate.port);var type=candidate.type;return sdp.push("typ"),sdp.push(type),"host"!==type&&candidate.relatedAddress&&candidate.relatedPort&&(sdp.push("raddr"),sdp.push(candidate.relatedAddress),sdp.push("rport"),sdp.push(candidate.relatedPort)),candidate.tcpType&&"tcp"===candidate.protocol.toLowerCase()&&(sdp.push("tcptype"),sdp.push(candidate.tcpType)),"candidate:"+sdp.join(" ")},SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" "),parsed={payloadType:parseInt(parts.shift(),10)};return parts=parts[0].split("/"),parsed.name=parts[0],parsed.clockRate=parseInt(parts[1],10),parsed.numChannels=3===parts.length?parseInt(parts[2],10):1,parsed},SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;return void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(1!==codec.numChannels?"/"+codec.numChannels:"")+"\r\n"},SDPUtils.parseFmtp=function(line){for(var kv,parsed={},parts=line.substr(line.indexOf(" ")+1).split(";"),j=0;j<parts.length;j++)kv=parts[j].trim().split("="),parsed[kv[0].trim()]=kv[1];return parsed},SDPUtils.writeFtmp=function(codec){var line="",pt=codec.payloadType;if(void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),codec.parameters&&codec.parameters.length){var params=[];Object.keys(codec.parameters).forEach(function(param){params.push(param+"="+codec.parameters[param])}),line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line},SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}},SDPUtils.writeRtcpFb=function(codec){var lines="",pt=codec.payloadType;return void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),codec.rtcpFeedback&&codec.rtcpFeedback.length&&codec.rtcpFeedback.forEach(function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+" "+fb.parameter+"\r\n"}),lines},SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" "),parts={ssrc:line.substr(7,sp-7)},colon=line.indexOf(":",sp);return colon>-1?(parts.attribute=line.substr(sp+1,colon-sp-1),parts.value=line.substr(colon+1)):parts.attribute=line.substr(sp+1),parts},SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);lines=lines.concat(SDPUtils.splitLines(sessionpart));var fpLine=lines.filter(function(line){return 0===line.indexOf("a=fingerprint:")})[0].substr(14),dtlsParameters={role:"auto",fingerprints:[{algorithm:fpLine.split(" ")[0],value:fpLine.split(" ")[1]}]};return dtlsParameters},SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";return params.fingerprints.forEach(function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"}),sdp},SDPUtils.getIceParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);lines=lines.concat(SDPUtils.splitLines(sessionpart));var iceParameters={usernameFragment:lines.filter(function(line){return 0===line.indexOf("a=ice-ufrag:")})[0].substr(12),password:lines.filter(function(line){return 0===line.indexOf("a=ice-pwd:")})[0].substr(10)};return iceParameters},SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\na=ice-pwd:"+params.password+"\r\n"},SDPUtils.parseRtpParameters=function(mediaSection){for(var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},lines=SDPUtils.splitLines(mediaSection),mline=lines[0].split(" "),i=3;i<mline.length;i++){var pt=mline[i],rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline),fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{},codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb),description.codecs.push(codec)}}return description},SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";return sdp+="m="+kind+" ",sdp+=caps.codecs.length>0?"9":"0",sdp+=" UDP/TLS/RTP/SAVPF ",sdp+=caps.codecs.map(function(codec){return void 0!==codec.preferredPayloadType?codec.preferredPayloadType:codec.payloadType}).join(" ")+"\r\n",sdp+="c=IN IP4 0.0.0.0\r\n",sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n",caps.codecs.forEach(function(codec){sdp+=SDPUtils.writeRtpMap(codec),sdp+=SDPUtils.writeFtmp(codec),sdp+=SDPUtils.writeRtcpFb(codec)}),sdp+="a=rtcp-mux\r\n"},SDPUtils.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);if(sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters()),sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),"offer"===type?"actpass":"active"),sdp+="a=mid:"+transceiver.mid+"\r\n",sdp+=transceiver.rtpSender&&transceiver.rtpReceiver?"a=sendrecv\r\n":transceiver.rtpSender?"a=sendonly\r\n":transceiver.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid,sdp+="a=ssrc:"+transceiver.sendSsrc+" "+msid}return sdp+="a=ssrc:"+transceiver.sendSsrc+" cname:"+localCName+"\r\n"},SDPUtils.getDirection=function(mediaSection,sessionpart){for(var lines=SDPUtils.splitLines(mediaSection),i=0;i<lines.length;i++)switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2)}return sessionpart?SDPUtils.getDirection(sessionpart):"sendrecv"},window.RTCIceCandidate||(window.RTCIceCandidate=function(args){return args}),window.RTCSessionDescription||(window.RTCSessionDescription=function(args){return args}),window.RTCPeerConnection=function(config){var self=this;if(this.onicecandidate=null,this.onaddstream=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return self.localStreams},this.getRemoteStreams=function(){return self.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},config&&config.iceTransportPolicy)switch(config.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=config.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}config&&config.iceServers&&config.iceServers.forEach(function(server){if(server.urls){var url;url="string"==typeof server.urls?server.urls:server.urls[0],url.indexOf("transport=udp")!==-1&&self.iceServers.push({username:server.username,credential:server.credential,urls:url})}}),this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var self=this;this._localIceCandidatesBuffer.forEach(function(event){null!==self.onicecandidate&&self.onicecandidate(event)}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.addStream=function(stream){this.localStreams.push(stream.clone()),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(stream){var idx=this.localStreams.indexOf(stream);idx>-1&&(this.localStreams.splice(idx,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype._getCommonCapabilities=function(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]};return localCapabilities.codecs.forEach(function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate&&lCodec.numChannels===rCodec.numChannels){commonCapabilities.codecs.push(rCodec);break}}}),localCapabilities.headerExtensions.forEach(function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}}),commonCapabilities},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(mid,sdpMLineIndex){var self=this,iceGatherer=new RTCIceGatherer(self.iceOptions),iceTransport=new RTCIceTransport(iceGatherer);iceGatherer.onlocalcandidate=function(evt){var event={};event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate;cand&&0!==Object.keys(cand).length?(cand.component="RTCP"===iceTransport.component?2:1,event.candidate.candidate=SDPUtils.writeCandidate(cand)):(void 0===iceGatherer.state&&(iceGatherer.state="completed"),event.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates");var complete=self.transceivers.every(function(transceiver){return transceiver.iceGatherer&&"completed"===transceiver.iceGatherer.state});null!==self.onicecandidate&&(self.localDescription&&""===self.localDescription.type?(self._localIceCandidatesBuffer.push(event),complete&&self._localIceCandidatesBuffer.push({})):(self.onicecandidate(event),complete&&self.onicecandidate({})))},iceTransport.onicestatechange=function(){self._updateConnectionState()};var dtlsTransport=new RTCDtlsTransport(iceTransport);return dtlsTransport.ondtlsstatechange=function(){self._updateConnectionState()},dtlsTransport.onerror=function(){dtlsTransport.state="failed",self._updateConnectionState()},{iceGatherer:iceGatherer,iceTransport:iceTransport,dtlsTransport:dtlsTransport}},window.RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=this._getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);send&&transceiver.rtpSender&&(params.encodings=[{ssrc:transceiver.sendSsrc}],params.rtcp={cname:localCName,ssrc:transceiver.recvSsrc},transceiver.rtpSender.send(params)),recv&&transceiver.rtpReceiver&&(params.encodings=[{ssrc:transceiver.recvSsrc}],params.rtcp={cname:transceiver.cname,ssrc:transceiver.sendSsrc},transceiver.rtpReceiver.receive(params))},window.RTCPeerConnection.prototype.setLocalDescription=function(description){var self=this;if("offer"===description.type)this._pendingOffer&&(this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===description.type){var sections=SDPUtils.splitSections(self.remoteDescription.sdp),sessionpart=sections.shift();sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver=self.transceivers[sdpMLineIndex],iceGatherer=transceiver.iceGatherer,iceTransport=transceiver.iceTransport,dtlsTransport=transceiver.dtlsTransport,localCapabilities=transceiver.localCapabilities,remoteCapabilities=transceiver.remoteCapabilities,rejected="0"===mediaSection.split("\n",1)[0].split(" ",2)[1];if(!rejected){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);iceTransport.start(iceGatherer,remoteIceParameters,"controlled");var remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);dtlsTransport.start(remoteDtlsParameters);var params=self._getCommonCapabilities(localCapabilities,remoteCapabilities);self._transceive(transceiver,params.codecs.length>0,!1)}})}switch(this.localDescription=description,description.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+description.type+'"')}var hasCallback=arguments.length>1&&"function"==typeof arguments[1];if(hasCallback){var cb=arguments[1];window.setTimeout(function(){cb(),self._emitBufferedCandidates()},0)}var p=Promise.resolve();return p.then(function(){hasCallback||window.setTimeout(self._emitBufferedCandidates.bind(self),0)}),p},window.RTCPeerConnection.prototype.setRemoteDescription=function(description){var self=this,stream=new MediaStream,sections=SDPUtils.splitSections(description.sdp),sessionpart=sections.shift();switch(sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver,iceGatherer,iceTransport,dtlsTransport,rtpSender,rtpReceiver,sendSsrc,recvSsrc,localCapabilities,remoteIceParameters,remoteDtlsParameters,lines=SDPUtils.splitLines(mediaSection),mline=lines[0].substr(2).split(" "),kind=mline[0],rejected="0"===mline[1],direction=SDPUtils.getDirection(mediaSection,sessionpart),remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);rejected||(remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart),remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart));var cname,mid=SDPUtils.matchPrefix(mediaSection,"a=mid:")[0].substr(6),remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(obj){return"cname"===obj.attribute})[0];if(remoteSsrc&&(recvSsrc=parseInt(remoteSsrc.ssrc,10),cname=remoteSsrc.value),"offer"===description.type){var transports=self._createIceAndDtlsTransports(mid,sdpMLineIndex);if(localCapabilities=RTCRtpReceiver.getCapabilities(kind),sendSsrc=1001*(2*sdpMLineIndex+2),rtpReceiver=new RTCRtpReceiver(transports.dtlsTransport,kind),stream.addTrack(rtpReceiver.track),self.localStreams.length>0&&self.localStreams[0].getTracks().length>=sdpMLineIndex){var localtrack=self.localStreams[0].getTracks()[sdpMLineIndex];rtpSender=new RTCRtpSender(localtrack,transports.dtlsTransport)}self.transceivers[sdpMLineIndex]={iceGatherer:transports.iceGatherer,iceTransport:transports.iceTransport,dtlsTransport:transports.dtlsTransport,localCapabilities:localCapabilities,remoteCapabilities:remoteCapabilities,rtpSender:rtpSender,rtpReceiver:rtpReceiver,kind:kind,mid:mid,cname:cname,sendSsrc:sendSsrc,recvSsrc:recvSsrc},self._transceive(self.transceivers[sdpMLineIndex],!1,"sendrecv"===direction||"sendonly"===direction)}else"answer"!==description.type||rejected||(transceiver=self.transceivers[sdpMLineIndex],iceGatherer=transceiver.iceGatherer,iceTransport=transceiver.iceTransport,dtlsTransport=transceiver.dtlsTransport,rtpSender=transceiver.rtpSender,rtpReceiver=transceiver.rtpReceiver,sendSsrc=transceiver.sendSsrc,localCapabilities=transceiver.localCapabilities,self.transceivers[sdpMLineIndex].recvSsrc=recvSsrc,self.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities,self.transceivers[sdpMLineIndex].cname=cname,iceTransport.start(iceGatherer,remoteIceParameters,"controlling"),dtlsTransport.start(remoteDtlsParameters),self._transceive(transceiver,"sendrecv"===direction||"recvonly"===direction,"sendrecv"===direction||"sendonly"===direction),!rtpReceiver||"sendrecv"!==direction&&"sendonly"!==direction?delete transceiver.rtpReceiver:stream.addTrack(rtpReceiver.track))}),this.remoteDescription=description,description.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+description.type+'"')}return window.setTimeout(function(){null!==self.onaddstream&&stream.getTracks().length&&(self.remoteStreams.push(stream),window.setTimeout(function(){self.onaddstream({stream:stream})},0))},0),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(transceiver){transceiver.iceTransport&&transceiver.iceTransport.stop(),transceiver.dtlsTransport&&transceiver.dtlsTransport.stop(),transceiver.rtpSender&&transceiver.rtpSender.stop(),transceiver.rtpReceiver&&transceiver.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState,null!==this.onsignalingstatechange&&this.onsignalingstatechange()},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){null!==this.onnegotiationneeded&&this.onnegotiationneeded()},window.RTCPeerConnection.prototype._updateConnectionState=function(){var newState,self=this,states={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};this.transceivers.forEach(function(transceiver){states[transceiver.iceTransport.state]++,states[transceiver.dtlsTransport.state]++}),states.connected+=states.completed,newState="new",states.failed>0?newState="failed":states.connecting>0||states.checking>0?newState="connecting":states.disconnected>0?newState="disconnected":states.new>0?newState="new":(states.connecting>0||states.completed>0)&&(newState="connected"),newState!==self.iceConnectionState&&(self.iceConnectionState=newState,null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange())},window.RTCPeerConnection.prototype.createOffer=function(){var self=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var offerOptions;1===arguments.length&&"function"!=typeof arguments[0]?offerOptions=arguments[0]:3===arguments.length&&(offerOptions=arguments[2]);var tracks=[],numAudioTracks=0,numVideoTracks=0;if(this.localStreams.length&&(numAudioTracks=this.localStreams[0].getAudioTracks().length,numVideoTracks=this.localStreams[0].getVideoTracks().length),offerOptions){if(offerOptions.mandatory||offerOptions.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==offerOptions.offerToReceiveAudio&&(numAudioTracks=offerOptions.offerToReceiveAudio),void 0!==offerOptions.offerToReceiveVideo&&(numVideoTracks=offerOptions.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(track){tracks.push({kind:track.kind,track:track,wantReceive:"audio"===track.kind?numAudioTracks>0:numVideoTracks>0}),"audio"===track.kind?numAudioTracks--:"video"===track.kind&&numVideoTracks--});numAudioTracks>0||numVideoTracks>0;)numAudioTracks>0&&(tracks.push({kind:"audio",wantReceive:!0}),numAudioTracks--),numVideoTracks>0&&(tracks.push({kind:"video",wantReceive:!0}),numVideoTracks--);var sdp=SDPUtils.writeSessionBoilerplate(),transceivers=[];tracks.forEach(function(mline,sdpMLineIndex){var rtpSender,rtpReceiver,track=mline.track,kind=mline.kind,mid=generateIdentifier(),transports=self._createIceAndDtlsTransports(mid,sdpMLineIndex),localCapabilities=RTCRtpSender.getCapabilities(kind),sendSsrc=1001*(2*sdpMLineIndex+1);track&&(rtpSender=new RTCRtpSender(track,transports.dtlsTransport)),mline.wantReceive&&(rtpReceiver=new RTCRtpReceiver(transports.dtlsTransport,kind)),transceivers[sdpMLineIndex]={iceGatherer:transports.iceGatherer,iceTransport:transports.iceTransport,dtlsTransport:transports.dtlsTransport,localCapabilities:localCapabilities,remoteCapabilities:null,rtpSender:rtpSender,rtpReceiver:rtpReceiver,kind:kind,mid:mid,sendSsrc:sendSsrc,recvSsrc:null};var transceiver=transceivers[sdpMLineIndex];sdp+=SDPUtils.writeMediaSection(transceiver,transceiver.localCapabilities,"offer",self.localStreams[0])}),this._pendingOffer=transceivers;var desc=new RTCSessionDescription({type:"offer",sdp:sdp});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,desc),Promise.resolve(desc)},window.RTCPeerConnection.prototype.createAnswer=function(){var answerOptions,self=this;1===arguments.length&&"function"!=typeof arguments[0]?answerOptions=arguments[0]:3===arguments.length&&(answerOptions=arguments[2]);var sdp=SDPUtils.writeSessionBoilerplate();this.transceivers.forEach(function(transceiver){var commonCapabilities=self._getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);sdp+=SDPUtils.writeMediaSection(transceiver,commonCapabilities,"answer",self.localStreams[0])});var desc=new RTCSessionDescription({type:"answer",sdp:sdp});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,desc),Promise.resolve(desc)},window.RTCPeerConnection.prototype.addIceCandidate=function(candidate){var mLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid)for(var i=0;i<this.transceivers.length;i++)if(this.transceivers[i].mid===candidate.sdpMid){mLineIndex=i;break}var transceiver=this.transceivers[mLineIndex];if(transceiver){var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if("tcp"===cand.protocol&&0===cand.port)return;if("1"!==cand.component)return;"endOfCandidates"===cand.type&&(cand={}),
transceiver.iceTransport.addRemoteCandidate(cand)}return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var promises=[];this.transceivers.forEach(function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(method){transceiver[method]&&promises.push(transceiver[method].getStats())})});var cb=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(resolve){var results={};Promise.all(promises).then(function(res){res.forEach(function(result){Object.keys(result).forEach(function(id){results[id]=result[id]})}),cb&&window.setTimeout(cb,0,results),resolve(results)})})}}}else webrtcUtils.log("Browser does not appear to be WebRTC-capable");else webrtcUtils.log("This does not appear to be a browser"),webrtcDetectedBrowser="not a browser";"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(f){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=f),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(track){var event=new Event("track");event.track=track,event.receiver={track:track},event.streams=[e.stream],this.dispatchEvent(event)}.bind(this))}.bind(this))}});var webrtcTesting={};try{Object.defineProperty(webrtcTesting,"version",{set:function(version){webrtcDetectedVersion=version}})}catch(e){}var Easyrtc=function(){function isEmptyObj(obj){if(null===obj||void 0===obj)return!0;var key;for(key in obj)if(obj.hasOwnProperty(key))return!1;return!0}function stopStream(stream){var i,tracks;for(tracks=stream.getAudioTracks(),i=0;i<tracks.length;i++)try{tracks[i].stop()}catch(err){}for(tracks=stream.getVideoTracks(),i=0;i<tracks.length;i++)try{tracks[i].stop()}catch(err){}if("function"==typeof stream.stop)try{stream.stop()}catch(err){}}function isSocketConnected(socket){return socket&&(socket.socket&&socket.socket.connected||socket.connected)}function event(eventName,callingFunction){if("string"!=typeof eventName)throw self.showError(self.errCodes.DEVELOPER_ERR,callingFunction+" called without a string as the first argument"),"developer error";if(!allowedEvents[eventName])throw self.showError(self.errCodes.DEVELOPER_ERR,callingFunction+" called with a bad event name = "+eventName),"developer error"}function getSourceList(callback,sourceType){navigator.mediaDevices.enumerateDevices().then(function(values){for(var results=[],i=0;i<values.length;i++){var source=values[i];source.kind===sourceType&&results.push(source)}callback(results)}).catch(function(reason){webrtcUtils.log("Unable to enumerate devices ("+reason+")")})}function sendRoomApiFields(roomName,fields){var fieldAsString=JSON.stringify(fields);JSON.parse(fieldAsString);var dataToShip={msgType:"setRoomApiField",msgData:{setRoomApiField:{roomName:roomName,field:fields}}};self.webSocket.json.emit("easyrtcCmd",dataToShip,function(ackMsg){"error"===ackMsg.msgType&&self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText)})}function enqueueSendRoomApi(roomName){roomApiFieldTimer&&clearTimeout(roomApiFieldTimer),roomApiFieldTimer=setTimeout(function(){sendRoomApiFields(roomName,self._roomApiFields[roomName]),roomApiFieldTimer=null},10)}function enableMediaTracks(enable,tracks){var i;if(tracks)for(i=0;i<tracks.length;i++){var track=tracks[i];track.enabled=enable}}function getLocalMediaStreamByName(streamName){return streamName||(streamName="default"),namedLocalMediaStreams.hasOwnProperty(streamName)?namedLocalMediaStreams[streamName]:null}function buildMediaIds(){var streamName,mediaMap={};for(streamName in namedLocalMediaStreams)namedLocalMediaStreams.hasOwnProperty(streamName)&&(mediaMap[streamName]=namedLocalMediaStreams[streamName].id||"default");return mediaMap}function registerLocalMediaStreamByName(stream,streamName){var roomName;if(streamName||(streamName="default"),stream.streamName=streamName,namedLocalMediaStreams[streamName]=stream,"default"!==streamName){var mediaIds=buildMediaIds(),roomData=self.roomData;for(roomName in roomData)roomData.hasOwnProperty(roomName)&&self.setRoomApiField(roomName,"mediaIds",mediaIds)}}function getNameOfRemoteStream(easyrtcId,webrtcStreamId){var roomName,mediaIds,streamName;if(webrtcStreamId||(webrtcStreamId="default"),peerConns[easyrtcId]&&(streamName=peerConns[easyrtcId].remoteStreamIdToName[webrtcStreamId]))return streamName;for(roomName in self.roomData)if(self.roomData.hasOwnProperty(roomName)){if(mediaIds=self.getRoomApiField(roomName,easyrtcId,"mediaIds"),!mediaIds)continue;for(streamName in mediaIds)if(mediaIds.hasOwnProperty(streamName)&&mediaIds[streamName]===webrtcStreamId)return streamName;if("firefox"===webrtcDetectedBrowser){if(mediaIds.default)return"default";for(var anyName in mediaIds)if(mediaIds.hasOwnProperty(anyName))return anyName}}}function closeLocalMediaStreamByName(streamName){streamName||(streamName="default");var stream=self.getLocalStream(streamName);if(stream){var id,roomName,streamId=stream.id||"default";if(namedLocalMediaStreams[streamName]){for(id in peerConns)if(peerConns.hasOwnProperty(id)){try{peerConns[id].pc.removeStream(stream)}catch(err){}self.sendPeerMessage(id,"__closingMediaStream",{streamId:streamId,streamName:streamName})}if(stopStream(namedLocalMediaStreams[streamName]),delete namedLocalMediaStreams[streamName],"default"!==streamName){var mediaIds=buildMediaIds();for(roomName in self.roomData)self.roomData.hasOwnProperty(roomName)&&self.setRoomApiField(roomName,"mediaIds",mediaIds)}}}}function _haveTracks(easyrtcid,checkAudio,streamName){var stream,peerConnObj;if(easyrtcid){if(peerConnObj=peerConns[easyrtcid],!peerConnObj)return self.showError(self.errCodes.DEVELOPER_ERR,"haveTracks called about a peer you don't have a connection to"),!1;stream=peerConnObj.getRemoteStreamByName(streamName)}else stream=getLocalMediaStreamByName(streamName);if(!stream)return!1;var tracks;try{tracks=checkAudio?stream.getAudioTracks():stream.getVideoTracks()}catch(oops){return!0}return!!tracks&&tracks.length>0}function disconnectBody(){var key;if(self.loggingOut=!0,offersPending={},acceptancePending={},self.disconnecting=!0,closedChannel=self.webSocket,self.webSocketConnected&&(preallocatedSocketIo||self.webSocket.close(),self.webSocketConnected=!1),self.hangupAll(),roomOccupantListener)for(key in lastLoggedInList)lastLoggedInList.hasOwnProperty(key)&&roomOccupantListener(key,{},!1);lastLoggedInList={},self.emitEvent("roomOccupant",{}),self.roomData={},self.roomJoin={},self.loggingOut=!1,self.myEasyrtcid=null,self.disconnecting=!1,oldConfig={}}function sendSignalling(destUser,msgType,msgData,successCallback,errorCallback){if(!self.webSocket)throw"Attempt to send message without a valid connection to the server.";var dataToShip={msgType:msgType};destUser&&(dataToShip.targetEasyrtcid=destUser),msgData&&(dataToShip.msgData=msgData),self.debugPrinter&&self.debugPrinter("sending socket message "+JSON.stringify(dataToShip)),self.webSocket.json.emit("easyrtcCmd",dataToShip,function(ackMsg){"error"!==ackMsg.msgType?(ackMsg.hasOwnProperty("msgData")||(ackMsg.msgData=null),successCallback&&successCallback(ackMsg.msgType,ackMsg.msgData)):errorCallback?errorCallback(ackMsg.msgData.errorCode,ackMsg.msgData.errorText):self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText)})}function sendByChunkHelper(destUser,msgData){var pos,len,startMessage,message,endMessage,transferId=destUser+"-"+sendByChunkUidCounter++,numberOfChunks=Math.ceil(msgData.length/self.maxP2PMessageLength);for(startMessage={transfer:"start",transferId:transferId,parts:numberOfChunks},endMessage={transfer:"end",transferId:transferId},peerConns[destUser].dataChannelS.send(JSON.stringify(startMessage)),pos=0,len=msgData.length;pos<len;pos+=self.maxP2PMessageLength)message={transferId:transferId,data:msgData.substr(pos,self.maxP2PMessageLength),transfer:"chunk"},peerConns[destUser].dataChannelS.send(JSON.stringify(message));peerConns[destUser].dataChannelS.send(JSON.stringify(endMessage))}function buildPeerConstraints(){var options=[];return options.push({DtlsSrtpKeyAgreement:"true"}),{optional:options}}function sendQueuedCandidates(peer,onSignalSuccess,onSignalFailure){var i;for(i=0;i<peerConns[peer].candidatesToSend.length;i++)sendSignalling(peer,"candidate",peerConns[peer].candidatesToSend[i],onSignalSuccess,onSignalFailure)}function emitOnStreamClosed(easyrtcid,stream){if(peerConns[easyrtcid]){var streamName,id;id=stream.id?stream.id:"default",streamName=peerConns[easyrtcid].remoteStreamIdToName[id]||"default",peerConns[easyrtcid].liveRemoteStreams[streamName]&&self.onStreamClosed&&(delete peerConns[easyrtcid].liveRemoteStreams[streamName],self.onStreamClosed(easyrtcid,stream,streamName)),delete peerConns[easyrtcid].remoteStreamIdToName[id]}}function onRemoveStreamHelper(easyrtcid,stream){if(peerConns[easyrtcid]&&(emitOnStreamClosed(easyrtcid,stream),updateConfigurationInfo(),peerConns[easyrtcid].pc))try{peerConns[easyrtcid].pc.removeStream(stream)}catch(err){}}function buildDeltaRecord(added,deleted){function objectNotEmpty(obj){var i;for(i in obj)if(obj.hasOwnProperty(i))return!0;return!1}var result={};return objectNotEmpty(added)&&(result.added=added),objectNotEmpty(deleted)&&(result.deleted=deleted),objectNotEmpty(result)?result:null}function findDeltas(oldVersion,newVersion){var i,subPart,added={},deleted={};for(i in newVersion)newVersion.hasOwnProperty(i)&&(null===oldVersion||"undefined"==typeof oldVersion[i]?added[i]=newVersion[i]:"object"==typeof newVersion[i]?(subPart=findDeltas(oldVersion[i],newVersion[i]),null!==subPart&&(added[i]=newVersion[i])):newVersion[i]!==oldVersion[i]&&(added[i]=newVersion[i]));for(i in oldVersion)newVersion.hasOwnProperty(i)&&"undefined"==typeof newVersion[i]&&(deleted[i]=oldVersion[i]);return buildDeltaRecord(added,deleted)}function collectConfigurationInfo(){var i,p2pList={};for(i in peerConns)peerConns.hasOwnProperty(i)&&(p2pList[i]={connectTime:peerConns[i].connectTime,isInitiator:!!peerConns[i].isInitiator});var newConfig={userSettings:{sharingAudio:!!haveAudioVideo.audio,sharingVideo:!!haveAudioVideo.video,sharingData:!!dataEnabled,nativeVideoWidth:self.nativeVideoWidth,nativeVideoHeight:self.nativeVideoHeight,windowWidth:window.innerWidth,windowHeight:window.innerHeight,screenWidth:window.screen.width,screenHeight:window.screen.height,cookieEnabled:navigator.cookieEnabled,os:navigator.oscpu,language:navigator.language}};return isEmptyObj(p2pList)||(newConfig.p2pList=p2pList),newConfig}function updateConfiguration(){var newConfig=collectConfigurationInfo(!1),sendDeltas=function(){var alteredData=findDeltas(oldConfig,newConfig);alteredData&&(self.debugPrinter&&self.debugPrinter("cfg="+JSON.stringify(alteredData.added)),self.webSocket&&sendSignalling(null,"setUserCfg",{setUserCfg:alteredData.added},null,null)),oldConfig=newConfig};oldConfig==={}?sendDeltas():setTimeout(sendDeltas,100)}function buildPeerConnection(otherUser,isInitiator,failureCB,streamNames){function dataChannelMessageHandler(event){if(self.debugPrinter&&self.debugPrinter("saw dataChannel.onmessage event: "+JSON.stringify(event.data)),"dataChannelPrimed"===event.data)self.sendDataWS(otherUser,"dataChannelPrimed","");else try{var msg=JSON.parse(event.data);if(msg)if(msg.transfer&&msg.transferId)if("start"===msg.transfer){self.debugPrinter&&self.debugPrinter("start transfer #"+msg.transferId);var parts=parseInt(msg.parts);pendingTransfer={chunks:[],parts:parts,transferId:msg.transferId}}else if("chunk"===msg.transfer)self.debugPrinter&&self.debugPrinter("got chunk for transfer #"+msg.transferId),"string"==typeof msg.data&&msg.data.length<=self.maxP2PMessageLength?pendingTransfer?msg.transferId!==pendingTransfer.transferId?webrtcUtils.log("Developer error, invalid transfer id"):pendingTransfer.chunks.length+1>pendingTransfer.parts?webrtcUtils.log("Developer error, received too many chunks"):pendingTransfer.chunks.push(msg.data):webrtcUtils.log("Developer error, unexpected chunk"):webrtcUtils.log("Developer error, invalid data");else if("end"===msg.transfer){if(self.debugPrinter&&self.debugPrinter("end of transfer #"+msg.transferId),pendingTransfer)if(msg.transferId!==pendingTransfer.transferId)webrtcUtils.log("Developer error, invalid transfer id");else if(pendingTransfer.chunks.length!==pendingTransfer.parts)webrtcUtils.log("Developer error, received wrong number of chunks");else try{var chunkedMsg=JSON.parse(pendingTransfer.chunks.join(""));self.receivePeerDistribute(otherUser,chunkedMsg,null)}catch(err){webrtcUtils.log("Developer error, unable to parse message")}else webrtcUtils.log("Developer error, unexpected end of transfer");pendingTransfer={}}else webrtcUtils.log("Developer error, got an unknown transfer message"+msg.transfer);else self.receivePeerDistribute(otherUser,msg,null)}catch(err){}}function initOutGoingChannel(otherUser){self.debugPrinter&&self.debugPrinter("saw initOutgoingChannel call");var dataChannel=pc.createDataChannel(dataChannelName,self.getDatachannelConstraints());peerConns[otherUser].dataChannelS=dataChannel,peerConns[otherUser].dataChannelR=dataChannel,dataChannel.onmessage=dataChannelMessageHandler,dataChannel.onopen=function(event){self.debugPrinter&&self.debugPrinter("saw dataChannel.onopen event"),peerConns[otherUser]&&dataChannel.send("dataChannelPrimed")},dataChannel.onclose=function(event){self.debugPrinter&&self.debugPrinter("saw dataChannelS.onclose event"),peerConns[otherUser]&&(peerConns[otherUser].dataChannelReady=!1,delete peerConns[otherUser].dataChannelS),onDataChannelClose&&onDataChannelClose(otherUser),updateConfigurationInfo()}}function initIncomingChannel(otherUser){self.debugPrinter&&self.debugPrinter("initializing incoming channel handler for "+otherUser),peerConns[otherUser].pc.ondatachannel=function(event){self.debugPrinter&&self.debugPrinter("saw incoming data channel");var dataChannel=event.channel;peerConns[otherUser].dataChannelR=dataChannel,peerConns[otherUser].dataChannelS=dataChannel,peerConns[otherUser].dataChannelReady=!0,dataChannel.onmessage=dataChannelMessageHandler,dataChannel.onclose=function(event){self.debugPrinter&&self.debugPrinter("saw dataChannelR.onclose event"),peerConns[otherUser]&&(peerConns[otherUser].dataChannelReady=!1,delete peerConns[otherUser].dataChannelR),onDataChannelClose&&onDataChannelClose(otherUser),updateConfigurationInfo()},dataChannel.onopen=function(event){self.debugPrinter&&self.debugPrinter("saw dataChannel.onopen event"),peerConns[otherUser]&&dataChannel.send("dataChannelPrimed")}}}var pc,message,newPeerConn,iceConfig=pc_config_to_use?pc_config_to_use:pc_config;self.debugPrinter&&self.debugPrinter("building peer connection to "+otherUser);try{if(pc=self.createRTCPeerConnection(iceConfig,buildPeerConstraints()),!pc)throw message="Unable to create PeerConnection object, check your ice configuration("+JSON.stringify(iceConfig)+")",self.debugPrinter&&self.debugPrinter(message),message;dataEnabled&&"undefined"==typeof pc.createDataChannel&&(dataEnabled=!1),pc.onnegotiationneeded=function(event){peerConns[otherUser]&&peerConns[otherUser].enableNegotiateListener&&pc.createOffer(function(sdp){sdpLocalFilter&&(sdp.sdp=sdpLocalFilter(sdp.sdp)),pc.setLocalDescription(sdp,function(){self.sendPeerMessage(otherUser,"__addedMediaStream",{sdp:sdp})},function(){})},function(error){webrtcUtils.log("unexpected error in creating offer")})},pc.oniceconnectionstatechange=function(ev){iceConnectionStateChangeListener&&iceConnectionStateChangeListener(otherUser,ev.target);var connState=ev.currentTarget?ev.currentTarget.iceConnectionState:"unknown";switch(connState){case"connected":peerConns[otherUser]&&peerConns[otherUser].callSuccessCB&&peerConns[otherUser].callSuccessCB(otherUser,"connection");break;case"failed":failureCB&&failureCB(self.errCodes.NOVIABLEICE,"No usable STUN/TURN path"),delete peerConns[otherUser];break;case"disconnected":self.onPeerFailing&&self.onPeerFailing(otherUser),peerConns[otherUser]&&(peerConns[otherUser].failing=Date.now());break;case"closed":self.onPeerClosed&&self.onPeerClosed(otherUser);break;case"connected":case"completed":peerConns[otherUser]&&(peerConns[otherUser].failing&&self.onPeerRecovered&&self.onPeerRecovered(otherUser,peerConns[otherUser].failing,Date.now()),delete peerConns[otherUser].failing),delete peerConns[otherUser].failing}},pc.onconnection=function(){self.debugPrinter&&self.debugPrinter("onconnection called prematurely")},newPeerConn={pc:pc,candidatesToSend:[],startedAV:!1,connectionAccepted:!1,isInitiator:isInitiator,remoteStreamIdToName:{},streamsAddedAcks:{},liveRemoteStreams:{},getRemoteStreamByName:function(streamName){var i,roomName,remoteStreams=pc.getRemoteStreams(),keyToMatch=null;if(streamName||(streamName="default"),"default"===streamName)return remoteStreams.length>0?remoteStreams[0]:null;for(roomName in self.roomData)if(self.roomData.hasOwnProperty(roomName)){var mediaIds=self.getRoomApiField(roomName,otherUser,"mediaIds");if(keyToMatch=mediaIds?mediaIds[streamName]:null)break}for(keyToMatch||self.showError(self.errCodes.DEVELOPER_ERR,"remote peer does not have media stream called "+streamName),i=0;i<remoteStreams.length;i++){var remoteId;if(remoteId=remoteStreams[i].id?remoteStreams[i].id:"default",!keyToMatch||remoteId===keyToMatch)return remoteStreams[i]}return null}},pc.onicecandidate=function(event){if(!peerConns[otherUser]||!peerConns[otherUser].cancelled){var candidateData;if(event.candidate&&peerConns[otherUser]){if(candidateData={type:"candidate",label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate},iceCandidateFilter&&(candidateData=iceCandidateFilter(candidateData,!1),!candidateData))return;if(event.candidate.candidate.indexOf("typ relay")>0){var ipAddress=event.candidate.candidate.match(/(udp|tcp) \d+ (\d+\.\d+\.\d+\.\d+)/i)[2];self._turnServers[ipAddress]=!0}peerConns[otherUser].connectionAccepted?sendSignalling(otherUser,"candidate",candidateData,null,function(){failureCB(self.errCodes.PEER_GONE,"Candidate disappeared")}):peerConns[otherUser].candidatesToSend.push(candidateData)}}},pc.onaddstream=function(event){if(!peerConns[otherUser]||!peerConns[otherUser].cancelled){self.debugPrinter&&self.debugPrinter("saw incoming media stream"),peerConns[otherUser].startedAV||(peerConns[otherUser].startedAV=!0,peerConns[otherUser].sharingAudio=haveAudioVideo.audio,peerConns[otherUser].sharingVideo=haveAudioVideo.video,peerConns[otherUser].connectTime=(new Date).getTime(),peerConns[otherUser].callSuccessCB&&(peerConns[otherUser].sharingAudio||peerConns[otherUser].sharingVideo)&&peerConns[otherUser].callSuccessCB(otherUser,"audiovideo"),(self.audioEnabled||self.videoEnabled)&&updateConfiguration());var remoteName=getNameOfRemoteStream(otherUser,event.stream.id||"default");remoteName||(remoteName="default"),peerConns[otherUser].remoteStreamIdToName[event.stream.id||"default"]=remoteName,peerConns[otherUser].liveRemoteStreams[remoteName]=!0,event.stream.streamName=remoteName,self.streamAcceptor&&(self.streamAcceptor(otherUser,event.stream,remoteName),self.sendDataWS(otherUser,"easyrtc_streamReceived",{streamName:remoteName},function(){}))}},pc.onremovestream=function(event){self.debugPrinter&&self.debugPrinter("saw remove on remote media stream"),onRemoveStreamHelper(otherUser,event.stream)},peerConns[otherUser]=newPeerConn}catch(e){return self.debugPrinter&&self.debugPrinter(JSON.stringify(e)),failureCB(self.errCodes.SYSTEM_ERR,e.message),null}var i,stream;if(streamNames)for(i=0;i<streamNames.length;i++)stream=getLocalMediaStreamByName(streamNames[i]),stream?pc.addStream(stream):webrtcUtils.log("Developer error, attempt to access unknown local media stream "+streamNames[i]);else autoInitUserMedia&&(self.videoEnabled||self.audioEnabled)&&(stream=self.getLocalStream(),pc.addStream(stream));var pendingTransfer={};if(dataEnabled){if(self.setPeerListener(function(){peerConns[otherUser].dataChannelReady=!0,peerConns[otherUser].callSuccessCB&&peerConns[otherUser].callSuccessCB(otherUser,"datachannel"),onDataChannelOpen&&onDataChannelOpen(otherUser,!0),updateConfigurationInfo()},"dataChannelPrimed",otherUser),isInitiator)try{initOutGoingChannel(otherUser)}catch(channelErrorEvent){webrtcUtils.log("failed to init outgoing channel"),failureCB(self.errCodes.SYSTEM_ERR,self.formatError(channelErrorEvent))}isInitiator||initIncomingChannel(otherUser)}return pc.onconnection=function(){self.debugPrinter&&self.debugPrinter("setup pc.onconnection ")},self.setPeerListener(function(easyrtcid,msgType,msgData,targeting){newPeerConn.streamsAddedAcks[msgData.streamName]&&(newPeerConn.streamsAddedAcks[msgData.streamName](easyrtcid,msgData.streamName),delete newPeerConn.streamsAddedAcks[msgData.streamName])},"easyrtc_streamReceived",otherUser),pc}function doAnswerBody(caller,msgData,streamNames){var pc=buildPeerConnection(caller,!1,function(message){self.showError(self.errCodes.SYSTEM_ERR,message)},streamNames),newPeerConn=peerConns[caller];if(!pc)return void(self.debugPrinter&&self.debugPrinter("buildPeerConnection failed. Call not answered"));var setLocalAndSendMessage1=function(sessionDescription){if(!newPeerConn.cancelled){var sendAnswer=function(){function onSignalSuccess(){}function onSignalFailure(errorCode,errorText){delete peerConns[caller],self.showError(errorCode,errorText)}self.debugPrinter&&self.debugPrinter("sending answer"),sendSignalling(caller,"answer",sessionDescription,onSignalSuccess,onSignalFailure),peerConns[caller].connectionAccepted=!0,sendQueuedCandidates(caller,onSignalSuccess,onSignalFailure),pc.connectDataConnection&&(self.debugPrinter&&self.debugPrinter("calling connectDataConnection(5002,5001)"),pc.connectDataConnection(5002,5001))};sdpLocalFilter&&(sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)),pc.setLocalDescription(sessionDescription,sendAnswer,function(message){self.showError(self.errCodes.INTERNAL_ERR,"setLocalDescription: "+message)})}},sd=new RTCSessionDescription(msgData);if(!sd)throw"Could not create the RTCSessionDescription";self.debugPrinter&&self.debugPrinter("sdp ||  "+JSON.stringify(sd));var invokeCreateAnswer=function(){newPeerConn.cancelled||pc.createAnswer(setLocalAndSendMessage1,function(message){self.showError(self.errCodes.INTERNAL_ERR,"create-answer: "+message)},receivedMediaConstraints)};self.debugPrinter&&self.debugPrinter("about to call setRemoteDescription in doAnswer");try{sdpRemoteFilter&&(sd.sdp=sdpRemoteFilter(sd.sdp)),pc.setRemoteDescription(sd,invokeCreateAnswer,function(message){self.showError(self.errCodes.INTERNAL_ERR,"set-remote-description: "+message)})}catch(srdError){webrtcUtils.log("set remote description failed"),self.debugPrinter&&self.debugPrinter("saw exception in setRemoteDescription"),self.showError(self.errCodes.INTERNAL_ERR,"setRemoteDescription failed: "+srdError.message)}}function doAnswer(caller,msgData,streamNames){if(!streamNames&&autoInitUserMedia){var localStream=self.getLocalStream();if(!localStream&&(self.videoEnabled||self.audioEnabled))return void self.initMediaSource(function(){doAnswer(caller,msgData)},function(errorCode,error){self.showError(self.errCodes.MEDIA_ERR,self.format(self.getConstantString("localMediaError")))})}use_fresh_ice_each_peer?self.getFreshIceConfig(function(succeeded){succeeded?doAnswerBody(caller,msgData,streamNames):self.showError(self.errCodes.CALL_ERR,"Failed to get fresh ice config")}):doAnswerBody(caller,msgData,streamNames)}function callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames){acceptancePending[otherUser]=!0;var message,pc=buildPeerConnection(otherUser,!0,callFailureCB,streamNames);if(!pc)throw message="buildPeerConnection failed, call not completed",self.debugPrinter&&self.debugPrinter(message),message;peerConns[otherUser].callSuccessCB=callSuccessCB,peerConns[otherUser].callFailureCB=callFailureCB,peerConns[otherUser].wasAcceptedCB=wasAcceptedCB;var peerConnObj=peerConns[otherUser],setLocalAndSendMessage0=function(sessionDescription){if(!peerConnObj.cancelled){var sendOffer=function(){sendSignalling(otherUser,"offer",sessionDescription,null,callFailureCB)};sdpLocalFilter&&(sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)),pc.setLocalDescription(sessionDescription,sendOffer,function(errorText){callFailureCB(self.errCodes.CALL_ERR,errorText)})}};setTimeout(function(){peerConns[otherUser]&&pc.createOffer(setLocalAndSendMessage0,function(errorObj){callFailureCB(self.errCodes.CALL_ERR,JSON.stringify(errorObj))},receivedMediaConstraints)},100)}function isStreamActive(stream){var isActive;return isActive=stream.active===!0||stream.ended===!1||stream.getTracks().reduce(function(track){return track.enabled})}function clearQueuedMessages(caller){queuedMessages[caller]={candidates:[]}}function hangupBody(otherUser){var i;if(self.debugPrinter&&self.debugPrinter("Hanging up on "+otherUser),clearQueuedMessages(otherUser),peerConns[otherUser]){if(peerConns[otherUser].pc){var remoteStreams=peerConns[otherUser].pc.getRemoteStreams();for(i=0;i<remoteStreams.length;i++)isStreamActive(remoteStreams[i])&&(emitOnStreamClosed(otherUser,remoteStreams[i]),stopStream(remoteStreams[i]));try{peerConns[otherUser].pc.close()}catch(err){self.debugPrinter&&self.debugPrinter("peer close failed:"+err)}}peerConns[otherUser].cancelled=!0,delete peerConns[otherUser],self.webSocket&&sendSignalling(otherUser,"hangup",null,function(){},function(errorCode,errorText){self.debugPrinter&&self.debugPrinter("hangup failed:"+errorText)}),acceptancePending[otherUser]&&delete acceptancePending[otherUser]}}function onRemoteHangup(caller){if(delete offersPending[caller],self.debugPrinter&&self.debugPrinter("Saw onRemote hangup event"),peerConns[caller]){if(peerConns[caller].cancelled=!0,peerConns[caller].pc){var remoteStreams=peerConns[caller].pc.getRemoteStreams();if(remoteStreams){var i;for(i=0;i<remoteStreams.length;i++){emitOnStreamClosed(caller,remoteStreams[i]);try{stopStream(remoteStreams[i])}catch(err){}}}try{peerConns[caller].pc.close()}catch(anyErrors){}}else self.callCancelled&&self.callCancelled(caller,!0);delete peerConns[caller],updateConfigurationInfo()}else self.callCancelled&&self.callCancelled(caller,!0)}function isPeerInAnyRoom(id){var roomName;for(roomName in lastLoggedInList)if(lastLoggedInList.hasOwnProperty(roomName)&&lastLoggedInList[roomName][id])return!0;return!1}function processLostPeers(peersInRoom){var id;for(id in peerConns)peerConns.hasOwnProperty(id)&&"undefined"==typeof peersInRoom[id]&&(isPeerInAnyRoom(id)||((peerConns[id].pc||peerConns[id].isInitiator)&&onRemoteHangup(id),delete offersPending[id],delete acceptancePending[id],clearQueuedMessages(id)));for(id in offersPending)offersPending.hasOwnProperty(id)&&!isPeerInAnyRoom(id)&&(onRemoteHangup(id),clearQueuedMessages(id),delete offersPending[id],delete acceptancePending[id]);for(id in acceptancePending)acceptancePending.hasOwnProperty(id)&&!isPeerInAnyRoom(id)&&(onRemoteHangup(id),clearQueuedMessages(id),delete acceptancePending[id])}function addAggregatingTimer(key,callback,period){period||(period=100);var counter=0;aggregatingTimers[key]&&(clearTimeout(aggregatingTimers[key].timer),counter=aggregatingTimers[key].counter),counter>20?(delete aggregatingTimers[key],callback()):(aggregatingTimers[key]={counter:counter+1},aggregatingTimers[key].timer=setTimeout(function(){delete aggregatingTimers[key],callback()},period))}function processOccupantList(roomName,occupantList){var id,myInfo=null,reducedList={};for(id in occupantList)occupantList.hasOwnProperty(id)&&(id===self.myEasyrtcid?myInfo=occupantList[id]:reducedList[id]=occupantList[id]);processLostPeers(reducedList),addAggregatingTimer("roomOccupants&"+roomName,function(){roomOccupantListener&&roomOccupantListener(roomName,reducedList,myInfo),self.emitEvent("roomOccupants",{roomName:roomName,occupants:lastLoggedInList})},100)}function onChannelMsg(msg,ackAcceptorFunc){var targeting={};ackAcceptorFunc&&ackAcceptorFunc(self.ackMessage),msg.targetEasyrtcid&&(targeting.targetEasyrtcid=msg.targetEasyrtcid),msg.targetRoom&&(targeting.targetRoom=msg.targetRoom),msg.targetGroup&&(targeting.targetGroup=msg.targetGroup),msg.senderEasyrtcid?self.receivePeerDistribute(msg.senderEasyrtcid,msg,targeting):receiveServerCB?receiveServerCB(msg.msgType,msg.msgData,targeting):webrtcUtils.log("Unhandled server message "+JSON.stringify(msg))}function processUrl(url){var ipAddress;0!==url.indexOf("turn:")&&0!==url.indexOf("turns:")||(ipAddress=url.split(/[@:&]/g)[1],self._turnServers[ipAddress]=!0)}function processIceConfig(iceConfig){var i,j,item;for(pc_config={iceServers:[]},self._turnServers={},iceConfig&&iceConfig.iceServers&&"undefined"!=typeof iceConfig.iceServers.length?pc_config={iceServers:iceConfig.iceServers}:self.showError(self.errCodes.DEVELOPER_ERR,"iceConfig received from server didn't have an array called iceServers, ignoring it"),i=0;i<iceConfig.iceServers.length;i++)if(item=iceConfig.iceServers[i],item.urls&&item.urls.length)for(j=0;j<item.urls.length;j++)processUrl(item.urls[j]);else item.url&&processUrl(item.url)}function processSessionData(sessionData){sessionData&&(sessionData.easyrtcsid&&(self.easyrtcsid=sessionData.easyrtcsid),sessionData.field&&(sessionFields=sessionData.field))}function processRoomData(roomData){self.roomData=roomData;var k,roomName,stuffToRemove,stuffToAdd,id,removeId;for(roomName in self.roomData)if(self.roomData.hasOwnProperty(roomName)){if("join"===roomData[roomName].roomStatus){self.roomJoin[roomName]||(self.roomJoin[roomName]=roomData[roomName]);var mediaIds=buildMediaIds();mediaIds!=={}&&self.setRoomApiField(roomName,"mediaIds",mediaIds)}else if("leave"===roomData[roomName].roomStatus){self.roomEntryListener&&self.roomEntryListener(!1,roomName),delete self.roomJoin[roomName],delete lastLoggedInList[roomName];continue}if(roomData[roomName].clientList)lastLoggedInList[roomName]=roomData[roomName].clientList;else if(roomData[roomName].clientListDelta){if(stuffToAdd=roomData[roomName].clientListDelta.updateClient)for(id in stuffToAdd)if(stuffToAdd.hasOwnProperty(id)){lastLoggedInList[roomName]||(lastLoggedInList[roomName]=[]),lastLoggedInList[roomName][id]||(lastLoggedInList[roomName][id]=stuffToAdd[id]);for(k in stuffToAdd[id])"apiField"!==k&&"presence"!==k||(lastLoggedInList[roomName][id][k]=stuffToAdd[id][k])}if(stuffToRemove=roomData[roomName].clientListDelta.removeClient,stuffToRemove&&lastLoggedInList[roomName])for(removeId in stuffToRemove)stuffToRemove.hasOwnProperty(removeId)&&delete lastLoggedInList[roomName][removeId]}self.roomJoin[roomName]&&roomData[roomName].field&&(fields.rooms[roomName]=roomData[roomName].field),"join"===roomData[roomName].roomStatus&&self.roomEntryListener&&self.roomEntryListener(!0,roomName),processOccupantList(roomName,lastLoggedInList[roomName])}self.emitEvent("roomOccupant",lastLoggedInList)}function onChannelCmd(msg,ackAcceptorFn){function processReject(caller){delete acceptancePending[caller],queuedMessages[caller]&&delete queuedMessages[caller],peerConns[caller]&&(peerConns[caller].wasAcceptedCB&&peerConns[caller].wasAcceptedCB(!1,caller),delete peerConns[caller])}function processAnswer(caller,msgData){if(delete acceptancePending[caller],peerConns[caller]){peerConns[caller].connectionAccepted=!0,peerConns[caller].wasAcceptedCB&&peerConns[caller].wasAcceptedCB(!0,caller);var onSignalSuccess=function(){},onSignalFailure=function(errorCode,errorText){peerConns[caller]&&delete peerConns[caller],self.showError(errorCode,errorText)};sendQueuedCandidates(caller,onSignalSuccess,onSignalFailure),pc=peerConns[caller].pc;var sd=new RTCSessionDescription(msgData);if(!sd)throw"Could not create the RTCSessionDescription";self.debugPrinter&&self.debugPrinter("about to call initiating setRemoteDescription");
try{sdpRemoteFilter&&(sd.sdp=sdpRemoteFilter(sd.sdp)),pc.setRemoteDescription(sd,function(){pc.connectDataConnection&&(self.debugPrinter&&self.debugPrinter("calling connectDataConnection(5001,5002)"),pc.connectDataConnection(5001,5002))},function(message){webrtcUtils.log("setRemoteDescription failed ",message)})}catch(smdException){webrtcUtils.log("setRemoteDescription failed ",smdException)}flushCachedCandidates(caller)}}function processCandidateQueue(caller,msgData){peerConns[caller]&&peerConns[caller].pc?processCandidateBody(caller,msgData):(peerConns[caller]||(queuedMessages[caller]={candidates:[]}),queuedMessages[caller].candidates.push(msgData))}var pc,caller=msg.senderEasyrtcid,msgType=msg.msgType,msgData=msg.msgData;self.debugPrinter&&self.debugPrinter("received message of type "+msgType),"undefined"==typeof queuedMessages[caller]&&clearQueuedMessages(caller);var processCandidateBody=function(caller,msgData){function iceAddSuccess(){}function iceAddFailure(domError){self.showError(self.errCodes.ICECANDIDATE_ERR,"bad ice candidate ("+domError.name+"): "+JSON.stringify(candidate))}var candidate=null;if((!iceCandidateFilter||(msgData=iceCandidateFilter(msgData,!0)))&&(candidate=new RTCIceCandidate({sdpMLineIndex:msgData.label,candidate:msgData.candidate}),pc=peerConns[caller].pc,pc.addIceCandidate(candidate,iceAddSuccess,iceAddFailure),msgData.candidate.indexOf("typ relay")>0)){var ipAddress=msgData.candidate.match(/(udp|tcp) \d+ (\d+\.\d+\.\d+\.\d+)/i)[2];self._turnServers[ipAddress]=!0}},flushCachedCandidates=function(caller){var i;if(queuedMessages[caller]){for(i=0;i<queuedMessages[caller].candidates.length;i++)processCandidateBody(caller,queuedMessages[caller].candidates[i]);delete queuedMessages[caller]}},processOffer=function(caller,msgData){var helper=function(wasAccepted,streamNames){if(streamNames)if("string"==typeof streamNames)streamNames=[streamNames];else if(void 0===streamNames.length)return void self.showError(self.errCodes.DEVELOPER_ERR,"accept callback passed invalid streamNames");if(self.debugPrinter&&self.debugPrinter("offer accept="+wasAccepted),delete offersPending[caller],wasAccepted){if(!self.supportsPeerConnections())return void self.showError(self.errCodes.CALL_ERR,self.getConstantString("noWebrtcSupport"));doAnswer(caller,msgData,streamNames),flushCachedCandidates(caller)}else sendSignalling(caller,"reject",null,null,null),clearQueuedMessages(caller)};return acceptancePending[caller]&&caller<self.myEasyrtcid?(delete acceptancePending[caller],queuedMessages[caller]&&delete queuedMessages[caller],peerConns[caller].wasAcceptedCB&&peerConns[caller].wasAcceptedCB(!0,caller),delete peerConns[caller],void helper(!0)):(offersPending[caller]=msgData,void(self.acceptCheck?self.acceptCheck(caller,helper):helper(!0)))};switch(msgType){case"sessionData":processSessionData(msgData.sessionData);break;case"roomData":processRoomData(msgData.roomData);break;case"iceConfig":processIceConfig(msgData.iceConfig);break;case"forwardToUrl":msgData.newWindow?window.open(msgData.forwardToUrl.url):window.location.href=msgData.forwardToUrl.url;break;case"offer":processOffer(caller,msgData);break;case"reject":processReject(caller);break;case"answer":processAnswer(caller,msgData);break;case"candidate":processCandidateQueue(caller,msgData);break;case"hangup":onRemoteHangup(caller),clearQueuedMessages(caller);break;case"error":self.showError(msgData.errorCode,msgData.errorText);break;default:return void self.showError(self.errCodes.DEVELOPER_ERR,"received unknown message type from server, msgType is "+msgType)}ackAcceptorFn&&ackAcceptorFn(self.ackMessage)}function processToken(msg){var msgData=msg.msgData;self.debugPrinter&&self.debugPrinter("entered process token"),msgData.easyrtcid&&(self.myEasyrtcid=msgData.easyrtcid),msgData.field&&(fields.connection=msgData.field),msgData.iceConfig&&processIceConfig(msgData.iceConfig),msgData.sessionData&&processSessionData(msgData.sessionData),msgData.roomData&&processRoomData(msgData.roomData),msgData.application.field&&(fields.application=msgData.application.field)}function sendAuthenticate(successCallback,errorCallback){var cookies,target,i,easyrtcsid=null;if(self.cookieId&&document.cookie)for(cookies=document.cookie.split(/[; ]/g),target=self.cookieId+"=",i=0;i<cookies.length;i++)0===cookies[i].indexOf(target)&&(easyrtcsid=cookies[i].substring(target.length));var msgData={apiVersion:self.apiVersion,applicationName:self.applicationName,setUserCfg:collectConfigurationInfo(!0)};self.roomJoin||(self.roomJoin={}),self.presenceShow&&(msgData.setPresence={show:self.presenceShow,status:self.presenceStatus}),self.username&&(msgData.username=self.username),self.roomJoin&&!isEmptyObj(self.roomJoin)&&(msgData.roomJoin=self.roomJoin),easyrtcsid&&(msgData.easyrtcsid=easyrtcsid),credential&&(msgData.credential=credential),self.webSocket.json.emit("easyrtcAuth",{msgType:"authenticate",msgData:msgData},function(msg){var room;if("error"===msg.msgType)errorCallback(msg.msgData.errorCode,msg.msgData.errorText),self.roomJoin={};else{if(processToken(msg),self._roomApiFields)for(room in self._roomApiFields)self._roomApiFields.hasOwnProperty(room)&&enqueueSendRoomApi(room);successCallback&&successCallback(self.myEasyrtcid)}})}function connectToWSServer(successCallback,errorCallback){function addSocketListener(event,handler){self.webSocket.on(event,handler),self.websocketListeners.push({event:event,handler:handler})}function connectHandler(event){self.webSocketConnected=!0,self.webSocket||self.showError(self.errCodes.CONNECT_ERR,self.getConstantString("badsocket")),self.debugPrinter&&self.debugPrinter("saw socket-server onconnect event"),self.webSocketConnected?sendAuthenticate(successCallback,errorCallback):errorCallback(self.errCodes.SIGNAL_ERR,self.getConstantString("icf"))}var i;if(preallocatedSocketIo)self.webSocket=preallocatedSocketIo;else if(self.webSocket)for(i in self.websocketListeners)self.websocketListeners.hasOwnProperty(i)&&self.webSocket.removeEventListener(self.websocketListeners[i].event,self.websocketListeners[i].handler);else try{if(self.webSocket=io.connect(serverPath,connectionOptions),!self.webSocket)throw"io.connect failed"}catch(socketErr){return self.webSocket=0,void errorCallback(self.errCodes.SYSTEM_ERROR,socketErr.toString())}self.websocketListeners=[],addSocketListener("close",function(event){webrtcUtils.log("the web socket closed")}),addSocketListener("error",function(event){function handleErrorEvent(){self.myEasyrtcid&&isSocketConnected(self.webSocket)?self.showError(self.errCodes.SIGNAL_ERR,self.getConstantString("miscSignalError")):errorCallback(self.errCodes.CONNECT_ERR,self.getConstantString("noServer"))}handleErrorEvent()}),isSocketConnected(preallocatedSocketIo)?connectHandler(null):addSocketListener("connect",connectHandler),addSocketListener("easyrtcMsg",onChannelMsg),addSocketListener("easyrtcCmd",onChannelCmd),addSocketListener("disconnect",function(){self.webSocketConnected=!1,updateConfigurationInfo=function(){},oldConfig={},disconnectBody(),self.disconnectListener&&self.disconnectListener()})}var self=this,autoInitUserMedia=!0,sdpLocalFilter=null,sdpRemoteFilter=null,iceCandidateFilter=null,iceConnectionStateChangeListener=null,connectionOptions={"connect timeout":1e4,"force new connection":!0};this.setSdpFilters=function(localFilter,remoteFilter){sdpLocalFilter=localFilter,sdpRemoteFilter=remoteFilter},this.setPeerClosedListener=function(handler){this.onPeerClosed=handler},this.setPeerFailingListener=function(failingHandler,recoveredHandler){this.onPeerFailing=failingHandler,this.onPeerRecovered=recoveredHandler},this.setIceCandidateFilter=function(filter){iceCandidateFilter=filter},this.setIceConnectionStateChangeListener=function(listener){iceConnectionStateChangeListener=listener},this.setAutoInitUserMedia=function(flag){autoInitUserMedia=!!flag},this.format=function(format,arg1,arg2,arg3){for(var formatted=arguments[0],i=1;i<arguments.length;i++){var regexp=new RegExp("\\{"+(i-1)+"\\}","gi");formatted=formatted.replace(regexp,arguments[i])}return formatted};var haveAudioVideo={audio:!1,video:!1};this.getConstantString=function(key){return easyrtc_constantStrings[key]?easyrtc_constantStrings[key]:(self.showError(self.errCodes.DEVELOPER_ERR,"Could not find key='"+key+"' in easyrtc_constantStrings"),key)};var allowedEvents={roomOccupant:!0,roomOccupants:!0},eventListeners={};this.addEventListener=function(eventName,eventListener){if(event(eventName,"addEventListener"),"function"!=typeof eventListener)throw self.showError(self.errCodes.DEVELOPER_ERR,"addEventListener called with a non-function for second argument"),"developer error";self.removeEventListener(eventName,eventListener),eventListeners[eventName]||(eventListeners[eventName]=[]),eventListeners[eventName][eventListeners[eventName].length]=eventListener},this.removeEventListener=function(eventName,eventListener){event(eventName,"removeEventListener");var listeners=eventListeners[eventName],i=0;if(listeners)for(i=0;i<listeners.length;i++)listeners[i]===eventListener&&(i<listeners.length-1&&(listeners[i]=listeners[listeners.length-1]),listeners.length=listeners.length-1)},this.emitEvent=function(eventName,eventData){event(eventName,"emitEvent");var listeners=eventListeners[eventName],i=0;if(listeners)for(i=0;i<listeners.length;i++)listeners[i](eventName,eventData)},this.errCodes={BAD_NAME:"BAD_NAME",CALL_ERR:"CALL_ERR",DEVELOPER_ERR:"DEVELOPER_ERR",SYSTEM_ERR:"SYSTEM_ERR",CONNECT_ERR:"CONNECT_ERR",MEDIA_ERR:"MEDIA_ERR",MEDIA_WARNING:"MEDIA_WARNING",INTERNAL_ERR:"INTERNAL_ERR",PEER_GONE:"PEER_GONE",ALREADY_CONNECTED:"ALREADY_CONNECTED",BAD_CREDENTIAL:"BAD_CREDENTIAL",ICECANDIDATE_ERR:"ICECANDIDATE_ERR",NOVIABLEICE:"NOVIABLEICE",SIGNAL_ERR:"SIGNAL_ERR"},this.apiVersion="1.0.17",this.ackMessage={msgType:"ack"},this.usernameRegExp=/^(.){1,64}$/,this.cookieId="easyrtcsid";this.loggingOut=!1,this.disconnecting=!1;var namedLocalMediaStreams={},sessionFields=[],receivedMediaConstraints={};this.enableAudioReceive=function(value){"firefox"===webrtcDetectedBrowser?receivedMediaConstraints.offerToReceiveAudio=value:(receivedMediaConstraints.mandatory=receivedMediaConstraints.mandatory||{},receivedMediaConstraints.mandatory.OfferToReceiveAudio=value)},this.enableVideoReceive=function(value){"firefox"===webrtcDetectedBrowser?receivedMediaConstraints.offerToReceiveVideo=value:(receivedMediaConstraints.mandatory=receivedMediaConstraints.mandatory||{},receivedMediaConstraints.mandatory.OfferToReceiveVideo=value)},this.enableAudioReceive(!0),this.enableVideoReceive(!0),this.getAudioSourceList=function(callback){getSourceList(callback,"audioinput")},this.getVideoSourceList=function(callback){getSourceList(callback,"videoinput")},self.audioEnabled=!0,self.videoEnabled=!0;var dataChannelName="dc";this.debugPrinter=null,this.myEasyrtcid="";var oldConfig={},offersPending={};this.nativeVideoHeight=0,this.maxP2PMessageLength=1e3,this.nativeVideoWidth=0;var credential=null;this.roomJoin={},this.isNameValid=function(name){return self.usernameRegExp.test(name)},this.setCookieId=function(cookieId){self.cookieId=cookieId},this._desiredVideoProperties={},this.setVideoSource=function(videoSrcId){self._desiredVideoProperties.videoSrcId=videoSrcId,delete self._desiredVideoProperties.screenCapture},this._desiredAudioProperties={},this.setAudioSource=function(audioSrcId){self._desiredAudioProperties.audioSrcId=audioSrcId},this.setVideoDims=function(width,height,frameRate){self._desiredVideoProperties.width=width,self._desiredVideoProperties.height=height,void 0!==frameRate&&(self._desiredVideoProperties.frameRate=frameRate)},this.setScreenCapture=function(enableScreenCapture){self._desiredVideoProperties.screenCapture=enableScreenCapture!==!1},self.getUserMediaConstraints=function(){var constraints={};return self._presetMediaConstraints?(constraints=self._presetMediaConstraints,delete self._presetMediaConstraints,constraints):self._desiredVideoProperties.screenCapture?{video:{mandatory:{chromeMediaSource:"screen",maxWidth:screen.width,maxHeight:screen.height,minWidth:screen.width,minHeight:screen.height,minFrameRate:1,maxFrameRate:5},optional:[]},audio:!1}:(self.videoEnabled?"firefox"===webrtcDetectedBrowser?(constraints.video={},self._desiredVideoProperties.width&&(constraints.video.width=self._desiredVideoProperties.width),self._desiredVideoProperties.height&&(constraints.video.height=self._desiredVideoProperties.height),self._desiredVideoProperties.frameRate&&(constraints.video.frameRate={max:self._desiredVideoProperties.frameRate}),self._desiredVideoProperties.videoSrcId&&(constraints.video.deviceId=self._desiredVideoProperties.videoSrcId)):(constraints.video={mandatory:{},optional:[]},self._desiredVideoProperties.width&&(constraints.video.mandatory.maxWidth=self._desiredVideoProperties.width,constraints.video.mandatory.minWidth=self._desiredVideoProperties.width),self._desiredVideoProperties.height&&(constraints.video.mandatory.maxHeight=self._desiredVideoProperties.height,constraints.video.mandatory.minHeight=self._desiredVideoProperties.height),self._desiredVideoProperties.frameRate&&(constraints.video.mandatory.maxFrameRate=self._desiredVideoProperties.frameRate),self._desiredVideoProperties.videoSrcId&&(constraints.video.optional=constraints.video.optional||[],constraints.video.optional.push({sourceId:self._desiredVideoProperties.videoSrcId})),0===constraints.video.mandatory.length&&0===constraints.video.optional.length&&(constraints.video=!0)):constraints.video=!1,self.audioEnabled?"firefox"===webrtcDetectedBrowser?(constraints.audio={},self._desiredAudioProperties.audioSrcId&&(constraints.audio.deviceId=self._desiredAudioProperties.audioSrcId)):(constraints.audio={mandatory:{},optional:[]},self._desiredAudioProperties.audioSrcId&&(constraints.audio.optional=constraints.audio.optional||[],constraints.audio.optional.push({sourceId:self._desiredAudioProperties.audioSrcId}))):constraints.audio=!1,constraints)},this.setApplicationName=function(name){self.applicationName=name},this.enableDebug=function(enable){enable?self.debugPrinter=function(message){var stackString=(new Error).stack,srcLine="location unknown";if(stackString){var stackFrameStrings=stackString.split("\n");srcLine="",stackFrameStrings.length>=3&&(srcLine=stackFrameStrings[2])}webrtcUtils.log("debug "+(new Date).toISOString()+" : "+message+" ["+srcLine+"]")}:self.debugPrinter=null},this.supportsGetUserMedia=function(){return!!getUserMedia},this.supportsPeerConnections=function(){return!!self.supportsGetUserMedia()&&!!window.RTCPeerConnection},this.createRTCPeerConnection=function(pc_config,optionalStuff){if(RTCPeerConnection)return new RTCPeerConnection(pc_config,optionalStuff);throw"Your browser doesn't support webRTC (RTCPeerConnection)"},this.getDatachannelConstraints=function(){return"chrome"===webrtcDetectedBrowser&&webrtcDetectedVersion<31?{reliable:!1}:{reliable:!0}},haveAudioVideo={audio:!1,video:!1};var dataEnabled=!1,serverPath=null,roomOccupantListener=null,onDataChannelOpen=null,onDataChannelClose=null,lastLoggedInList={},receivePeer={msgTypes:{}},receiveServerCB=null,updateConfigurationInfo=function(){},peerConns={},acceptancePending={};this.acceptCheck=function(caller,helper){helper(!0)},this.streamAcceptor=function(easyrtcid,stream){},this.onStreamClosed=function(easyrtcid){},this.callCancelled=function(easyrtcid){},this.getPeerConnectionByUserId=function(userId){return peerConns&&peerConns[userId]?peerConns[userId].pc:null};this.getPeerStatistics=function(easyrtcid,callback,filter){"firefox"===webrtcDetectedBrowser?self.getFirefoxPeerStatistics(easyrtcid,callback,filter):self.getChromePeerStatistics(easyrtcid,callback,filter)};var roomApiFieldTimer=null;this.setRoomApiField=function(roomName,fieldName,fieldValue){if(self._roomApiFields||(self._roomApiFields={}),!fieldName&&!fieldValue)return void delete self._roomApiFields[roomName];if(self._roomApiFields[roomName]||(self._roomApiFields[roomName]={}),void 0!==fieldValue&&null!==fieldValue){if("object"==typeof fieldValue)try{JSON.stringify(fieldValue)}catch(jsonError){return void self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.setRoomApiField passed bad object ")}self._roomApiFields[roomName][fieldName]={fieldName:fieldName,fieldValue:fieldValue}}else delete self._roomApiFields[roomName][fieldName];self.webSocketConnected&&enqueueSendRoomApi(roomName)},this.showError=function(messageCode,message){self.onError({errorCode:messageCode,errorText:message})},this.onError=function(errorObject){self.debugPrinter&&self.debugPrinter("saw error "+errorObject.errorText);var errorBody,errorDiv=document.getElementById("easyrtcErrorDialog");if(!errorDiv){errorDiv=document.createElement("div"),errorDiv.id="easyrtcErrorDialog";var title=document.createElement("div");title.innerHTML="Error messages",title.className="easyrtcErrorDialog_title",errorDiv.appendChild(title),errorBody=document.createElement("div"),errorBody.id="easyrtcErrorDialog_body",errorDiv.appendChild(errorBody);var clearButton=document.createElement("button");clearButton.appendChild(document.createTextNode("Okay")),clearButton.className="easyrtcErrorDialog_okayButton",clearButton.onclick=function(){errorBody.innerHTML="",errorDiv.style.display="none"},errorDiv.appendChild(clearButton),document.body.appendChild(errorDiv)}errorBody=document.getElementById("easyrtcErrorDialog_body");var messageNode=document.createElement("div");messageNode.className="easyrtcErrorDialog_element",messageNode.appendChild(document.createTextNode(errorObject.errorText)),errorBody.appendChild(messageNode),errorDiv.style.display="block"},this.createObjectURL=function(mediaStream){var errMessage;if(window.URL&&window.URL.createObjectURL)return window.URL.createObjectURL(mediaStream);if(window.webkitURL&&window.webkitURL.createObjectURL)return window.webkit.createObjectURL(mediaStream);throw errMessage="Your browsers does not support URL.createObjectURL.",self.debugPrinter&&self.debugPrinter("saw exception "+errMessage),errMessage},this.cleanId=function(idString){var MAP={"&":"&amp;","<":"&lt;",">":"&gt;"};return idString.replace(/[&<>]/g,function(c){return MAP[c]})},self.setRoomEntryListener=function(handler){self.roomEntryListener=handler},self.setRoomOccupantListener=function(listener){roomOccupantListener=listener},this.setDataChannelOpenListener=function(listener){onDataChannelOpen=listener},this.setDataChannelCloseListener=function(listener){onDataChannelClose=listener},this.getConnectionCount=function(){var i,count=0;for(i in peerConns)peerConns.hasOwnProperty(i)&&self.getConnectStatus(i)===self.IS_CONNECTED&&count++;return count},this.setMaxP2PMessageLength=function(maxLength){this.maxP2PMessageLength=maxLength},this.enableAudio=function(enabled){self.audioEnabled=enabled},this.enableVideo=function(enabled){self.videoEnabled=enabled},this.enableDataChannels=function(enabled){dataEnabled=enabled},this.getLocalMediaIds=function(){return Object.keys(namedLocalMediaStreams)},this.register3rdPartyLocalMediaStream=function(stream,streamName){return registerLocalMediaStreamByName(stream,streamName)},this.getNameOfRemoteStream=function(easyrtcId,webrtcStream){return"string"==typeof webrtcStream?getNameOfRemoteStream(easyrtcId,webrtcStream):webrtcStream.id?getNameOfRemoteStream(easyrtcId,webrtcStream.id):void 0},this.closeLocalMediaStream=function(streamName){return closeLocalMediaStreamByName(streamName)},this.closeLocalStream=this.closeLocalMediaStream,this.enableCamera=function(enable,streamName){var stream=getLocalMediaStreamByName(streamName);stream&&stream.getVideoTracks&&enableMediaTracks(enable,stream.getVideoTracks())},this.enableMicrophone=function(enable,streamName){var stream=getLocalMediaStreamByName(streamName);stream&&stream.getAudioTracks&&enableMediaTracks(enable,stream.getAudioTracks())},this.muteVideoObject=function(videoObjectName,mute){var videoObject;if("string"==typeof videoObjectName){if(videoObject=document.getElementById(videoObjectName),!videoObject)throw"Unknown video object "+videoObjectName}else{if(!videoObjectName)throw"muteVideoObject passed a null";videoObject=videoObjectName}videoObject.muted=!!mute},self.getLocalStreamAsUrl=function(streamName){var stream=getLocalMediaStreamByName(streamName);if(null===stream)throw"Developer error: attempt to get a MediaStream without invoking easyrtc.initMediaSource successfully";return self.createObjectURL(stream)},this.getLocalStream=function(streamName){return getLocalMediaStreamByName(streamName)||null},this.clearMediaStream=function(element){"undefined"!=typeof element.src?element.src="":"undefined"!=typeof element.srcObject?element.srcObject="":"undefined"!=typeof element.mozSrcObject&&(element.mozSrcObject=null)},this.setVideoObjectSrc=function(videoObject,stream){stream&&""!==stream?(videoObject.autoplay=!0,attachMediaStream(videoObject,stream),videoObject.play()):self.clearMediaStream(videoObject)},this.buildLocalMediaStream=function(streamName,audioTracks,videoTracks){var i;if("string"!=typeof streamName)return self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.buildLocalMediaStream not supplied a stream name"),null;var streamToClone=null;for(var key in namedLocalMediaStreams)if(namedLocalMediaStreams.hasOwnProperty(key)&&(streamToClone=namedLocalMediaStreams[key]))break;if(!streamToClone)for(key in peerConns)if(peerConns.hasOwnProperty(key)){var remoteStreams=peerConns[key].pc.getRemoteStreams();remoteStreams&&remoteStreams.length>0&&(streamToClone=remoteStreams[0])}if(!streamToClone)return self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to create a mediastream without one to clone from"),null;var mediaClone=streamToClone.clone(),oldTracks=mediaClone.getTracks();if(audioTracks)for(i=0;i<audioTracks.length;i++)mediaClone.addTrack(audioTracks[i].clone());if(videoTracks)for(i=0;i<videoTracks.length;i++)mediaClone.addTrack(videoTracks[i].clone());for(i=0;i<oldTracks.length;i++)mediaClone.removeTrack(oldTracks[i]);return registerLocalMediaStreamByName(mediaClone,streamName),mediaClone},this.loadStylesheet=function(){var cssIndex,css,links=document.getElementsByTagName("link");for(cssIndex in links)if(links.hasOwnProperty(cssIndex)&&(css=links[cssIndex],css.href&&css.href.match(/\/easyrtc.css/)))return;var easySheet=document.createElement("link");easySheet.setAttribute("rel","stylesheet"),easySheet.setAttribute("type","text/css"),easySheet.setAttribute("href","/easyrtc/easyrtc.css");var headSection=document.getElementsByTagName("head")[0],firstHead=headSection.childNodes[0];headSection.insertBefore(easySheet,firstHead)},this.formatError=function(x){var name,result;if(null===x||"undefined"==typeof x)return"null";if("string"==typeof x)return x;if(x.type&&x.description)return x.type+" : "+x.description;if("object"!=typeof x)return"Strange case";try{return JSON.stringify(x)}catch(oops){result="{";for(name in x)x.hasOwnProperty(name)&&"string"==typeof x[name]&&(result=result+name+"='"+x[name]+"' ");return result+="}"}},this.initMediaSource=function(successCallback,errorCallback,streamName){function getCurrentTime(){return(new Date).getTime()}function tryAgain(error){var currentTime=getCurrentTime();currentTime<firstCallTime+1e3?(webrtcUtils.log("Trying getUserMedia a second time"),setTimeout(function(){getUserMedia(mode,onUserMediaSuccess,onUserMediaError)},3e3)):onUserMediaError(error)}if(self.debugPrinter&&self.debugPrinter("about to request local media"),streamName||(streamName="default"),haveAudioVideo={audio:self.audioEnabled,video:self.videoEnabled},errorCallback||(errorCallback=function(errorCode,errorText){var message="easyrtc.initMediaSource: "+self.formatError(errorText);self.debugPrinter&&self.debugPrinter(message),self.showError(self.errCodes.MEDIA_ERR,message)}),!self.supportsGetUserMedia())return void errorCallback(self.errCodes.MEDIA_ERR,self.getConstantString("noWebrtcSupport"));if(!successCallback)return void self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.initMediaSource not supplied a successCallback");var mode=self.getUserMediaConstraints(),onUserMediaSuccess=function(stream){self.debugPrinter&&self.debugPrinter("getUserMedia success callback entered"),self.debugPrinter&&self.debugPrinter("successfully got local media"),stream.streamName=streamName,registerLocalMediaStreamByName(stream,streamName);var videoObj,triesLeft,tryToGetSize,ele;haveAudioVideo.video?(videoObj=document.createElement("video"),videoObj.muted=!0,triesLeft=30,tryToGetSize=function(){videoObj.videoWidth>0||triesLeft<0?(self.nativeVideoWidth=videoObj.videoWidth,self.nativeVideoHeight=videoObj.videoHeight,!self._desiredVideoProperties.height||self.nativeVideoHeight===self._desiredVideoProperties.height&&self.nativeVideoWidth===self._desiredVideoProperties.width||self.showError(self.errCodes.MEDIA_WARNING,self.format(self.getConstantString("resolutionWarning"),self._desiredVideoProperties.width,self._desiredVideoProperties.height,self.nativeVideoWidth,self.nativeVideoHeight)),self.setVideoObjectSrc(videoObj,null),videoObj.removeNode?videoObj.removeNode(!0):(ele=document.createElement("div"),ele.appendChild(videoObj),ele.removeChild(videoObj)),updateConfigurationInfo(),successCallback&&successCallback(stream)):(triesLeft-=1,setTimeout(tryToGetSize,300))},self.setVideoObjectSrc(videoObj,stream),tryToGetSize()):(updateConfigurationInfo(),successCallback&&successCallback(stream))},onUserMediaError=function(error){webrtcUtils.log("getusermedia failed"),self.debugPrinter&&self.debugPrinter("failed to get local media");var errText;errText="string"==typeof error?error:error.name?error.name:"Unknown",errorCallback&&(webrtcUtils.log("invoking error callback",errText),errorCallback(self.errCodes.MEDIA_ERR,self.format(self.getConstantString("gumFailed"),errText))),closeLocalMediaStreamByName(streamName),haveAudioVideo={audio:!1,video:!1},updateConfigurationInfo()};if(!self.audioEnabled&&!self.videoEnabled)return void onUserMediaError(self.getConstantString("requireAudioOrVideo"));var firstCallTime;setTimeout(function(){try{firstCallTime=getCurrentTime(),getUserMedia(mode,onUserMediaSuccess,tryAgain)}catch(e){tryAgain(e)}},1e3)},this.setAcceptChecker=function(acceptCheck){self.acceptCheck=acceptCheck},this.setStreamAcceptor=function(acceptor){self.streamAcceptor=acceptor},self.setOnError=function(errListener){self.onError=errListener},this.setCallCancelled=function(callCancelled){self.callCancelled=callCancelled},this.setOnStreamClosed=function(onStreamClosed){self.onStreamClosed=onStreamClosed},this.supportsDataChannels=function(){return navigator.userAgent.match(/android/i)?webrtcDetectedVersion>=34:"firefox"===webrtcDetectedBrowser||webrtcDetectedVersion>=32},this.setPeerListener=function(listener,msgType,source){msgType?(receivePeer.msgTypes[msgType]||(receivePeer.msgTypes[msgType]={sources:{}}),source?receivePeer.msgTypes[msgType].sources[source]={cb:listener}:receivePeer.msgTypes[msgType].cb=listener):receivePeer.cb=listener},this.receivePeerDistribute=function(easyrtcid,msg,targeting){var msgType=msg.msgType,msgData=msg.msgData;if(!msgType)return void webrtcUtils.log("received peer message without msgType",msg);if(receivePeer.msgTypes[msgType]){if(receivePeer.msgTypes[msgType].sources[easyrtcid]&&receivePeer.msgTypes[msgType].sources[easyrtcid].cb)return void receivePeer.msgTypes[msgType].sources[easyrtcid].cb(easyrtcid,msgType,msgData,targeting);if(receivePeer.msgTypes[msgType].cb)return void receivePeer.msgTypes[msgType].cb(easyrtcid,msgType,msgData,targeting)}receivePeer.cb&&receivePeer.cb(easyrtcid,msgType,msgData,targeting)},this.setServerListener=function(listener){receiveServerCB=listener},this.setSocketUrl=function(socketUrl,options){self.debugPrinter&&self.debugPrinter("WebRTC signaling server URL set to "+socketUrl),serverPath=socketUrl,options&&(connectionOptions=options)},this.setUsername=function(username){return self.myEasyrtcid?(self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.setUsername called after authentication"),!1):self.isNameValid(username)?(self.username=username,!0):(self.showError(self.errCodes.BAD_NAME,self.format(self.getConstantString("badUserName"),username)),!1)},this.usernameToIds=function(username,room){var id,roomName,results=[];for(roomName in lastLoggedInList)if(lastLoggedInList.hasOwnProperty(roomName)&&(!room||roomName===room))for(id in lastLoggedInList[roomName])lastLoggedInList[roomName].hasOwnProperty(id)&&lastLoggedInList[roomName][id].username===username&&results.push({easyrtcid:id,roomName:roomName});return results},this.getRoomApiField=function(roomName,easyrtcid,fieldName){return lastLoggedInList[roomName]&&lastLoggedInList[roomName][easyrtcid]&&lastLoggedInList[roomName][easyrtcid].apiField&&lastLoggedInList[roomName][easyrtcid].apiField[fieldName]?lastLoggedInList[roomName][easyrtcid].apiField[fieldName].fieldValue:void 0},this.setCredential=function(credentialParm){try{return JSON.stringify(credentialParm),credential=credentialParm,!0}catch(oops){throw self.showError(self.errCodes.BAD_CREDENTIAL,"easyrtc.setCredential passed a non-JSON-able object"),"easyrtc.setCredential passed a non-JSON-able object"}},this.setDisconnectListener=function(disconnectListener){self.disconnectListener=disconnectListener},this.idToName=function(easyrtcid){var roomName;for(roomName in lastLoggedInList)if(lastLoggedInList.hasOwnProperty(roomName)&&lastLoggedInList[roomName][easyrtcid]&&lastLoggedInList[roomName][easyrtcid].username)return lastLoggedInList[roomName][easyrtcid].username;return easyrtcid},this.webSocket=null;var pc_config={},pc_config_to_use=null,use_fresh_ice_each_peer=!1;this.setUseFreshIceEachPeerConnection=function(value){use_fresh_ice_each_peer=value},this.getServerIce=function(){return pc_config},this.setIceUsedInCalls=function(ice){ice.iceServers?pc_config_to_use=ice:self.showError(self.errCodes.DEVELOPER_ERR,"Bad ice configuration passed to easyrtc.setIceUsedInCalls")};var closedChannel=null;this.haveAudioTrack=function(easyrtcid,streamName){return _haveTracks(easyrtcid,!0,streamName)},this.haveVideoTrack=function(easyrtcid,streamName){return _haveTracks(easyrtcid,!1,streamName)},this.getRoomField=function(roomName,fieldName){var fields=self.getRoomFields(roomName);return fields&&fields[fieldName]?fields[fieldName].fieldValue:void 0},this.supportsStatistics=function(){var peer;try{return peer=new RTCPeerConnection({iceServers:[]},{}),!!peer.getStats}catch(err){return!1}};var fields=null,preallocatedSocketIo=null;this.disconnect=function(){self.debugPrinter&&self.debugPrinter("attempt to disconnect from WebRTC signalling server"),self.disconnecting=!0,self.hangupAll(),self.loggingOut=!0,setTimeout(function(){if(self.webSocket){try{self.webSocket.disconnect()}catch(e){}closedChannel=self.webSocket,self.webSocket=0}self.loggingOut=!1,self.disconnecting=!1,roomOccupantListener&&roomOccupantListener(null,{},!1),self.emitEvent("roomOccupant",{}),oldConfig={}},250)};var sendByChunkUidCounter=0;this.sendDataP2P=function(destUser,msgType,msgData){var flattenedData=JSON.stringify({msgType:msgType,msgData:msgData});if(self.debugPrinter&&self.debugPrinter("sending p2p message to "+destUser+" with data="+JSON.stringify(flattenedData)),peerConns[destUser])if(peerConns[destUser].dataChannelS)if(peerConns[destUser].dataChannelReady)try{flattenedData.length>self.maxP2PMessageLength?sendByChunkHelper(destUser,flattenedData):peerConns[destUser].dataChannelS.send(flattenedData)}catch(oops){throw webrtcUtils.log("snedDataP2P error: ",oops),oops}else self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to use data channel to "+destUser+" before it's ready to send.");else self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without establishing a data channel to "+destUser+" first.");else self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without a connection to "+destUser+" first.")},this.sendDataWS=function(destination,msgType,msgData,ackhandler){self.debugPrinter&&self.debugPrinter("sending client message via websockets to "+destination+" with data="+JSON.stringify(msgData)),
ackhandler||(ackhandler=function(msg){"error"===msg.msgType&&self.showError(msg.msgData.errorCode,msg.msgData.errorText)});var outgoingMessage={msgType:msgType,msgData:msgData};if(destination&&("string"==typeof destination?outgoingMessage.targetEasyrtcid=destination:"object"==typeof destination&&(destination.targetEasyrtcid&&(outgoingMessage.targetEasyrtcid=destination.targetEasyrtcid),destination.targetRoom&&(outgoingMessage.targetRoom=destination.targetRoom),destination.targetGroup&&(outgoingMessage.targetGroup=destination.targetGroup))),!self.webSocket)throw self.debugPrinter&&self.debugPrinter("websocket failed because no connection to server"),"Attempt to send message without a valid connection to the server.";self.webSocket.json.emit("easyrtcMsg",outgoingMessage,ackhandler)},this.sendData=function(destUser,msgType,msgData,ackHandler){peerConns[destUser]&&peerConns[destUser].dataChannelReady?self.sendDataP2P(destUser,msgType,msgData):self.sendDataWS(destUser,msgType,msgData,ackHandler)},this.sendPeerMessage=function(destination,msgType,msgData,successCB,failureCB){function ackHandler(response){"error"===response.msgType?failureCB&&failureCB(response.msgData.errorCode,response.msgData.errorText):successCB&&successCB(response.msgType,response.msgData?response.msgData:null)}destination||self.showError(self.errCodes.DEVELOPER_ERR,"destination was null in sendPeerMessage"),self.debugPrinter&&self.debugPrinter("sending peer message "+JSON.stringify(msgData)),self.sendDataWS(destination,msgType,msgData,ackHandler)},this.sendServerMessage=function(msgType,msgData,successCB,failureCB){function ackhandler(response){"error"===response.msgType?failureCB&&failureCB(response.msgData.errorCode,response.msgData.errorText):successCB&&successCB(response.msgType,response.msgData?response.msgData:null)}if(self.debugPrinter){var dataToShip={msgType:msgType,msgData:msgData};self.debugPrinter("sending server message "+JSON.stringify(dataToShip))}self.sendDataWS(null,msgType,msgData,ackhandler)},this.getRoomList=function(callback,errorCallback){sendSignalling(null,"getRoomList",null,function(msgType,msgData){callback(msgData.roomList)},function(errorCode,errorText){errorCallback?errorCallback(errorCode,errorText):self.showError(errorCode,errorText)})},this.NOT_CONNECTED="not connected",this.BECOMING_CONNECTED="connection in progress to us.",this.IS_CONNECTED="is connected",this.getConnectStatus=function(otherUser){if(!peerConns.hasOwnProperty(otherUser))return self.NOT_CONNECTED;var peer=peerConns[otherUser];return!peer.sharingAudio&&!peer.sharingVideo||peer.startedAV?peer.sharingData&&!peer.dataChannelReady?self.BECOMING_CONNECTED:self.IS_CONNECTED:self.BECOMING_CONNECTED},this.call=function(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames){if(streamNames)if("string"==typeof streamNames)streamNames=[streamNames];else if("undefined"==typeof streamNames.length)return void self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.call passed bad streamNames");if(self.debugPrinter&&self.debugPrinter("initiating peer to peer call to "+otherUser+" audio="+self.audioEnabled+" video="+self.videoEnabled+" data="+dataEnabled),!self.supportsPeerConnections())return void callFailureCB(self.errCodes.CALL_ERR,self.getConstantString("noWebrtcSupport"));var message;if(!streamNames&&autoInitUserMedia){var stream=self.getLocalStream();if(!stream&&(self.audioEnabled||self.videoEnabled))return void self.initMediaSource(function(){self.call(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB)},callFailureCB)}if(!self.webSocket)throw message="Attempt to make a call prior to connecting to service",self.debugPrinter&&self.debugPrinter(message),message;return offersPending[otherUser]?(wasAcceptedCB(!0,otherUser),doAnswer(otherUser,offersPending[otherUser],streamNames),delete offersPending[otherUser],void self.callCancelled(otherUser,!1)):"undefined"!=typeof acceptancePending[otherUser]?(message="Call already pending acceptance",self.debugPrinter&&self.debugPrinter(message),void callFailureCB(self.errCodes.ALREADY_CONNECTED,message)):void(use_fresh_ice_each_peer?self.getFreshIceConfig(function(succeeded){succeeded?callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames):callFailureCB(self.errCodes.CALL_ERR,"Attempt to get fresh ice configuration failed")}):callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames))};var queuedMessages={};this.hangup=function(otherUser){hangupBody(otherUser),updateConfigurationInfo()},this.hangupAll=function(){var sawAConnection=!1;for(var otherUser in peerConns)peerConns.hasOwnProperty(otherUser)&&(sawAConnection=!0,hangupBody(otherUser));sawAConnection&&updateConfigurationInfo()},this.doesDataChannelWork=function(otherUser){return!!peerConns[otherUser]&&!!peerConns[otherUser].dataChannelReady},this.getRemoteStream=function(easyrtcid,remoteStreamName){if(peerConns[easyrtcid])return peerConns[easyrtcid].getRemoteStreamByName(remoteStreamName);throw self.showError(self.errCodes.DEVELOPER_ERR,"attempt to get stream of uncalled party"),"Developer err: no such stream"},this.makeLocalStreamFromRemoteStream=function(easyrtcid,remoteStreamName,localStreamName){var remoteStream;if(!peerConns[easyrtcid].pc)throw"Developer err: no such peer ";if(remoteStream=peerConns[easyrtcid].getRemoteStreamByName(remoteStreamName),!remoteStream)throw"Developer err: no such stream";registerLocalMediaStreamByName(remoteStream,localStreamName)},this.addStreamToCall=function(easyrtcId,streamName,receiptHandler){streamName||(streamName="default");var stream=getLocalMediaStreamByName(streamName);if(stream)if(peerConns[easyrtcId]&&peerConns[easyrtcId].pc){var pc=peerConns[easyrtcId].pc;peerConns[easyrtcId].enableNegotiateListener=!0,pc.addStream(stream),receiptHandler&&(peerConns[easyrtcId].streamsAddedAcks[streamName]=receiptHandler)}else webrtcUtils.log("Can't add stream before a call has started.");else webrtcUtils.log("attempt to add nonexistent stream "+streamName)},this.setPeerListener(function(easyrtcid,msgType,msgData){if(peerConns[easyrtcid]&&peerConns[easyrtcid].pc){var sdp=msgData.sdp,pc=peerConns[easyrtcid].pc,setLocalAndSendMessage1=function(sessionDescription){var sendAnswer=function(){function onSignalSuccess(){}function onSignalFailure(errorCode,errorText){delete peerConns[easyrtcid],self.showError(errorCode,errorText)}self.debugPrinter&&self.debugPrinter("sending answer"),sendSignalling(easyrtcid,"answer",sessionDescription,onSignalSuccess,onSignalFailure),peerConns[easyrtcid].connectionAccepted=!0,sendQueuedCandidates(easyrtcid,onSignalSuccess,onSignalFailure)};sdpLocalFilter&&(sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)),pc.setLocalDescription(sessionDescription,sendAnswer,function(message){self.showError(self.errCodes.INTERNAL_ERR,"setLocalDescription: "+msgData)})},invokeCreateAnswer=function(){pc.createAnswer(setLocalAndSendMessage1,function(message){self.showError(self.errCodes.INTERNAL_ERR,"create-answer: "+message)},receivedMediaConstraints),self.sendPeerMessage(easyrtcid,"__gotAddedMediaStream",{sdp:sdp})};self.debugPrinter&&self.debugPrinter("about to call setRemoteDescription in doAnswer");try{sdpRemoteFilter&&(sdp.sdp=sdpRemoteFilter(sdp.sdp)),pc.setRemoteDescription(new RTCSessionDescription(sdp),invokeCreateAnswer,function(message){self.showError(self.errCodes.INTERNAL_ERR,"set-remote-description: "+message)})}catch(srdError){webrtcUtils.log("set remote description failed"),self.debugPrinter&&self.debugPrinter("saw exception in setRemoteDescription"),self.showError(self.errCodes.INTERNAL_ERR,"setRemoteDescription failed: "+srdError.message)}}else self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to add additional stream before establishing the base call.")},"__addedMediaStream"),this.setPeerListener(function(easyrtcid,msgType,msgData){if(peerConns[easyrtcid]&&peerConns[easyrtcid].pc){var sdp=msgData.sdp;sdpRemoteFilter&&(sdp.sdp=sdpRemoteFilter(sdp.sdp));var pc=peerConns[easyrtcid].pc;pc.setRemoteDescription(new RTCSessionDescription(sdp),function(){},function(message){self.showError(self.errCodes.INTERNAL_ERR,"set-remote-description: "+message)})}else self.debugPrinter&&self.debugPrinter("setPeerListener failed: __gotAddedMediaStream Unknow easyrtcid "+easyrtcid)},"__gotAddedMediaStream"),this.setPeerListener(function(easyrtcid,msgType,msgData){if(peerConns[easyrtcid]&&peerConns[easyrtcid].pc){var stream=peerConns[easyrtcid].getRemoteStreamByName(msgData.streamName);stream&&(onRemoveStreamHelper(easyrtcid,stream),stopStream(stream))}else self.debugPrinter&&self.debugPrinter("setPeerListener failed: __closingMediaStream Unknow easyrtcid "+easyrtcid)},"__closingMediaStream"),this.dumpPeerConnectionInfo=function(){var i;for(var peer in peerConns)if(peerConns.hasOwnProperty(peer)){webrtcUtils.log("For peer "+peer);var pc=peerConns[peer].pc,remotes=pc.getRemoteStreams(),remoteIds=[];for(i=0;i<remotes.length;i++)remoteIds.push(remotes[i].id);var locals=pc.getLocalStreams(),localIds=[];for(i=0;i<locals.length;i++)localIds.push(locals[i].id);webrtcUtils.log("    "+JSON.stringify({local:localIds,remote:remoteIds}))}},this.isPeerInAnyRoom=function(easyrtcid){return isPeerInAnyRoom(easyrtcid)};var aggregatingTimers={};this.updatePresence=function(state,statusText){self.presenceShow=state,self.presenceStatus=statusText,self.webSocketConnected&&sendSignalling(null,"setPresence",{setPresence:{show:self.presenceShow,status:self.presenceStatus}},null)},this.getSessionFields=function(){return sessionFields},this.getSessionField=function(name){return sessionFields[name]?sessionFields[name].fieldValue:void 0},this.getRoomOccupantsAsArray=function(roomName){return lastLoggedInList[roomName]?Object.keys(lastLoggedInList[roomName]):null},this.getRoomOccupantsAsMap=function(roomName){return lastLoggedInList[roomName]},this.isTurnServer=function(ipAddress){return!!self._turnServers[ipAddress]},this.getFreshIceConfig=function(callback){var dataToShip={msgType:"getIceConfig",msgData:{}};callback||(callback=function(){}),self.webSocket.json.emit("easyrtcCmd",dataToShip,function(ackMsg){"iceConfig"===ackMsg.msgType?(processIceConfig(ackMsg.msgData.iceConfig),callback(!0)):(self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText),callback(!1))})},this.joinRoom=function(roomName,roomParameters,successCB,failureCB){if(self.roomJoin[roomName])return void self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to join room "+roomName+" which you are already in.");var newRoomData={roomName:roomName};if(roomParameters){try{JSON.stringify(roomParameters)}catch(error){throw self.showError(self.errCodes.DEVELOPER_ERR,"non-jsonable parameter to easyrtc.joinRoom"),"Developer error, see application error messages"}var parameters={};for(var key in roomParameters)roomParameters.hasOwnProperty(key)&&(parameters[key]=roomParameters[key]);newRoomData.roomParameter=parameters}var roomData,signallingSuccess,signallingFailure,msgData={roomJoin:{}};self.webSocket?(msgData.roomJoin[roomName]=newRoomData,signallingSuccess=function(msgType,msgData){roomData=msgData.roomData,self.roomJoin[roomName]=newRoomData,successCB&&successCB(roomName),processRoomData(roomData)},signallingFailure=function(errorCode,errorText){failureCB?failureCB(errorCode,errorText,roomName):self.showError(errorCode,self.format(self.getConstantString("unableToEnterRoom"),roomName,errorText))},sendSignalling(null,"roomJoin",msgData,signallingSuccess,signallingFailure)):self.roomJoin[roomName]=newRoomData},this.leaveRoom=function(roomName,successCallback,failureCallback){var roomItem;self.roomJoin[roomName]&&(self.webSocket?(roomItem={},roomItem[roomName]={roomName:roomName},sendSignalling(null,"roomLeave",{roomLeave:roomItem},function(msgType,msgData){var roomData=msgData.roomData;processRoomData(roomData),successCallback&&successCallback(roomName)},function(errorCode,errorText){failureCallback&&failureCallback(errorCode,errorText,roomName)})):delete self.roomJoin[roomName])},this.getRoomsJoined=function(){var key,roomsIn={};for(key in self.roomJoin)self.roomJoin.hasOwnProperty(key)&&(roomsIn[key]=!0);return roomsIn},this.getRoomFields=function(roomName){return fields&&fields.rooms&&fields.rooms[roomName]?fields.rooms[roomName]:void 0},this.getApplicationFields=function(){return fields.application},this.getConnectionFields=function(){return fields.connection},this.useThisSocketConnection=function(alreadyAllocatedSocketIo){preallocatedSocketIo=alreadyAllocatedSocketIo},this.connect=function(applicationName,successCallback,errorCallback){return window.io||self.showError(self.errCodes.DEVELOPER_ERR,"Your HTML has not included the socket.io.js library"),!preallocatedSocketIo&&self.webSocket?void self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to connect when already connected to socket server"):(pc_config={},closedChannel=null,oldConfig={},queuedMessages={},self.applicationName=applicationName,fields={rooms:{},application:{},connection:{}},self.debugPrinter&&self.debugPrinter("attempt to connect to WebRTC signalling server with application name="+applicationName),null===errorCallback&&(errorCallback=function(errorCode,errorText){self.showError(errorCode,errorText)}),void connectToWSServer(successCallback,errorCallback))}};window.easyrtc=new Easyrtc,function(){function easyAppBody(monitorVideoId,videoIds){function validateVideoIds(monitorVideoId,videoIds){var i;if(monitorVideoId&&!document.getElementById(monitorVideoId))return easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"The monitor video id passed to easyApp was bad, saw "+monitorVideoId),!1;for(i in videoIds)if(videoIds.hasOwnProperty(i)){var name=videoIds[i];if(!document.getElementById(name))return easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"The caller video id '"+name+"' passed to easyApp was bad."),!1}return!0}function getCallerOfVideo(videoObject){return videoIdToCallerMap[videoObject.id]}function setCallerOfVideo(videoObject,callerEasyrtcId){videoIdToCallerMap[videoObject.id]=callerEasyrtcId}function videoIsFree(obj){var caller=getCallerOfVideo(obj);return""===caller||null===caller||void 0===caller}function getIthVideo(i){return videoIdsP[i]?document.getElementById(videoIdsP[i]):null}function showVideo(video,stream){easyrtc.setVideoObjectSrc(video,stream),video.style.visibility&&(video.style.visibility="visible")}function hideVideo(video){easyrtc.setVideoObjectSrc(video,""),video.style.visibility="hidden"}var videoIdsP=videoIds||[],numPEOPLE=videoIds.length,videoIdToCallerMap={},onCall=null,onHangup=null;if(!validateVideoIds(monitorVideoId,videoIdsP))throw"bad video element id";monitorVideoId&&(document.getElementById(monitorVideoId).muted="muted"),easyrtc.addEventListener("roomOccupants",function(eventName,eventData){var i;for(i=0;i<numPEOPLE;i++){var video=getIthVideo(i);videoIsFree(video)||easyrtc.isPeerInAnyRoom(getCallerOfVideo(video))||(onHangup&&onHangup(getCallerOfVideo(video),i),setCallerOfVideo(video,null))}}),easyrtc.setOnCall=function(cb){onCall=cb},easyrtc.setOnHangup=function(cb){onHangup=cb},easyrtc.getIthCaller=function(i){if(i<0||i>=videoIdsP.length)return null;var vid=getIthVideo(i);return getCallerOfVideo(vid)},easyrtc.getSlotOfCaller=function(easyrtcid){var i;for(i=0;i<numPEOPLE;i++)if(easyrtc.getIthCaller(i)===easyrtcid)return i;return-1},easyrtc.setOnStreamClosed(function(caller){var i;for(i=0;i<numPEOPLE;i++){var video=getIthVideo(i);getCallerOfVideo(video)===caller&&(hideVideo(video),setCallerOfVideo(video,""),onHangup&&onHangup(caller,i))}}),easyrtc.setAcceptChecker(function(caller,helper){var i;for(i=0;i<numPEOPLE;i++){var video=getIthVideo(i);if(videoIsFree(video))return void helper(!0)}helper(!1)}),easyrtc.setStreamAcceptor(function(caller,stream){var i;easyrtc.debugPrinter&&easyrtc.debugPrinter("stream acceptor called");var video;for(i=0;i<numPEOPLE;i++)if(video=getIthVideo(i),getCallerOfVideo(video)===caller)return showVideo(video,stream),void(onCall&&onCall(caller,i));for(i=0;i<numPEOPLE;i++)if(video=getIthVideo(i),videoIsFree(video))return setCallerOfVideo(video,caller),onCall&&onCall(caller,i),void showVideo(video,stream);video=getIthVideo(0),video&&(easyrtc.hangup(getCallerOfVideo(video)),showVideo(video,stream),onCall&&onCall(caller,0)),setCallerOfVideo(video,caller)});var addControls,parentDiv,closeButton,i;if(autoAddCloseButtons)for(addControls=function(video){parentDiv=video.parentNode,setCallerOfVideo(video,""),closeButton=document.createElement("div"),closeButton.className="easyrtc_closeButton",closeButton.onclick=function(){getCallerOfVideo(video)&&(easyrtc.hangup(getCallerOfVideo(video)),hideVideo(video),setCallerOfVideo(video,""))},parentDiv.appendChild(closeButton)},i=0;i<numPEOPLE;i++)addControls(getIthVideo(i));var monitorVideo=null;if(easyrtc.videoEnabled&&null!==monitorVideoId){if(monitorVideo=document.getElementById(monitorVideoId),!monitorVideo)return void console.error("Programmer error: no object called "+monitorVideoId);monitorVideo.muted="muted",monitorVideo.defaultMuted=!0}}var autoAddCloseButtons=!0;easyrtc.dontAddCloseButtons=function(){autoAddCloseButtons=!1},easyrtc.easyApp=function(applicationName,monitorVideoId,videoIds,onReady,onFailure){function nextInitializationStep(){gotConnectionCallback&&gotConnectionCallback(!0,""),onReady(easyrtc.myEasyrtcid)}function postGetUserMedia(){function connectError(errorCode,errorText){gotConnectionCallback?gotConnectionCallback(!1,errorText):onFailure?onFailure(easyrtc.errCodes.CONNECT_ERR,errorText):easyrtc.showError(easyrtc.errCodes.CONNECT_ERR,errorText)}gotMediaCallback&&gotMediaCallback(!0,null),null!==monitorVideoId&&easyrtc.setVideoObjectSrc(document.getElementById(monitorVideoId),easyrtc.getLocalStream()),easyrtc.connect(applicationName,nextInitializationStep,connectError)}var gotMediaCallback=null,gotConnectionCallback=null;easyAppBody(monitorVideoId,videoIds),easyrtc.setGotMedia=function(gotMediaCB){gotMediaCallback=gotMediaCB},easyrtc.setPeerClosedListener(function(easyrtcid){setTimeout(function(){easyrtc.getSlotOfCaller(easyrtcid)>=0&&easyrtc.isPeerInAnyRoom(easyrtcid)&&easyrtc.call(easyrtcid,function(){},function(){},function(){})},1e3)}),easyrtc.setGotConnection=function(gotConnectionCB){gotConnectionCallback=gotConnectionCB};var stream=easyrtc.getLocalStream(null);stream?postGetUserMedia():easyrtc.initMediaSource(postGetUserMedia,function(errorCode,errorText){gotMediaCallback?gotMediaCallback(!1,errorText):onFailure?onFailure(easyrtc.errCodes.MEDIA_ERR,errorText):easyrtc.showError(easyrtc.errCodes.MEDIA_ERR,errorText)},null)}}();var easyrtc_constantStrings={unableToEnterRoom:"Unable to enter room {0} because {1}",resolutionWarning:"Requested video size of {0}x{1} but got size of {2}x{3}",badUserName:"Illegal username {0}",localMediaError:"Error getting local media stream: {0}",miscSignalError:"Miscellaneous error from signalling server. It may be ignorable.",noServer:"Unable to reach the EasyRTC signalling server.",badsocket:"Socket.io connect event fired with bad websocket.",icf:"Internal communications failure",statsNotSupported:"call statistics not supported by this browser, try Chrome.",noWebrtcSupport:"Your browser doesn't appear to support WebRTC.",gumFailed:"Failed to get access to local media. Error code was {0}.",requireAudioOrVideo:"At least one of audio and video must be provided"};
//# sourceMappingURL=sourcemap.map