"use strict";function trace(a){if("\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),window.performance){var b=(window.performance.now()/1e3).toFixed(3);webrtcUtils.log(b+": "+a)}else webrtcUtils.log(a)}function requestUserMedia(a){return new Promise(function(b,c){getUserMedia(a,b,c)})}var getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,webrtcMinimumVersion=null,webrtcUtils={log:function(){console.log.apply(console,arguments)},extractVersion:function(a,b,c){var d=a.match(b);return d&&d.length>=c&&parseInt(d[c],10)}};if("object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return"mozSrcObject"in this?this.mozSrcObject:this._srcObject},set:function(a){"mozSrcObject"in this?this.mozSrcObject=a:(this._srcObject=a,this.src=URL.createObjectURL(a))}}),getUserMedia=window.navigator&&window.navigator.getUserMedia),attachMediaStream=function(a,b){a.srcObject=b},reattachMediaStream=function(a,b){a.srcObject=b.srcObject},"undefined"!=typeof window&&window.navigator)if(navigator.mozGetUserMedia){if(webrtcUtils.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),webrtcMinimumVersion=31,window.RTCPeerConnection||(window.RTCPeerConnection=function(a,b){if(webrtcDetectedVersion<38&&a&&a.iceServers){for(var c=[],d=0;d<a.iceServers.length;d++){var e=a.iceServers[d];if(e.hasOwnProperty("urls"))for(var f=0;f<e.urls.length;f++){var g={url:e.urls[f]};0===e.urls[f].indexOf("turn")&&(g.username=e.username,g.credential=e.credential),c.push(g)}else c.push(a.iceServers[d])}a.iceServers=c}return new mozRTCPeerConnection(a,b)},mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return arguments.length?mozRTCPeerConnection.generateCertificate.apply(null,arguments):mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),getUserMedia=function(a,b,c){var d=function(a){if("object"!=typeof a||a.require)return a;var b=[];return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d=a[c]="object"==typeof a[c]?a[c]:{ideal:a[c]};if(void 0===d.min&&void 0===d.max&&void 0===d.exact||b.push(c),void 0!==d.exact&&("number"==typeof d.exact?d.min=d.max=d.exact:a[c]=d.exact,delete d.exact),void 0!==d.ideal){a.advanced=a.advanced||[];var e={};"number"==typeof d.ideal?e[c]={min:d.ideal,max:d.ideal}:e[c]=d.ideal,a.advanced.push(e),delete d.ideal,Object.keys(d).length||delete a[c]}}}),b.length&&(a.require=b),a};return webrtcDetectedVersion<38&&(webrtcUtils.log("spec: "+JSON.stringify(a)),a.audio&&(a.audio=d(a.audio)),a.video&&(a.video=d(a.video)),webrtcUtils.log("ff37: "+JSON.stringify(a))),navigator.mozGetUserMedia(a,b,c)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(a){var b=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];a(b)})},webrtcDetectedVersion<41){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().then(void 0,function(a){if("NotFoundError"===a.name)return[];throw a})}}}else if(navigator.webkitGetUserMedia&&window.webkitRTCPeerConnection&&!window.RTCPeerConnection){webrtcUtils.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),webrtcMinimumVersion=38,window.RTCPeerConnection=function(a,b){a&&a.iceTransportPolicy&&(a.iceTransports=a.iceTransportPolicy);var c=new webkitRTCPeerConnection(a,b),d=c.getStats.bind(c);return c.getStats=function(a,b,c){var e=this,f=arguments;if(arguments.length>0&&"function"==typeof a)return d(a,b);var g=function(a){var b={},c=a.result();return c.forEach(function(a){var c={id:a.id,timestamp:a.timestamp,type:a.type};a.names().forEach(function(b){c[b]=a.stat(b)}),b[c.id]=c}),b};if(arguments.length>=2){var h=function(a){f[1](g(a))};return d.apply(this,[h,arguments[0]])}return new Promise(function(b,c){1===f.length&&null===a?d.apply(e,[function(a){b.apply(null,[g(a)])},c]):d.apply(e,[b,c])})},c},webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return arguments.length?webkitRTCPeerConnection.generateCertificate.apply(null,arguments):webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var c=1===arguments.length?arguments[0]:void 0;return new Promise(function(d,e){b.apply(a,[d,e,c])})}return b.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=arguments,c=this;return new Promise(function(d,e){b.apply(c,[a[0],function(){d(),a.length>=2&&a[1].apply(null,[])},function(b){e(b),a.length>=3&&a[2].apply(null,[b])}])})}});var constraintsToChrome=function(a){if("object"!=typeof a||a.mandatory||a.optional)return a;var b={};return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d="object"==typeof a[c]?a[c]:{ideal:a[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);var e=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==d.ideal){b.optional=b.optional||[];var f={};"number"==typeof d.ideal?(f[e("min",c)]=d.ideal,b.optional.push(f),f={},f[e("max",c)]=d.ideal,b.optional.push(f)):(f[e("",c)]=d.ideal,b.optional.push(f))}void 0!==d.exact&&"number"!=typeof d.exact?(b.mandatory=b.mandatory||{},b.mandatory[e("",c)]=d.exact):["min","max"].forEach(function(a){void 0!==d[a]&&(b.mandatory=b.mandatory||{},b.mandatory[e(a,c)]=d[a])})}}),a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced)),b};if(getUserMedia=function(a,b,c){return a.audio&&(a.audio=constraintsToChrome(a.audio)),a.video&&(a.video=constraintsToChrome(a.video)),webrtcUtils.log("chrome: "+JSON.stringify(a)),navigator.webkitGetUserMedia(a,b,c)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,enumerateDevices:function(){return new Promise(function(a){var b={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(c){a(c.map(function(a){return{label:a.label,kind:b[a.kind],deviceId:a.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(a){return webrtcUtils.log("spec:   "+JSON.stringify(a)),a.audio=constraintsToChrome(a.audio),a.video=constraintsToChrome(a.video),webrtcUtils.log("chrome: "+JSON.stringify(a)),origGetUserMedia(a)}}else navigator.mediaDevices.getUserMedia=function(a){return requestUserMedia(a)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){webrtcUtils.log("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){webrtcUtils.log("Dummy mediaDevices.removeEventListener called.")}),attachMediaStream=function(a,b){webrtcDetectedVersion>=43?a.srcObject=b:"undefined"!=typeof a.src?a.src=URL.createObjectURL(b):webrtcUtils.log("Error attaching stream to element.")},reattachMediaStream=function(a,b){webrtcDetectedVersion>=43?a.srcObject=b.srcObject:a.src=b.src}}else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)){if(webrtcUtils.log("This appears to be Edge"),webrtcDetectedBrowser="edge",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),webrtcMinimumVersion=10547,window.RTCIceGatherer){var generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},localCName=generateIdentifier(),SDPUtils={};SDPUtils.splitLines=function(a){return a.trim().split("\n").map(function(a){return a.trim()})},SDPUtils.splitSections=function(a){var b=a.split("\r\nm=");return b.map(function(a,b){return(b>0?"m="+a:a).trim()+"\r\n"})},SDPUtils.matchPrefix=function(a,b){return SDPUtils.splitLines(a).filter(function(a){return 0===a.indexOf(b)})},SDPUtils.parseCandidate=function(a){var b;b=0===a.indexOf("a=candidate:")?a.substring(12).split(" "):a.substring(10).split(" ");for(var c={foundation:b[0],component:b[1],protocol:b[2].toLowerCase(),priority:parseInt(b[3],10),ip:b[4],port:parseInt(b[5],10),type:b[7]},d=8;d<b.length;d+=2)switch(b[d]){case"raddr":c.relatedAddress=b[d+1];break;case"rport":c.relatedPort=parseInt(b[d+1],10);break;case"tcptype":c.tcpType=b[d+1]}return c},SDPUtils.writeCandidate=function(a){var b=[];b.push(a.foundation),b.push(a.component),b.push(a.protocol.toUpperCase()),b.push(a.priority),b.push(a.ip),b.push(a.port);var c=a.type;return b.push("typ"),b.push(c),"host"!==c&&a.relatedAddress&&a.relatedPort&&(b.push("raddr"),b.push(a.relatedAddress),b.push("rport"),b.push(a.relatedPort)),a.tcpType&&"tcp"===a.protocol.toLowerCase()&&(b.push("tcptype"),b.push(a.tcpType)),"candidate:"+b.join(" ")},SDPUtils.parseRtpMap=function(a){var b=a.substr(9).split(" "),c={payloadType:parseInt(b.shift(),10)};return b=b[0].split("/"),c.name=b[0],c.clockRate=parseInt(b[1],10),c.numChannels=3===b.length?parseInt(b[2],10):1,c},SDPUtils.writeRtpMap=function(a){var b=a.payloadType;return void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType),"a=rtpmap:"+b+" "+a.name+"/"+a.clockRate+(1!==a.numChannels?"/"+a.numChannels:"")+"\r\n"},SDPUtils.parseFmtp=function(a){for(var c,b={},d=a.substr(a.indexOf(" ")+1).split(";"),e=0;e<d.length;e++)c=d[e].trim().split("="),b[c[0].trim()]=c[1];return b},SDPUtils.writeFtmp=function(a){var b="",c=a.payloadType;if(void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.parameters&&a.parameters.length){var d=[];Object.keys(a.parameters).forEach(function(b){d.push(b+"="+a.parameters[b])}),b+="a=fmtp:"+c+" "+d.join(";")+"\r\n"}return b},SDPUtils.parseRtcpFb=function(a){var b=a.substr(a.indexOf(" ")+1).split(" ");return{type:b.shift(),parameter:b.join(" ")}},SDPUtils.writeRtcpFb=function(a){var b="",c=a.payloadType;return void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.rtcpFeedback&&a.rtcpFeedback.length&&a.rtcpFeedback.forEach(function(a){b+="a=rtcp-fb:"+c+" "+a.type+" "+a.parameter+"\r\n"}),b},SDPUtils.parseSsrcMedia=function(a){var b=a.indexOf(" "),c={ssrc:a.substr(7,b-7)},d=a.indexOf(":",b);return d>-1?(c.attribute=a.substr(b+1,d-b-1),c.value=a.substr(d+1)):c.attribute=a.substr(b+1),c},SDPUtils.getDtlsParameters=function(a,b){var c=SDPUtils.splitLines(a);c=c.concat(SDPUtils.splitLines(b));var d=c.filter(function(a){return 0===a.indexOf("a=fingerprint:")})[0].substr(14),e={role:"auto",fingerprints:[{algorithm:d.split(" ")[0],value:d.split(" ")[1]}]};return e},SDPUtils.writeDtlsParameters=function(a,b){var c="a=setup:"+b+"\r\n";return a.fingerprints.forEach(function(a){c+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"}),c},SDPUtils.getIceParameters=function(a,b){var c=SDPUtils.splitLines(a);c=c.concat(SDPUtils.splitLines(b));var d={usernameFragment:c.filter(function(a){return 0===a.indexOf("a=ice-ufrag:")})[0].substr(12),password:c.filter(function(a){return 0===a.indexOf("a=ice-pwd:")})[0].substr(10)};return d},SDPUtils.writeIceParameters=function(a){return"a=ice-ufrag:"+a.usernameFragment+"\r\na=ice-pwd:"+a.password+"\r\n"},SDPUtils.parseRtpParameters=function(a){for(var b={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},c=SDPUtils.splitLines(a),d=c[0].split(" "),e=3;e<d.length;e++){var f=d[e],g=SDPUtils.matchPrefix(a,"a=rtpmap:"+f+" ")[0];if(g){var h=SDPUtils.parseRtpMap(g),i=SDPUtils.matchPrefix(a,"a=fmtp:"+f+" ");h.parameters=i.length?SDPUtils.parseFmtp(i[0]):{},h.rtcpFeedback=SDPUtils.matchPrefix(a,"a=rtcp-fb:"+f+" ").map(SDPUtils.parseRtcpFb),b.codecs.push(h)}}return b},SDPUtils.writeRtpDescription=function(a,b){var c="";return c+="m="+a+" ",c+=b.codecs.length>0?"9":"0",c+=" UDP/TLS/RTP/SAVPF ",c+=b.codecs.map(function(a){return void 0!==a.preferredPayloadType?a.preferredPayloadType:a.payloadType}).join(" ")+"\r\n",c+="c=IN IP4 0.0.0.0\r\n",c+="a=rtcp:9 IN IP4 0.0.0.0\r\n",b.codecs.forEach(function(a){c+=SDPUtils.writeRtpMap(a),c+=SDPUtils.writeFtmp(a),c+=SDPUtils.writeRtcpFb(a)}),c+="a=rtcp-mux\r\n"},SDPUtils.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},SDPUtils.writeMediaSection=function(a,b,c,d){var e=SDPUtils.writeRtpDescription(a.kind,b);if(e+=SDPUtils.writeIceParameters(a.iceGatherer.getLocalParameters()),e+=SDPUtils.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":"active"),e+="a=mid:"+a.mid+"\r\n",e+=a.rtpSender&&a.rtpReceiver?"a=sendrecv\r\n":a.rtpSender?"a=sendonly\r\n":a.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",a.rtpSender){var f="msid:"+d.id+" "+a.rtpSender.track.id+"\r\n";e+="a="+f,e+="a=ssrc:"+a.sendSsrc+" "+f}return e+="a=ssrc:"+a.sendSsrc+" cname:"+localCName+"\r\n"},SDPUtils.getDirection=function(a,b){for(var c=SDPUtils.splitLines(a),d=0;d<c.length;d++)switch(c[d]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return c[d].substr(2)}return b?SDPUtils.getDirection(b):"sendrecv"},window.RTCIceCandidate||(window.RTCIceCandidate=function(a){return a}),window.RTCSessionDescription||(window.RTCSessionDescription=function(a){return a}),window.RTCPeerConnection=function(a){var b=this;if(this.onicecandidate=null,this.onaddstream=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return b.localStreams},this.getRemoteStreams=function(){return b.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},a&&a.iceTransportPolicy)switch(a.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=a.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}a&&a.iceServers&&a.iceServers.forEach(function(a){if(a.urls){var c;c="string"==typeof a.urls?a.urls:a.urls[0],c.indexOf("transport=udp")!==-1&&b.iceServers.push({username:a.username,credential:a.credential,urls:c})}}),this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var a=this;this._localIceCandidatesBuffer.forEach(function(b){null!==a.onicecandidate&&a.onicecandidate(b)}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.addStream=function(a){this.localStreams.push(a.clone()),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(a){var b=this.localStreams.indexOf(a);b>-1&&(this.localStreams.splice(b,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype._getCommonCapabilities=function(a,b){var c={codecs:[],headerExtensions:[],fecMechanisms:[]};return a.codecs.forEach(function(a){for(var d=0;d<b.codecs.length;d++){var e=b.codecs[d];if(a.name.toLowerCase()===e.name.toLowerCase()&&a.clockRate===e.clockRate&&a.numChannels===e.numChannels){c.codecs.push(e);break}}}),a.headerExtensions.forEach(function(a){for(var d=0;d<b.headerExtensions.length;d++){var e=b.headerExtensions[d];if(a.uri===e.uri){c.headerExtensions.push(e);break}}}),c},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(a,b){var c=this,d=new RTCIceGatherer(c.iceOptions),e=new RTCIceTransport(d);d.onlocalcandidate=function(f){var g={};g.candidate={sdpMid:a,sdpMLineIndex:b};var h=f.candidate;h&&0!==Object.keys(h).length?(h.component="RTCP"===e.component?2:1,g.candidate.candidate=SDPUtils.writeCandidate(h)):(void 0===d.state&&(d.state="completed"),g.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates");var i=c.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});null!==c.onicecandidate&&(c.localDescription&&""===c.localDescription.type?(c._localIceCandidatesBuffer.push(g),i&&c._localIceCandidatesBuffer.push({})):(c.onicecandidate(g),i&&c.onicecandidate({})))},e.onicestatechange=function(){c._updateConnectionState()};var f=new RTCDtlsTransport(e);return f.ondtlsstatechange=function(){c._updateConnectionState()},f.onerror=function(){f.state="failed",c._updateConnectionState()},{iceGatherer:d,iceTransport:e,dtlsTransport:f}},window.RTCPeerConnection.prototype._transceive=function(a,b,c){var d=this._getCommonCapabilities(a.localCapabilities,a.remoteCapabilities);b&&a.rtpSender&&(d.encodings=[{ssrc:a.sendSsrc}],d.rtcp={cname:localCName,ssrc:a.recvSsrc},a.rtpSender.send(d)),c&&a.rtpReceiver&&(d.encodings=[{ssrc:a.recvSsrc}],d.rtcp={cname:a.cname,ssrc:a.sendSsrc},a.rtpReceiver.receive(d))},window.RTCPeerConnection.prototype.setLocalDescription=function(a){var b=this;if("offer"===a.type)this._pendingOffer&&(this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===a.type){var c=SDPUtils.splitSections(b.remoteDescription.sdp),d=c.shift();c.forEach(function(a,c){var e=b.transceivers[c],f=e.iceGatherer,g=e.iceTransport,h=e.dtlsTransport,i=e.localCapabilities,j=e.remoteCapabilities,k="0"===a.split("\n",1)[0].split(" ",2)[1];if(!k){var l=SDPUtils.getIceParameters(a,d);g.start(f,l,"controlled");var m=SDPUtils.getDtlsParameters(a,d);h.start(m);var n=b._getCommonCapabilities(i,j);b._transceive(e,n.codecs.length>0,!1)}})}switch(this.localDescription=a,a.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+a.type+'"')}var e=arguments.length>1&&"function"==typeof arguments[1];if(e){var f=arguments[1];window.setTimeout(function(){f(),b._emitBufferedCandidates()},0)}var g=Promise.resolve();return g.then(function(){e||window.setTimeout(b._emitBufferedCandidates.bind(b),0)}),g},window.RTCPeerConnection.prototype.setRemoteDescription=function(a){var b=this,c=new MediaStream,d=SDPUtils.splitSections(a.sdp),e=d.shift();switch(d.forEach(function(d,f){var l,m,n,o,p,q,r,s,t,v,w,g=SDPUtils.splitLines(d),h=g[0].substr(2).split(" "),i=h[0],j="0"===h[1],k=SDPUtils.getDirection(d,e),u=SDPUtils.parseRtpParameters(d);j||(v=SDPUtils.getIceParameters(d,e),w=SDPUtils.getDtlsParameters(d,e));var y,x=SDPUtils.matchPrefix(d,"a=mid:")[0].substr(6),z=SDPUtils.matchPrefix(d,"a=ssrc:").map(function(a){return SDPUtils.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];if(z&&(s=parseInt(z.ssrc,10),y=z.value),"offer"===a.type){var A=b._createIceAndDtlsTransports(x,f);if(t=RTCRtpReceiver.getCapabilities(i),r=1001*(2*f+2),q=new RTCRtpReceiver(A.dtlsTransport,i),c.addTrack(q.track),b.localStreams.length>0&&b.localStreams[0].getTracks().length>=f){var B=b.localStreams[0].getTracks()[f];p=new RTCRtpSender(B,A.dtlsTransport)}b.transceivers[f]={iceGatherer:A.iceGatherer,iceTransport:A.iceTransport,dtlsTransport:A.dtlsTransport,localCapabilities:t,remoteCapabilities:u,rtpSender:p,rtpReceiver:q,kind:i,mid:x,cname:y,sendSsrc:r,recvSsrc:s},b._transceive(b.transceivers[f],!1,"sendrecv"===k||"sendonly"===k)}else"answer"!==a.type||j||(l=b.transceivers[f],m=l.iceGatherer,n=l.iceTransport,o=l.dtlsTransport,p=l.rtpSender,q=l.rtpReceiver,r=l.sendSsrc,t=l.localCapabilities,b.transceivers[f].recvSsrc=s,b.transceivers[f].remoteCapabilities=u,b.transceivers[f].cname=y,n.start(m,v,"controlling"),o.start(w),b._transceive(l,"sendrecv"===k||"recvonly"===k,"sendrecv"===k||"sendonly"===k),!q||"sendrecv"!==k&&"sendonly"!==k?delete l.rtpReceiver:c.addTrack(q.track))}),this.remoteDescription=a,a.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+a.type+'"')}return window.setTimeout(function(){null!==b.onaddstream&&c.getTracks().length&&(b.remoteStreams.push(c),window.setTimeout(function(){b.onaddstream({stream:c})},0))},0),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&a.iceTransport.stop(),a.dtlsTransport&&a.dtlsTransport.stop(),a.rtpSender&&a.rtpSender.stop(),a.rtpReceiver&&a.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(a){this.signalingState=a,null!==this.onsignalingstatechange&&this.onsignalingstatechange()},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){null!==this.onnegotiationneeded&&this.onnegotiationneeded()},window.RTCPeerConnection.prototype._updateConnectionState=function(){var b,a=this,c={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};this.transceivers.forEach(function(a){c[a.iceTransport.state]++,c[a.dtlsTransport.state]++}),c.connected+=c.completed,b="new",c.failed>0?b="failed":c.connecting>0||c.checking>0?b="connecting":c.disconnected>0?b="disconnected":c.new>0?b="new":(c.connecting>0||c.completed>0)&&(b="connected"),b!==a.iceConnectionState&&(a.iceConnectionState=b,null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange())},window.RTCPeerConnection.prototype.createOffer=function(){var a=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var b;1===arguments.length&&"function"!=typeof arguments[0]?b=arguments[0]:3===arguments.length&&(b=arguments[2]);var c=[],d=0,e=0;if(this.localStreams.length&&(d=this.localStreams[0].getAudioTracks().length,e=this.localStreams[0].getVideoTracks().length),b){if(b.mandatory||b.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==b.offerToReceiveAudio&&(d=b.offerToReceiveAudio),void 0!==b.offerToReceiveVideo&&(e=b.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(a){c.push({kind:a.kind,track:a,wantReceive:"audio"===a.kind?d>0:e>0}),"audio"===a.kind?d--:"video"===a.kind&&e--});d>0||e>0;)d>0&&(c.push({kind:"audio",wantReceive:!0}),d--),e>0&&(c.push({kind:"video",wantReceive:!0}),e--);var f=SDPUtils.writeSessionBoilerplate(),g=[];c.forEach(function(b,c){var k,l,d=b.track,e=b.kind,h=generateIdentifier(),i=a._createIceAndDtlsTransports(h,c),j=RTCRtpSender.getCapabilities(e),m=1001*(2*c+1);d&&(k=new RTCRtpSender(d,i.dtlsTransport)),b.wantReceive&&(l=new RTCRtpReceiver(i.dtlsTransport,e)),g[c]={iceGatherer:i.iceGatherer,iceTransport:i.iceTransport,dtlsTransport:i.dtlsTransport,localCapabilities:j,remoteCapabilities:null,rtpSender:k,rtpReceiver:l,kind:e,mid:h,sendSsrc:m,recvSsrc:null};var n=g[c];f+=SDPUtils.writeMediaSection(n,n.localCapabilities,"offer",a.localStreams[0])}),this._pendingOffer=g;var h=new RTCSessionDescription({type:"offer",sdp:f});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,h),Promise.resolve(h)},window.RTCPeerConnection.prototype.createAnswer=function(){var b,a=this;1===arguments.length&&"function"!=typeof arguments[0]?b=arguments[0]:3===arguments.length&&(b=arguments[2]);var c=SDPUtils.writeSessionBoilerplate();this.transceivers.forEach(function(b){var d=a._getCommonCapabilities(b.localCapabilities,b.remoteCapabilities);c+=SDPUtils.writeMediaSection(b,d,"answer",a.localStreams[0])});var d=new RTCSessionDescription({type:"answer",sdp:c});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,d),Promise.resolve(d)},window.RTCPeerConnection.prototype.addIceCandidate=function(a){var b=a.sdpMLineIndex;if(a.sdpMid)for(var c=0;c<this.transceivers.length;c++)if(this.transceivers[c].mid===a.sdpMid){b=c;break}var d=this.transceivers[b];if(d){var e=Object.keys(a.candidate).length>0?SDPUtils.parseCandidate(a.candidate):{};if("tcp"===e.protocol&&0===e.port)return;if("1"!==e.component)return;"endOfCandidates"===e.type&&(e={}),d.iceTransport.addRemoteCandidate(e)}return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var a=[];this.transceivers.forEach(function(b){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(c){b[c]&&a.push(b[c].getStats())})});var b=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(c){var d={};Promise.all(a).then(function(a){a.forEach(function(a){Object.keys(a).forEach(function(b){d[b]=a[b]})}),b&&window.setTimeout(b,0,d),c(d)})})}}}else webrtcUtils.log("Browser does not appear to be WebRTC-capable");else webrtcUtils.log("This does not appear to be a browser"),webrtcDetectedBrowser="not a browser";"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=a),this.addEventListener("addstream",this._ontrackpoly=function(a){a.stream.getTracks().forEach(function(b){var c=new Event("track");c.track=b,c.receiver={track:b},c.streams=[a.stream],this.dispatchEvent(c)}.bind(this))}.bind(this))}});var webrtcTesting={};try{Object.defineProperty(webrtcTesting,"version",{set:function(a){webrtcDetectedVersion=a}})}catch(a){}var Easyrtc=function(){function a(a){if(null===a||void 0===a)return!0;var b;for(b in a)if(a.hasOwnProperty(b))return!1;return!0}function i(a){var b,c;for(c=a.getAudioTracks(),b=0;b<c.length;b++)try{c[b].stop()}catch(a){}for(c=a.getVideoTracks(),b=0;b<c.length;b++)try{c[b].stop()}catch(a){}if("function"==typeof a.stop)try{a.stop()}catch(a){}}function j(a){return a&&(a.socket&&a.socket.connected||a.connected)}function n(a,c){if("string"!=typeof a)throw b.showError(b.errCodes.DEVELOPER_ERR,c+" called without a string as the first argument"),"developer error";if(!l[a])throw b.showError(b.errCodes.DEVELOPER_ERR,c+" called with a bad event name = "+a),"developer error"}function s(a,b){navigator.mediaDevices.enumerateDevices().then(function(c){for(var d=[],e=0;e<c.length;e++){var f=c[e];f.kind===b&&d.push(f)}a(d)}).catch(function(a){webrtcUtils.log("Unable to enumerate devices ("+a+")")})}function N(a,c){var d=JSON.stringify(c);JSON.parse(d);var e={msgType:"setRoomApiField",msgData:{setRoomApiField:{roomName:a,field:c}}};b.webSocket.json.emit("easyrtcCmd",e,function(a){"error"===a.msgType&&b.showError(a.msgData.errorCode,a.msgData.errorText)})}function P(a){O&&clearTimeout(O),O=setTimeout(function(){N(a,b._roomApiFields[a]),O=null},10)}function Q(a,b){var c;if(b)for(c=0;c<b.length;c++){var d=b[c];d.enabled=a}}function R(a){return a||(a="default"),p.hasOwnProperty(a)?p[a]:null}function S(){var b,a={};for(b in p)p.hasOwnProperty(b)&&(a[b]=p[b].id||"default");return a}function T(a,c){var d;if(c||(c="default"),a.streamName=c,p[c]=a,"default"!==c){var e=S(),f=b.roomData;for(d in f)f.hasOwnProperty(d)&&b.setRoomApiField(d,"mediaIds",e)}}function U(a,c){var d,e,f;if(c||(c="default"),G[a]&&(f=G[a].remoteStreamIdToName[c]))return f;for(d in b.roomData)if(b.roomData.hasOwnProperty(d)){if(e=b.getRoomApiField(d,a,"mediaIds"),!e)continue;for(f in e)if(e.hasOwnProperty(f)&&e[f]===c)return f;if("firefox"===webrtcDetectedBrowser){if(e.default)return"default";for(var g in e)if(e.hasOwnProperty(g))return g}}}function V(a){a||(a="default");var c=b.getLocalStream(a);if(c){var e,f,d=c.id||"default";if(p[a]){for(e in G)if(G.hasOwnProperty(e)){try{G[e].pc.removeStream(c)}catch(a){}b.sendPeerMessage(e,"__closingMediaStream",{streamId:d,streamName:a})}if(i(p[a]),delete p[a],"default"!==a){var g=S();for(f in b.roomData)b.roomData.hasOwnProperty(f)&&b.setRoomApiField(f,"mediaIds",g)}}}}function $(a,c,d){var e,f;if(a){if(f=G[a],!f)return b.showError(b.errCodes.DEVELOPER_ERR,"haveTracks called about a peer you don't have a connection to"),!1;e=f.getRemoteStreamByName(d)}else e=R(d);if(!e)return!1;var g;try{g=c?e.getAudioTracks():e.getVideoTracks()}catch(a){return!0}return!!g&&g.length>0}function ba(){var a;if(b.loggingOut=!0,v={},H={},b.disconnecting=!0,Z=b.webSocket,b.webSocketConnected&&(aa||b.webSocket.close(),b.webSocketConnected=!1),b.hangupAll(),z)for(a in C)C.hasOwnProperty(a)&&z(a,{},!1);C={},b.emitEvent("roomOccupant",{}),b.roomData={},b.roomJoin={},b.loggingOut=!1,b.myEasyrtcid=null,b.disconnecting=!1,u={}}function ca(a,c,d,e,f){if(!b.webSocket)throw"Attempt to send message without a valid connection to the server.";var g={msgType:c};a&&(g.targetEasyrtcid=a),d&&(g.msgData=d),b.debugPrinter&&b.debugPrinter("sending socket message "+JSON.stringify(g)),b.webSocket.json.emit("easyrtcCmd",g,function(a){"error"!==a.msgType?(a.hasOwnProperty("msgData")||(a.msgData=null),e&&e(a.msgType,a.msgData)):f?f(a.msgData.errorCode,a.msgData.errorText):b.showError(a.msgData.errorCode,a.msgData.errorText)})}function ea(a,c){var e,f,g,h,i,d=a+"-"+da++,j=Math.ceil(c.length/b.maxP2PMessageLength);for(g={transfer:"start",transferId:d,parts:j},i={transfer:"end",transferId:d},G[a].dataChannelS.send(JSON.stringify(g)),e=0,f=c.length;e<f;e+=b.maxP2PMessageLength)h={transferId:d,data:c.substr(e,b.maxP2PMessageLength),transfer:"chunk"},G[a].dataChannelS.send(JSON.stringify(h));G[a].dataChannelS.send(JSON.stringify(i))}function fa(){var a=[];return a.push({DtlsSrtpKeyAgreement:"true"}),{optional:a}}function ga(a,b,c){var d;for(d=0;d<G[a].candidatesToSend.length;d++)ca(a,"candidate",G[a].candidatesToSend[d],b,c)}function ha(a,c){if(G[a]){var d,e;e=c.id?c.id:"default",d=G[a].remoteStreamIdToName[e]||"default",G[a].liveRemoteStreams[d]&&b.onStreamClosed&&(delete G[a].liveRemoteStreams[d],b.onStreamClosed(a,c,d)),delete G[a].remoteStreamIdToName[e]}}function ia(a,b){if(G[a]&&(ha(a,b),F(),G[a].pc))try{G[a].pc.removeStream(b)}catch(a){}}function ja(a,b){function c(a){var b;for(b in a)if(a.hasOwnProperty(b))return!0;return!1}var d={};return c(a)&&(d.added=a),c(b)&&(d.deleted=b),c(d)?d:null}function ka(a,b){var c,f,d={},e={};for(c in b)b.hasOwnProperty(c)&&(null===a||"undefined"==typeof a[c]?d[c]=b[c]:"object"==typeof b[c]?(f=ka(a[c],b[c]),null!==f&&(d[c]=b[c])):b[c]!==a[c]&&(d[c]=b[c]));for(c in a)b.hasOwnProperty(c)&&"undefined"==typeof b[c]&&(e[c]=a[c]);return ja(d,e)}function la(){var d,c={};for(d in G)G.hasOwnProperty(d)&&(c[d]={connectTime:G[d].connectTime,isInitiator:!!G[d].isInitiator});var e={userSettings:{sharingAudio:!!k.audio,sharingVideo:!!k.video,sharingData:!!x,nativeVideoWidth:b.nativeVideoWidth,nativeVideoHeight:b.nativeVideoHeight,windowWidth:window.innerWidth,windowHeight:window.innerHeight,screenWidth:window.screen.width,screenHeight:window.screen.height,cookieEnabled:navigator.cookieEnabled,os:navigator.oscpu,language:navigator.language}};return a(c)||(e.p2pList=c),e}function ma(){var a=la(!1),c=function(){var c=ka(u,a);c&&(b.debugPrinter&&b.debugPrinter("cfg="+JSON.stringify(c.added)),
b.webSocket&&ca(null,"setUserCfg",{setUserCfg:c.added},null,null)),u=a};u==={}?c():setTimeout(c,100)}function na(a,e,h,i){function r(c){if(b.debugPrinter&&b.debugPrinter("saw dataChannel.onmessage event: "+JSON.stringify(c.data)),"dataChannelPrimed"===c.data)b.sendDataWS(a,"dataChannelPrimed","");else try{var d=JSON.parse(c.data);if(d)if(d.transfer&&d.transferId)if("start"===d.transfer){b.debugPrinter&&b.debugPrinter("start transfer #"+d.transferId);var e=parseInt(d.parts);q={chunks:[],parts:e,transferId:d.transferId}}else if("chunk"===d.transfer)b.debugPrinter&&b.debugPrinter("got chunk for transfer #"+d.transferId),"string"==typeof d.data&&d.data.length<=b.maxP2PMessageLength?q?d.transferId!==q.transferId?webrtcUtils.log("Developer error, invalid transfer id"):q.chunks.length+1>q.parts?webrtcUtils.log("Developer error, received too many chunks"):q.chunks.push(d.data):webrtcUtils.log("Developer error, unexpected chunk"):webrtcUtils.log("Developer error, invalid data");else if("end"===d.transfer){if(b.debugPrinter&&b.debugPrinter("end of transfer #"+d.transferId),q)if(d.transferId!==q.transferId)webrtcUtils.log("Developer error, invalid transfer id");else if(q.chunks.length!==q.parts)webrtcUtils.log("Developer error, received wrong number of chunks");else try{var f=JSON.parse(q.chunks.join(""));b.receivePeerDistribute(a,f,null)}catch(a){webrtcUtils.log("Developer error, unable to parse message")}else webrtcUtils.log("Developer error, unexpected end of transfer");q={}}else webrtcUtils.log("Developer error, got an unknown transfer message"+d.transfer);else b.receivePeerDistribute(a,d,null)}catch(a){}}function s(a){b.debugPrinter&&b.debugPrinter("saw initOutgoingChannel call");var c=j.createDataChannel(t,b.getDatachannelConstraints());G[a].dataChannelS=c,G[a].dataChannelR=c,c.onmessage=r,c.onopen=function(d){b.debugPrinter&&b.debugPrinter("saw dataChannel.onopen event"),G[a]&&c.send("dataChannelPrimed")},c.onclose=function(c){b.debugPrinter&&b.debugPrinter("saw dataChannelS.onclose event"),G[a]&&(G[a].dataChannelReady=!1,delete G[a].dataChannelS),B&&B(a),F()}}function u(a){b.debugPrinter&&b.debugPrinter("initializing incoming channel handler for "+a),G[a].pc.ondatachannel=function(c){b.debugPrinter&&b.debugPrinter("saw incoming data channel");var d=c.channel;G[a].dataChannelR=d,G[a].dataChannelS=d,G[a].dataChannelReady=!0,d.onmessage=r,d.onclose=function(c){b.debugPrinter&&b.debugPrinter("saw dataChannelR.onclose event"),G[a]&&(G[a].dataChannelReady=!1,delete G[a].dataChannelR),B&&B(a),F()},d.onopen=function(c){b.debugPrinter&&b.debugPrinter("saw dataChannel.onopen event"),G[a]&&d.send("dataChannelPrimed")}}}var j,l,m,n=X?X:W;b.debugPrinter&&b.debugPrinter("building peer connection to "+a);try{if(j=b.createRTCPeerConnection(n,fa()),!j)throw l="Unable to create PeerConnection object, check your ice configuration("+JSON.stringify(n)+")",b.debugPrinter&&b.debugPrinter(l),l;x&&"undefined"==typeof j.createDataChannel&&(x=!1),j.onnegotiationneeded=function(c){G[a]&&G[a].enableNegotiateListener&&j.createOffer(function(c){d&&(c.sdp=d(c.sdp)),j.setLocalDescription(c,function(){b.sendPeerMessage(a,"__addedMediaStream",{sdp:c})},function(){})},function(a){webrtcUtils.log("unexpected error in creating offer")})},j.oniceconnectionstatechange=function(c){g&&g(a,c.target);var d=c.currentTarget?c.currentTarget.iceConnectionState:"unknown";switch(d){case"connected":G[a]&&G[a].callSuccessCB&&G[a].callSuccessCB(a,"connection");break;case"failed":h&&h(b.errCodes.NOVIABLEICE,"No usable STUN/TURN path"),delete G[a];break;case"disconnected":b.onPeerFailing&&b.onPeerFailing(a),G[a]&&(G[a].failing=Date.now());break;case"closed":b.onPeerClosed&&b.onPeerClosed(a);break;case"connected":case"completed":G[a]&&(G[a].failing&&b.onPeerRecovered&&b.onPeerRecovered(a,G[a].failing,Date.now()),delete G[a].failing),delete G[a].failing}},j.onconnection=function(){b.debugPrinter&&b.debugPrinter("onconnection called prematurely")},m={pc:j,candidatesToSend:[],startedAV:!1,connectionAccepted:!1,isInitiator:e,remoteStreamIdToName:{},streamsAddedAcks:{},liveRemoteStreams:{},getRemoteStreamByName:function(c){var e,g,d=j.getRemoteStreams(),f=null;if(c||(c="default"),"default"===c)return d.length>0?d[0]:null;for(g in b.roomData)if(b.roomData.hasOwnProperty(g)){var h=b.getRoomApiField(g,a,"mediaIds");if(f=h?h[c]:null)break}for(f||b.showError(b.errCodes.DEVELOPER_ERR,"remote peer does not have media stream called "+c),e=0;e<d.length;e++){var i;if(i=d[e].id?d[e].id:"default",!f||i===f)return d[e]}return null}},j.onicecandidate=function(c){if(!G[a]||!G[a].cancelled){var d;if(c.candidate&&G[a]){if(d={type:"candidate",label:c.candidate.sdpMLineIndex,id:c.candidate.sdpMid,candidate:c.candidate.candidate},f&&(d=f(d,!1),!d))return;if(c.candidate.candidate.indexOf("typ relay")>0){var e=c.candidate.candidate.match(/(udp|tcp) \d+ (\d+\.\d+\.\d+\.\d+)/i)[2];b._turnServers[e]=!0}G[a].connectionAccepted?ca(a,"candidate",d,null,function(){h(b.errCodes.PEER_GONE,"Candidate disappeared")}):G[a].candidatesToSend.push(d)}}},j.onaddstream=function(c){if(!G[a]||!G[a].cancelled){b.debugPrinter&&b.debugPrinter("saw incoming media stream"),G[a].startedAV||(G[a].startedAV=!0,G[a].sharingAudio=k.audio,G[a].sharingVideo=k.video,G[a].connectTime=(new Date).getTime(),G[a].callSuccessCB&&(G[a].sharingAudio||G[a].sharingVideo)&&G[a].callSuccessCB(a,"audiovideo"),(b.audioEnabled||b.videoEnabled)&&ma());var d=U(a,c.stream.id||"default");d||(d="default"),G[a].remoteStreamIdToName[c.stream.id||"default"]=d,G[a].liveRemoteStreams[d]=!0,c.stream.streamName=d,b.streamAcceptor&&(b.streamAcceptor(a,c.stream,d),b.sendDataWS(a,"easyrtc_streamReceived",{streamName:d},function(){}))}},j.onremovestream=function(c){b.debugPrinter&&b.debugPrinter("saw remove on remote media stream"),ia(a,c.stream)},G[a]=m}catch(a){return b.debugPrinter&&b.debugPrinter(JSON.stringify(a)),h(b.errCodes.SYSTEM_ERR,a.message),null}var o,p;if(i)for(o=0;o<i.length;o++)p=R(i[o]),p?j.addStream(p):webrtcUtils.log("Developer error, attempt to access unknown local media stream "+i[o]);else c&&(b.videoEnabled||b.audioEnabled)&&(p=b.getLocalStream(),j.addStream(p));var q={};if(x){if(b.setPeerListener(function(){G[a].dataChannelReady=!0,G[a].callSuccessCB&&G[a].callSuccessCB(a,"datachannel"),A&&A(a,!0),F()},"dataChannelPrimed",a),e)try{s(a)}catch(a){webrtcUtils.log("failed to init outgoing channel"),h(b.errCodes.SYSTEM_ERR,b.formatError(a))}e||u(a)}return j.onconnection=function(){b.debugPrinter&&b.debugPrinter("setup pc.onconnection ")},b.setPeerListener(function(a,b,c,d){m.streamsAddedAcks[c.streamName]&&(m.streamsAddedAcks[c.streamName](a,c.streamName),delete m.streamsAddedAcks[c.streamName])},"easyrtc_streamReceived",a),j}function oa(a,c,f){var g=na(a,!1,function(a){b.showError(b.errCodes.SYSTEM_ERR,a)},f),h=G[a];if(!g)return void(b.debugPrinter&&b.debugPrinter("buildPeerConnection failed. Call not answered"));var i=function(c){if(!h.cancelled){var e=function(){function d(){}function e(c,d){delete G[a],b.showError(c,d)}b.debugPrinter&&b.debugPrinter("sending answer"),ca(a,"answer",c,d,e),G[a].connectionAccepted=!0,ga(a,d,e),g.connectDataConnection&&(b.debugPrinter&&b.debugPrinter("calling connectDataConnection(5002,5001)"),g.connectDataConnection(5002,5001))};d&&(c.sdp=d(c.sdp)),g.setLocalDescription(c,e,function(a){b.showError(b.errCodes.INTERNAL_ERR,"setLocalDescription: "+a)})}},j=new RTCSessionDescription(c);if(!j)throw"Could not create the RTCSessionDescription";b.debugPrinter&&b.debugPrinter("sdp ||  "+JSON.stringify(j));var k=function(){h.cancelled||g.createAnswer(i,function(a){b.showError(b.errCodes.INTERNAL_ERR,"create-answer: "+a)},r)};b.debugPrinter&&b.debugPrinter("about to call setRemoteDescription in doAnswer");try{e&&(j.sdp=e(j.sdp)),g.setRemoteDescription(j,k,function(a){b.showError(b.errCodes.INTERNAL_ERR,"set-remote-description: "+a)})}catch(a){webrtcUtils.log("set remote description failed"),b.debugPrinter&&b.debugPrinter("saw exception in setRemoteDescription"),b.showError(b.errCodes.INTERNAL_ERR,"setRemoteDescription failed: "+a.message)}}function pa(a,d,e){if(!e&&c){var f=b.getLocalStream();if(!f&&(b.videoEnabled||b.audioEnabled))return void b.initMediaSource(function(){pa(a,d)},function(a,c){b.showError(b.errCodes.MEDIA_ERR,b.format(b.getConstantString("localMediaError")))})}Y?b.getFreshIceConfig(function(c){c?oa(a,d,e):b.showError(b.errCodes.CALL_ERR,"Failed to get fresh ice config")}):oa(a,d,e)}function qa(a,c,e,f,g){H[a]=!0;var i,h=na(a,!0,e,g);if(!h)throw i="buildPeerConnection failed, call not completed",b.debugPrinter&&b.debugPrinter(i),i;G[a].callSuccessCB=c,G[a].callFailureCB=e,G[a].wasAcceptedCB=f;var j=G[a],k=function(c){if(!j.cancelled){var f=function(){ca(a,"offer",c,null,e)};d&&(c.sdp=d(c.sdp)),h.setLocalDescription(c,f,function(a){e(b.errCodes.CALL_ERR,a)})}};setTimeout(function(){G[a]&&h.createOffer(k,function(a){e(b.errCodes.CALL_ERR,JSON.stringify(a))},r)},100)}function ra(a){var b;return b=a.active===!0||a.ended===!1||a.getTracks().reduce(function(a){return a.enabled})}function ta(a){sa[a]={candidates:[]}}function ua(a){var c;if(b.debugPrinter&&b.debugPrinter("Hanging up on "+a),ta(a),G[a]){if(G[a].pc){var d=G[a].pc.getRemoteStreams();for(c=0;c<d.length;c++)ra(d[c])&&(ha(a,d[c]),i(d[c]));try{G[a].pc.close()}catch(a){b.debugPrinter&&b.debugPrinter("peer close failed:"+a)}}G[a].cancelled=!0,delete G[a],b.webSocket&&ca(a,"hangup",null,function(){},function(a,c){b.debugPrinter&&b.debugPrinter("hangup failed:"+c)}),H[a]&&delete H[a]}}function va(a){if(delete v[a],b.debugPrinter&&b.debugPrinter("Saw onRemote hangup event"),G[a]){if(G[a].cancelled=!0,G[a].pc){var c=G[a].pc.getRemoteStreams();if(c){var d;for(d=0;d<c.length;d++){ha(a,c[d]);try{i(c[d])}catch(a){}}}try{G[a].pc.close()}catch(a){}}else b.callCancelled&&b.callCancelled(a,!0);delete G[a],F()}else b.callCancelled&&b.callCancelled(a,!0)}function wa(a){var b;for(b in C)if(C.hasOwnProperty(b)&&C[b][a])return!0;return!1}function xa(a){var b;for(b in G)G.hasOwnProperty(b)&&"undefined"==typeof a[b]&&(wa(b)||((G[b].pc||G[b].isInitiator)&&va(b),delete v[b],delete H[b],ta(b)));for(b in v)v.hasOwnProperty(b)&&!wa(b)&&(va(b),ta(b),delete v[b],delete H[b]);for(b in H)H.hasOwnProperty(b)&&!wa(b)&&(va(b),ta(b),delete H[b])}function za(a,b,c){c||(c=100);var d=0;ya[a]&&(clearTimeout(ya[a].timer),d=ya[a].counter),d>20?(delete ya[a],b()):(ya[a]={counter:d+1},ya[a].timer=setTimeout(function(){delete ya[a],b()},c))}function Aa(a,c){var f,d=null,e={};for(f in c)c.hasOwnProperty(f)&&(f===b.myEasyrtcid?d=c[f]:e[f]=c[f]);xa(e),za("roomOccupants&"+a,function(){z&&z(a,e,d),b.emitEvent("roomOccupants",{roomName:a,occupants:C})},100)}function Ba(a,c){var d={};c&&c(b.ackMessage),a.targetEasyrtcid&&(d.targetEasyrtcid=a.targetEasyrtcid),a.targetRoom&&(d.targetRoom=a.targetRoom),a.targetGroup&&(d.targetGroup=a.targetGroup),a.senderEasyrtcid?b.receivePeerDistribute(a.senderEasyrtcid,a,d):E?E(a.msgType,a.msgData,d):webrtcUtils.log("Unhandled server message "+JSON.stringify(a))}function Ca(a){var c;0!==a.indexOf("turn:")&&0!==a.indexOf("turns:")||(c=a.split(/[@:&]/g)[1],b._turnServers[c]=!0)}function Da(a){var c,d,e;for(W={iceServers:[]},b._turnServers={},a&&a.iceServers&&"undefined"!=typeof a.iceServers.length?W={iceServers:a.iceServers}:b.showError(b.errCodes.DEVELOPER_ERR,"iceConfig received from server didn't have an array called iceServers, ignoring it"),c=0;c<a.iceServers.length;c++)if(e=a.iceServers[c],e.urls&&e.urls.length)for(d=0;d<e.urls.length;d++)Ca(e.urls[d]);else e.url&&Ca(e.url)}function Ea(a){a&&(a.easyrtcsid&&(b.easyrtcsid=a.easyrtcsid),a.field&&(q=a.field))}function Fa(a){b.roomData=a;var c,d,e,f,g,h;for(d in b.roomData)if(b.roomData.hasOwnProperty(d)){if("join"===a[d].roomStatus){b.roomJoin[d]||(b.roomJoin[d]=a[d]);var i=S();i!=={}&&b.setRoomApiField(d,"mediaIds",i)}else if("leave"===a[d].roomStatus){b.roomEntryListener&&b.roomEntryListener(!1,d),delete b.roomJoin[d],delete C[d];continue}if(a[d].clientList)C[d]=a[d].clientList;else if(a[d].clientListDelta){if(f=a[d].clientListDelta.updateClient)for(g in f)if(f.hasOwnProperty(g)){C[d]||(C[d]=[]),C[d][g]||(C[d][g]=f[g]);for(c in f[g])"apiField"!==c&&"presence"!==c||(C[d][g][c]=f[g][c])}if(e=a[d].clientListDelta.removeClient,e&&C[d])for(h in e)e.hasOwnProperty(h)&&delete C[d][h]}b.roomJoin[d]&&a[d].field&&(_.rooms[d]=a[d].field),"join"===a[d].roomStatus&&b.roomEntryListener&&b.roomEntryListener(!0,d),Aa(d,C[d])}b.emitEvent("roomOccupant",C)}function Ga(a,c){function m(a){delete H[a],sa[a]&&delete sa[a],G[a]&&(G[a].wasAcceptedCB&&G[a].wasAcceptedCB(!1,a),delete G[a])}function n(a,c){if(delete H[a],G[a]){G[a].connectionAccepted=!0,G[a].wasAcceptedCB&&G[a].wasAcceptedCB(!0,a);var d=function(){},f=function(c,d){G[a]&&delete G[a],b.showError(c,d)};ga(a,d,f),i=G[a].pc;var g=new RTCSessionDescription(c);if(!g)throw"Could not create the RTCSessionDescription";b.debugPrinter&&b.debugPrinter("about to call initiating setRemoteDescription");try{e&&(g.sdp=e(g.sdp)),i.setRemoteDescription(g,function(){i.connectDataConnection&&(b.debugPrinter&&b.debugPrinter("calling connectDataConnection(5001,5002)"),i.connectDataConnection(5001,5002))},function(a){webrtcUtils.log("setRemoteDescription failed ",a)})}catch(a){webrtcUtils.log("setRemoteDescription failed ",a)}k(a)}}function o(a,b){G[a]&&G[a].pc?j(a,b):(G[a]||(sa[a]={candidates:[]}),sa[a].candidates.push(b))}var i,d=a.senderEasyrtcid,g=a.msgType,h=a.msgData;b.debugPrinter&&b.debugPrinter("received message of type "+g),"undefined"==typeof sa[d]&&ta(d);var j=function(a,c){function e(){}function g(a){b.showError(b.errCodes.ICECANDIDATE_ERR,"bad ice candidate ("+a.name+"): "+JSON.stringify(d))}var d=null;if((!f||(c=f(c,!0)))&&(d=new RTCIceCandidate({sdpMLineIndex:c.label,candidate:c.candidate}),i=G[a].pc,i.addIceCandidate(d,e,g),c.candidate.indexOf("typ relay")>0)){var h=c.candidate.match(/(udp|tcp) \d+ (\d+\.\d+\.\d+\.\d+)/i)[2];b._turnServers[h]=!0}},k=function(a){var b;if(sa[a]){for(b=0;b<sa[a].candidates.length;b++)j(a,sa[a].candidates[b]);delete sa[a]}},l=function(a,c){var d=function(d,e){if(e)if("string"==typeof e)e=[e];else if(void 0===e.length)return void b.showError(b.errCodes.DEVELOPER_ERR,"accept callback passed invalid streamNames");if(b.debugPrinter&&b.debugPrinter("offer accept="+d),delete v[a],d){if(!b.supportsPeerConnections())return void b.showError(b.errCodes.CALL_ERR,b.getConstantString("noWebrtcSupport"));pa(a,c,e),k(a)}else ca(a,"reject",null,null,null),ta(a)};return H[a]&&a<b.myEasyrtcid?(delete H[a],sa[a]&&delete sa[a],G[a].wasAcceptedCB&&G[a].wasAcceptedCB(!0,a),delete G[a],void d(!0)):(v[a]=c,void(b.acceptCheck?b.acceptCheck(a,d):d(!0)))};switch(g){case"sessionData":Ea(h.sessionData);break;case"roomData":Fa(h.roomData);break;case"iceConfig":Da(h.iceConfig);break;case"forwardToUrl":h.newWindow?window.open(h.forwardToUrl.url):window.location.href=h.forwardToUrl.url;break;case"offer":l(d,h);break;case"reject":m(d);break;case"answer":n(d,h);break;case"candidate":o(d,h);break;case"hangup":va(d),ta(d);break;case"error":b.showError(h.errorCode,h.errorText);break;default:return void b.showError(b.errCodes.DEVELOPER_ERR,"received unknown message type from server, msgType is "+g)}c&&c(b.ackMessage)}function Ha(a){var c=a.msgData;b.debugPrinter&&b.debugPrinter("entered process token"),c.easyrtcid&&(b.myEasyrtcid=c.easyrtcid),c.field&&(_.connection=c.field),c.iceConfig&&Da(c.iceConfig),c.sessionData&&Ea(c.sessionData),c.roomData&&Fa(c.roomData),c.application.field&&(_.application=c.application.field)}function Ia(c,d){var e,f,g,h=null;if(b.cookieId&&document.cookie)for(e=document.cookie.split(/[; ]/g),f=b.cookieId+"=",g=0;g<e.length;g++)0===e[g].indexOf(f)&&(h=e[g].substring(f.length));var i={apiVersion:b.apiVersion,applicationName:b.applicationName,setUserCfg:la(!0)};b.roomJoin||(b.roomJoin={}),b.presenceShow&&(i.setPresence={show:b.presenceShow,status:b.presenceStatus}),b.username&&(i.username=b.username),b.roomJoin&&!a(b.roomJoin)&&(i.roomJoin=b.roomJoin),h&&(i.easyrtcsid=h),w&&(i.credential=w),b.webSocket.json.emit("easyrtcAuth",{msgType:"authenticate",msgData:i},function(a){var e;if("error"===a.msgType)d(a.msgData.errorCode,a.msgData.errorText),b.roomJoin={};else{if(Ha(a),b._roomApiFields)for(e in b._roomApiFields)b._roomApiFields.hasOwnProperty(e)&&P(e);c&&c(b.myEasyrtcid)}})}function Ja(a,c){function e(a,c){b.webSocket.on(a,c),b.websocketListeners.push({event:a,handler:c})}function f(d){b.webSocketConnected=!0,b.webSocket||b.showError(b.errCodes.CONNECT_ERR,b.getConstantString("badsocket")),b.debugPrinter&&b.debugPrinter("saw socket-server onconnect event"),b.webSocketConnected?Ia(a,c):c(b.errCodes.SIGNAL_ERR,b.getConstantString("icf"))}var d;if(aa)b.webSocket=aa;else if(b.webSocket)for(d in b.websocketListeners)b.websocketListeners.hasOwnProperty(d)&&b.webSocket.removeEventListener(b.websocketListeners[d].event,b.websocketListeners[d].handler);else try{if(b.webSocket=io.connect(y,h),!b.webSocket)throw"io.connect failed"}catch(a){return b.webSocket=0,void c(b.errCodes.SYSTEM_ERROR,a.toString())}b.websocketListeners=[],e("close",function(a){webrtcUtils.log("the web socket closed")}),e("error",function(a){function d(){b.myEasyrtcid&&j(b.webSocket)?b.showError(b.errCodes.SIGNAL_ERR,b.getConstantString("miscSignalError")):c(b.errCodes.CONNECT_ERR,b.getConstantString("noServer"))}d()}),j(aa)?f(null):e("connect",f),e("easyrtcMsg",Ba),e("easyrtcCmd",Ga),e("disconnect",function(){b.webSocketConnected=!1,F=function(){},u={},ba(),b.disconnectListener&&b.disconnectListener()})}var b=this,c=!0,d=null,e=null,f=null,g=null,h={"connect timeout":1e4,"force new connection":!0};this.setSdpFilters=function(a,b){d=a,e=b},this.setPeerClosedListener=function(a){this.onPeerClosed=a},this.setPeerFailingListener=function(a,b){this.onPeerFailing=a,this.onPeerRecovered=b},this.setIceCandidateFilter=function(a){f=a},this.setIceConnectionStateChangeListener=function(a){g=a},this.setAutoInitUserMedia=function(a){c=!!a},this.format=function(a,b,c,d){for(var e=arguments[0],f=1;f<arguments.length;f++){var g=new RegExp("\\{"+(f-1)+"\\}","gi");e=e.replace(g,arguments[f])}return e};var k={audio:!1,video:!1};this.getConstantString=function(a){return easyrtc_constantStrings[a]?easyrtc_constantStrings[a]:(b.showError(b.errCodes.DEVELOPER_ERR,"Could not find key='"+a+"' in easyrtc_constantStrings"),a)};var l={roomOccupant:!0,roomOccupants:!0},m={};this.addEventListener=function(a,c){if(n(a,"addEventListener"),"function"!=typeof c)throw b.showError(b.errCodes.DEVELOPER_ERR,"addEventListener called with a non-function for second argument"),"developer error";b.removeEventListener(a,c),m[a]||(m[a]=[]),m[a][m[a].length]=c},this.removeEventListener=function(a,b){n(a,"removeEventListener");var c=m[a],d=0;if(c)for(d=0;d<c.length;d++)c[d]===b&&(d<c.length-1&&(c[d]=c[c.length-1]),c.length=c.length-1)},this.emitEvent=function(a,b){n(a,"emitEvent");var c=m[a],d=0;if(c)for(d=0;d<c.length;d++)c[d](a,b)},this.errCodes={BAD_NAME:"BAD_NAME",CALL_ERR:"CALL_ERR",DEVELOPER_ERR:"DEVELOPER_ERR",SYSTEM_ERR:"SYSTEM_ERR",CONNECT_ERR:"CONNECT_ERR",MEDIA_ERR:"MEDIA_ERR",MEDIA_WARNING:"MEDIA_WARNING",INTERNAL_ERR:"INTERNAL_ERR",PEER_GONE:"PEER_GONE",ALREADY_CONNECTED:"ALREADY_CONNECTED",BAD_CREDENTIAL:"BAD_CREDENTIAL",ICECANDIDATE_ERR:"ICECANDIDATE_ERR",NOVIABLEICE:"NOVIABLEICE",SIGNAL_ERR:"SIGNAL_ERR"},this.apiVersion="1.0.17",this.ackMessage={msgType:"ack"},this.usernameRegExp=/^(.){1,64}$/,this.cookieId="easyrtcsid";this.loggingOut=!1,this.disconnecting=!1;var p={},q=[],r={};this.enableAudioReceive=function(a){"firefox"===webrtcDetectedBrowser?r.offerToReceiveAudio=a:(r.mandatory=r.mandatory||{},r.mandatory.OfferToReceiveAudio=a)},this.enableVideoReceive=function(a){"firefox"===webrtcDetectedBrowser?r.offerToReceiveVideo=a:(r.mandatory=r.mandatory||{},r.mandatory.OfferToReceiveVideo=a)},this.enableAudioReceive(!0),this.enableVideoReceive(!0),this.getAudioSourceList=function(a){s(a,"audioinput")},this.getVideoSourceList=function(a){s(a,"videoinput")},b.audioEnabled=!0,b.videoEnabled=!0;var t="dc";this.debugPrinter=null,this.myEasyrtcid="";var u={},v={};this.nativeVideoHeight=0,this.maxP2PMessageLength=1e3,this.nativeVideoWidth=0;var w=null;this.roomJoin={},this.isNameValid=function(a){return b.usernameRegExp.test(a)},this.setCookieId=function(a){b.cookieId=a},this._desiredVideoProperties={},this.setVideoSource=function(a){b._desiredVideoProperties.videoSrcId=a,delete b._desiredVideoProperties.screenCapture},this._desiredAudioProperties={},this.setAudioSource=function(a){b._desiredAudioProperties.audioSrcId=a},this.setVideoDims=function(a,c,d){b._desiredVideoProperties.width=a,b._desiredVideoProperties.height=c,void 0!==d&&(b._desiredVideoProperties.frameRate=d)},this.setScreenCapture=function(a){b._desiredVideoProperties.screenCapture=a!==!1},b.getUserMediaConstraints=function(){var a={};return b._presetMediaConstraints?(a=b._presetMediaConstraints,delete b._presetMediaConstraints,a):b._desiredVideoProperties.screenCapture?{video:{mandatory:{chromeMediaSource:"screen",maxWidth:screen.width,maxHeight:screen.height,minWidth:screen.width,minHeight:screen.height,minFrameRate:1,maxFrameRate:5},optional:[]},audio:!1}:(b.videoEnabled?"firefox"===webrtcDetectedBrowser?(a.video={},b._desiredVideoProperties.width&&(a.video.width=b._desiredVideoProperties.width),b._desiredVideoProperties.height&&(a.video.height=b._desiredVideoProperties.height),b._desiredVideoProperties.frameRate&&(a.video.frameRate={max:b._desiredVideoProperties.frameRate}),b._desiredVideoProperties.videoSrcId&&(a.video.deviceId=b._desiredVideoProperties.videoSrcId)):(a.video={mandatory:{},optional:[]},b._desiredVideoProperties.width&&(a.video.mandatory.maxWidth=b._desiredVideoProperties.width,a.video.mandatory.minWidth=b._desiredVideoProperties.width),b._desiredVideoProperties.height&&(a.video.mandatory.maxHeight=b._desiredVideoProperties.height,a.video.mandatory.minHeight=b._desiredVideoProperties.height),b._desiredVideoProperties.frameRate&&(a.video.mandatory.maxFrameRate=b._desiredVideoProperties.frameRate),b._desiredVideoProperties.videoSrcId&&(a.video.optional=a.video.optional||[],a.video.optional.push({sourceId:b._desiredVideoProperties.videoSrcId})),0===a.video.mandatory.length&&0===a.video.optional.length&&(a.video=!0)):a.video=!1,b.audioEnabled?"firefox"===webrtcDetectedBrowser?(a.audio={},b._desiredAudioProperties.audioSrcId&&(a.audio.deviceId=b._desiredAudioProperties.audioSrcId)):(a.audio={mandatory:{},optional:[]},b._desiredAudioProperties.audioSrcId&&(a.audio.optional=a.audio.optional||[],a.audio.optional.push({sourceId:b._desiredAudioProperties.audioSrcId}))):a.audio=!1,a)},this.setApplicationName=function(a){b.applicationName=a},this.enableDebug=function(a){a?b.debugPrinter=function(a){var b=(new Error).stack,c="location unknown";if(b){var d=b.split("\n");c="",d.length>=3&&(c=d[2])}webrtcUtils.log("debug "+(new Date).toISOString()+" : "+a+" ["+c+"]")}:b.debugPrinter=null},this.supportsGetUserMedia=function(){return!!getUserMedia},this.supportsPeerConnections=function(){return!!b.supportsGetUserMedia()&&!!window.RTCPeerConnection},this.createRTCPeerConnection=function(a,b){if(RTCPeerConnection)return new RTCPeerConnection(a,b);throw"Your browser doesn't support webRTC (RTCPeerConnection)"},this.getDatachannelConstraints=function(){return"chrome"===webrtcDetectedBrowser&&webrtcDetectedVersion<31?{reliable:!1}:{reliable:!0}},k={audio:!1,video:!1};var x=!1,y=null,z=null,A=null,B=null,C={},D={msgTypes:{}},E=null,F=function(){},G={},H={};this.acceptCheck=function(a,b){b(!0)},this.streamAcceptor=function(a,b){},this.onStreamClosed=function(a){},this.callCancelled=function(a){},this.getPeerConnectionByUserId=function(a){return G&&G[a]?G[a].pc:null};this.getPeerStatistics=function(a,c,d){"firefox"===webrtcDetectedBrowser?b.getFirefoxPeerStatistics(a,c,d):b.getChromePeerStatistics(a,c,d)};var O=null;this.setRoomApiField=function(a,c,d){if(b._roomApiFields||(b._roomApiFields={}),!c&&!d)return void delete b._roomApiFields[a];if(b._roomApiFields[a]||(b._roomApiFields[a]={}),void 0!==d&&null!==d){if("object"==typeof d)try{JSON.stringify(d)}catch(a){return void b.showError(b.errCodes.DEVELOPER_ERR,"easyrtc.setRoomApiField passed bad object ")}b._roomApiFields[a][c]={fieldName:c,fieldValue:d}}else delete b._roomApiFields[a][c];b.webSocketConnected&&P(a)},this.showError=function(a,c){b.onError({errorCode:a,errorText:c})},this.onError=function(a){b.debugPrinter&&b.debugPrinter("saw error "+a.errorText);var d,c=document.getElementById("easyrtcErrorDialog");if(!c){c=document.createElement("div"),c.id="easyrtcErrorDialog";var e=document.createElement("div");e.innerHTML="Error messages",e.className="easyrtcErrorDialog_title",c.appendChild(e),d=document.createElement("div"),d.id="easyrtcErrorDialog_body",c.appendChild(d);var f=document.createElement("button");f.appendChild(document.createTextNode("Okay")),f.className="easyrtcErrorDialog_okayButton",f.onclick=function(){d.innerHTML="",c.style.display="none"},c.appendChild(f),document.body.appendChild(c)}d=document.getElementById("easyrtcErrorDialog_body");var g=document.createElement("div");g.className="easyrtcErrorDialog_element",g.appendChild(document.createTextNode(a.errorText)),d.appendChild(g),c.style.display="block"},this.createObjectURL=function(a){var c;if(window.URL&&window.URL.createObjectURL)return window.URL.createObjectURL(a);if(window.webkitURL&&window.webkitURL.createObjectURL)return window.webkit.createObjectURL(a);throw c="Your browsers does not support URL.createObjectURL.",b.debugPrinter&&b.debugPrinter("saw exception "+c),c},this.cleanId=function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;"};return a.replace(/[&<>]/g,function(a){return b[a]})},b.setRoomEntryListener=function(a){b.roomEntryListener=a},b.setRoomOccupantListener=function(a){z=a},this.setDataChannelOpenListener=function(a){A=a},this.setDataChannelCloseListener=function(a){B=a},this.getConnectionCount=function(){var c,a=0;for(c in G)G.hasOwnProperty(c)&&b.getConnectStatus(c)===b.IS_CONNECTED&&a++;return a},this.setMaxP2PMessageLength=function(a){this.maxP2PMessageLength=a},this.enableAudio=function(a){b.audioEnabled=a},this.enableVideo=function(a){b.videoEnabled=a},this.enableDataChannels=function(a){x=a},this.getLocalMediaIds=function(){return Object.keys(p)},this.register3rdPartyLocalMediaStream=function(a,b){return T(a,b)},this.getNameOfRemoteStream=function(a,b){return"string"==typeof b?U(a,b):b.id?U(a,b.id):void 0},this.closeLocalMediaStream=function(a){return V(a)},this.closeLocalStream=this.closeLocalMediaStream,this.enableCamera=function(a,b){var c=R(b);c&&c.getVideoTracks&&Q(a,c.getVideoTracks())},this.enableMicrophone=function(a,b){var c=R(b);c&&c.getAudioTracks&&Q(a,c.getAudioTracks())},this.muteVideoObject=function(a,b){var c;if("string"==typeof a){if(c=document.getElementById(a),!c)throw"Unknown video object "+a}else{if(!a)throw"muteVideoObject passed a null";c=a}c.muted=!!b},b.getLocalStreamAsUrl=function(a){var c=R(a);if(null===c)throw"Developer error: attempt to get a MediaStream without invoking easyrtc.initMediaSource successfully";return b.createObjectURL(c)},this.getLocalStream=function(a){return R(a)||null},this.clearMediaStream=function(a){"undefined"!=typeof a.src?a.src="":"undefined"!=typeof a.srcObject?a.srcObject="":"undefined"!=typeof a.mozSrcObject&&(a.mozSrcObject=null)},this.setVideoObjectSrc=function(a,c){c&&""!==c?(a.autoplay=!0,attachMediaStream(a,c),a.play()):b.clearMediaStream(a)},this.buildLocalMediaStream=function(a,c,d){var e;if("string"!=typeof a)return b.showError(b.errCodes.DEVELOPER_ERR,"easyrtc.buildLocalMediaStream not supplied a stream name"),null;var f=null;for(var g in p)if(p.hasOwnProperty(g)&&(f=p[g]))break;if(!f)for(g in G)if(G.hasOwnProperty(g)){var h=G[g].pc.getRemoteStreams();h&&h.length>0&&(f=h[0])}if(!f)return b.showError(b.errCodes.DEVELOPER_ERR,"Attempt to create a mediastream without one to clone from"),null;var i=f.clone(),j=i.getTracks();if(c)for(e=0;e<c.length;e++)i.addTrack(c[e].clone());if(d)for(e=0;e<d.length;e++)i.addTrack(d[e].clone());for(e=0;e<j.length;e++)i.removeTrack(j[e]);return T(i,a),i},this.loadStylesheet=function(){var b,c,a=document.getElementsByTagName("link");for(b in a)if(a.hasOwnProperty(b)&&(c=a[b],c.href&&c.href.match(/\/easyrtc.css/)))return;var d=document.createElement("link");d.setAttribute("rel","stylesheet"),d.setAttribute("type","text/css"),d.setAttribute("href","/easyrtc/easyrtc.css");var e=document.getElementsByTagName("head")[0],f=e.childNodes[0];e.insertBefore(d,f)},this.formatError=function(a){var b,c;if(null===a||"undefined"==typeof a)return"null";if("string"==typeof a)return a;if(a.type&&a.description)return a.type+" : "+a.description;if("object"!=typeof a)return"Strange case";try{return JSON.stringify(a)}catch(d){c="{";for(b in a)a.hasOwnProperty(b)&&"string"==typeof a[b]&&(c=c+b+"='"+a[b]+"' ");return c+="}"}},this.initMediaSource=function(a,c,d){function h(){return(new Date).getTime()}function j(a){var b=h();b<i+1e3?(webrtcUtils.log("Trying getUserMedia a second time"),setTimeout(function(){getUserMedia(e,f,g)},3e3)):g(a)}if(b.debugPrinter&&b.debugPrinter("about to request local media"),d||(d="default"),k={audio:b.audioEnabled,video:b.videoEnabled},c||(c=function(a,c){var d="easyrtc.initMediaSource: "+b.formatError(c);b.debugPrinter&&b.debugPrinter(d),b.showError(b.errCodes.MEDIA_ERR,d)}),!b.supportsGetUserMedia())return void c(b.errCodes.MEDIA_ERR,b.getConstantString("noWebrtcSupport"));if(!a)return void b.showError(b.errCodes.DEVELOPER_ERR,"easyrtc.initMediaSource not supplied a successCallback");var e=b.getUserMediaConstraints(),f=function(c){b.debugPrinter&&b.debugPrinter("getUserMedia success callback entered"),b.debugPrinter&&b.debugPrinter("successfully got local media"),c.streamName=d,T(c,d);var e,f,g,h;k.video?(e=document.createElement("video"),e.muted=!0,f=30,g=function(){e.videoWidth>0||f<0?(b.nativeVideoWidth=e.videoWidth,b.nativeVideoHeight=e.videoHeight,!b._desiredVideoProperties.height||b.nativeVideoHeight===b._desiredVideoProperties.height&&b.nativeVideoWidth===b._desiredVideoProperties.width||b.showError(b.errCodes.MEDIA_WARNING,b.format(b.getConstantString("resolutionWarning"),b._desiredVideoProperties.width,b._desiredVideoProperties.height,b.nativeVideoWidth,b.nativeVideoHeight)),b.setVideoObjectSrc(e,null),e.removeNode?e.removeNode(!0):(h=document.createElement("div"),h.appendChild(e),h.removeChild(e)),F(),a&&a(c)):(f-=1,setTimeout(g,300))},b.setVideoObjectSrc(e,c),g()):(F(),a&&a(c))},g=function(a){webrtcUtils.log("getusermedia failed"),b.debugPrinter&&b.debugPrinter("failed to get local media");var e;e="string"==typeof a?a:a.name?a.name:"Unknown",c&&(webrtcUtils.log("invoking error callback",e),c(b.errCodes.MEDIA_ERR,b.format(b.getConstantString("gumFailed"),e))),V(d),k={audio:!1,video:!1},F()};if(!b.audioEnabled&&!b.videoEnabled)return void g(b.getConstantString("requireAudioOrVideo"));var i;setTimeout(function(){try{i=h(),getUserMedia(e,f,j)}catch(a){j(a)}},1e3)},this.setAcceptChecker=function(a){b.acceptCheck=a},this.setStreamAcceptor=function(a){b.streamAcceptor=a},b.setOnError=function(a){b.onError=a},this.setCallCancelled=function(a){b.callCancelled=a},this.setOnStreamClosed=function(a){b.onStreamClosed=a},this.supportsDataChannels=function(){return navigator.userAgent.match(/android/i)?webrtcDetectedVersion>=34:"firefox"===webrtcDetectedBrowser||webrtcDetectedVersion>=32},this.setPeerListener=function(a,b,c){b?(D.msgTypes[b]||(D.msgTypes[b]={sources:{}}),c?D.msgTypes[b].sources[c]={cb:a}:D.msgTypes[b].cb=a):D.cb=a},this.receivePeerDistribute=function(a,b,c){var d=b.msgType,e=b.msgData;if(!d)return void webrtcUtils.log("received peer message without msgType",b);if(D.msgTypes[d]){if(D.msgTypes[d].sources[a]&&D.msgTypes[d].sources[a].cb)return void D.msgTypes[d].sources[a].cb(a,d,e,c);if(D.msgTypes[d].cb)return void D.msgTypes[d].cb(a,d,e,c)}D.cb&&D.cb(a,d,e,c)},this.setServerListener=function(a){
E=a},this.setSocketUrl=function(a,c){b.debugPrinter&&b.debugPrinter("WebRTC signaling server URL set to "+a),y=a,c&&(h=c)},this.setUsername=function(a){return b.myEasyrtcid?(b.showError(b.errCodes.DEVELOPER_ERR,"easyrtc.setUsername called after authentication"),!1):b.isNameValid(a)?(b.username=a,!0):(b.showError(b.errCodes.BAD_NAME,b.format(b.getConstantString("badUserName"),a)),!1)},this.usernameToIds=function(a,b){var d,e,c=[];for(e in C)if(C.hasOwnProperty(e)&&(!b||e===b))for(d in C[e])C[e].hasOwnProperty(d)&&C[e][d].username===a&&c.push({easyrtcid:d,roomName:e});return c},this.getRoomApiField=function(a,b,c){return C[a]&&C[a][b]&&C[a][b].apiField&&C[a][b].apiField[c]?C[a][b].apiField[c].fieldValue:void 0},this.setCredential=function(a){try{return JSON.stringify(a),w=a,!0}catch(a){throw b.showError(b.errCodes.BAD_CREDENTIAL,"easyrtc.setCredential passed a non-JSON-able object"),"easyrtc.setCredential passed a non-JSON-able object"}},this.setDisconnectListener=function(a){b.disconnectListener=a},this.idToName=function(a){var b;for(b in C)if(C.hasOwnProperty(b)&&C[b][a]&&C[b][a].username)return C[b][a].username;return a},this.webSocket=null;var W={},X=null,Y=!1;this.setUseFreshIceEachPeerConnection=function(a){Y=a},this.getServerIce=function(){return W},this.setIceUsedInCalls=function(a){a.iceServers?X=a:b.showError(b.errCodes.DEVELOPER_ERR,"Bad ice configuration passed to easyrtc.setIceUsedInCalls")};var Z=null;this.haveAudioTrack=function(a,b){return $(a,!0,b)},this.haveVideoTrack=function(a,b){return $(a,!1,b)},this.getRoomField=function(a,c){var d=b.getRoomFields(a);return d&&d[c]?d[c].fieldValue:void 0},this.supportsStatistics=function(){var a;try{return a=new RTCPeerConnection({iceServers:[]},{}),!!a.getStats}catch(a){return!1}};var _=null,aa=null;this.disconnect=function(){b.debugPrinter&&b.debugPrinter("attempt to disconnect from WebRTC signalling server"),b.disconnecting=!0,b.hangupAll(),b.loggingOut=!0,setTimeout(function(){if(b.webSocket){try{b.webSocket.disconnect()}catch(a){}Z=b.webSocket,b.webSocket=0}b.loggingOut=!1,b.disconnecting=!1,z&&z(null,{},!1),b.emitEvent("roomOccupant",{}),u={}},250)};var da=0;this.sendDataP2P=function(a,c,d){var e=JSON.stringify({msgType:c,msgData:d});if(b.debugPrinter&&b.debugPrinter("sending p2p message to "+a+" with data="+JSON.stringify(e)),G[a])if(G[a].dataChannelS)if(G[a].dataChannelReady)try{e.length>b.maxP2PMessageLength?ea(a,e):G[a].dataChannelS.send(e)}catch(a){throw webrtcUtils.log("snedDataP2P error: ",a),a}else b.showError(b.errCodes.DEVELOPER_ERR,"Attempt to use data channel to "+a+" before it's ready to send.");else b.showError(b.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without establishing a data channel to "+a+" first.");else b.showError(b.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without a connection to "+a+" first.")},this.sendDataWS=function(a,c,d,e){b.debugPrinter&&b.debugPrinter("sending client message via websockets to "+a+" with data="+JSON.stringify(d)),e||(e=function(a){"error"===a.msgType&&b.showError(a.msgData.errorCode,a.msgData.errorText)});var f={msgType:c,msgData:d};if(a&&("string"==typeof a?f.targetEasyrtcid=a:"object"==typeof a&&(a.targetEasyrtcid&&(f.targetEasyrtcid=a.targetEasyrtcid),a.targetRoom&&(f.targetRoom=a.targetRoom),a.targetGroup&&(f.targetGroup=a.targetGroup))),!b.webSocket)throw b.debugPrinter&&b.debugPrinter("websocket failed because no connection to server"),"Attempt to send message without a valid connection to the server.";b.webSocket.json.emit("easyrtcMsg",f,e)},this.sendData=function(a,c,d,e){G[a]&&G[a].dataChannelReady?b.sendDataP2P(a,c,d):b.sendDataWS(a,c,d,e)},this.sendPeerMessage=function(a,c,d,e,f){function g(a){"error"===a.msgType?f&&f(a.msgData.errorCode,a.msgData.errorText):e&&e(a.msgType,a.msgData?a.msgData:null)}a||b.showError(b.errCodes.DEVELOPER_ERR,"destination was null in sendPeerMessage"),b.debugPrinter&&b.debugPrinter("sending peer message "+JSON.stringify(d)),b.sendDataWS(a,c,d,g)},this.sendServerMessage=function(a,c,d,e){function g(a){"error"===a.msgType?e&&e(a.msgData.errorCode,a.msgData.errorText):d&&d(a.msgType,a.msgData?a.msgData:null)}if(b.debugPrinter){var f={msgType:a,msgData:c};b.debugPrinter("sending server message "+JSON.stringify(f))}b.sendDataWS(null,a,c,g)},this.getRoomList=function(a,c){ca(null,"getRoomList",null,function(b,c){a(c.roomList)},function(a,d){c?c(a,d):b.showError(a,d)})},this.NOT_CONNECTED="not connected",this.BECOMING_CONNECTED="connection in progress to us.",this.IS_CONNECTED="is connected",this.getConnectStatus=function(a){if(!G.hasOwnProperty(a))return b.NOT_CONNECTED;var c=G[a];return!c.sharingAudio&&!c.sharingVideo||c.startedAV?c.sharingData&&!c.dataChannelReady?b.BECOMING_CONNECTED:b.IS_CONNECTED:b.BECOMING_CONNECTED},this.call=function(a,d,e,f,g){if(g)if("string"==typeof g)g=[g];else if("undefined"==typeof g.length)return void b.showError(b.errCodes.DEVELOPER_ERR,"easyrtc.call passed bad streamNames");if(b.debugPrinter&&b.debugPrinter("initiating peer to peer call to "+a+" audio="+b.audioEnabled+" video="+b.videoEnabled+" data="+x),!b.supportsPeerConnections())return void e(b.errCodes.CALL_ERR,b.getConstantString("noWebrtcSupport"));var h;if(!g&&c){var i=b.getLocalStream();if(!i&&(b.audioEnabled||b.videoEnabled))return void b.initMediaSource(function(){b.call(a,d,e,f)},e)}if(!b.webSocket)throw h="Attempt to make a call prior to connecting to service",b.debugPrinter&&b.debugPrinter(h),h;return v[a]?(f(!0,a),pa(a,v[a],g),delete v[a],void b.callCancelled(a,!1)):"undefined"!=typeof H[a]?(h="Call already pending acceptance",b.debugPrinter&&b.debugPrinter(h),void e(b.errCodes.ALREADY_CONNECTED,h)):void(Y?b.getFreshIceConfig(function(c){c?qa(a,d,e,f,g):e(b.errCodes.CALL_ERR,"Attempt to get fresh ice configuration failed")}):qa(a,d,e,f,g))};var sa={};this.hangup=function(a){ua(a),F()},this.hangupAll=function(){var a=!1;for(var b in G)G.hasOwnProperty(b)&&(a=!0,ua(b));a&&F()},this.doesDataChannelWork=function(a){return!!G[a]&&!!G[a].dataChannelReady},this.getRemoteStream=function(a,c){if(G[a])return G[a].getRemoteStreamByName(c);throw b.showError(b.errCodes.DEVELOPER_ERR,"attempt to get stream of uncalled party"),"Developer err: no such stream"},this.makeLocalStreamFromRemoteStream=function(a,b,c){var d;if(!G[a].pc)throw"Developer err: no such peer ";if(d=G[a].getRemoteStreamByName(b),!d)throw"Developer err: no such stream";T(d,c)},this.addStreamToCall=function(a,b,c){b||(b="default");var d=R(b);if(d)if(G[a]&&G[a].pc){var e=G[a].pc;G[a].enableNegotiateListener=!0,e.addStream(d),c&&(G[a].streamsAddedAcks[b]=c)}else webrtcUtils.log("Can't add stream before a call has started.");else webrtcUtils.log("attempt to add nonexistent stream "+b)},this.setPeerListener(function(a,c,f){if(G[a]&&G[a].pc){var g=f.sdp,h=G[a].pc,i=function(c){var e=function(){function d(){}function e(c,d){delete G[a],b.showError(c,d)}b.debugPrinter&&b.debugPrinter("sending answer"),ca(a,"answer",c,d,e),G[a].connectionAccepted=!0,ga(a,d,e)};d&&(c.sdp=d(c.sdp)),h.setLocalDescription(c,e,function(a){b.showError(b.errCodes.INTERNAL_ERR,"setLocalDescription: "+f)})},j=function(){h.createAnswer(i,function(a){b.showError(b.errCodes.INTERNAL_ERR,"create-answer: "+a)},r),b.sendPeerMessage(a,"__gotAddedMediaStream",{sdp:g})};b.debugPrinter&&b.debugPrinter("about to call setRemoteDescription in doAnswer");try{e&&(g.sdp=e(g.sdp)),h.setRemoteDescription(new RTCSessionDescription(g),j,function(a){b.showError(b.errCodes.INTERNAL_ERR,"set-remote-description: "+a)})}catch(a){webrtcUtils.log("set remote description failed"),b.debugPrinter&&b.debugPrinter("saw exception in setRemoteDescription"),b.showError(b.errCodes.INTERNAL_ERR,"setRemoteDescription failed: "+a.message)}}else b.showError(b.errCodes.DEVELOPER_ERR,"Attempt to add additional stream before establishing the base call.")},"__addedMediaStream"),this.setPeerListener(function(a,c,d){if(G[a]&&G[a].pc){var f=d.sdp;e&&(f.sdp=e(f.sdp));var g=G[a].pc;g.setRemoteDescription(new RTCSessionDescription(f),function(){},function(a){b.showError(b.errCodes.INTERNAL_ERR,"set-remote-description: "+a)})}else b.debugPrinter&&b.debugPrinter("setPeerListener failed: __gotAddedMediaStream Unknow easyrtcid "+a)},"__gotAddedMediaStream"),this.setPeerListener(function(a,c,d){if(G[a]&&G[a].pc){var e=G[a].getRemoteStreamByName(d.streamName);e&&(ia(a,e),i(e))}else b.debugPrinter&&b.debugPrinter("setPeerListener failed: __closingMediaStream Unknow easyrtcid "+a)},"__closingMediaStream"),this.dumpPeerConnectionInfo=function(){var a;for(var b in G)if(G.hasOwnProperty(b)){webrtcUtils.log("For peer "+b);var c=G[b].pc,d=c.getRemoteStreams(),e=[];for(a=0;a<d.length;a++)e.push(d[a].id);var f=c.getLocalStreams(),g=[];for(a=0;a<f.length;a++)g.push(f[a].id);webrtcUtils.log("    "+JSON.stringify({local:g,remote:e}))}},this.isPeerInAnyRoom=function(a){return wa(a)};var ya={};this.updatePresence=function(a,c){b.presenceShow=a,b.presenceStatus=c,b.webSocketConnected&&ca(null,"setPresence",{setPresence:{show:b.presenceShow,status:b.presenceStatus}},null)},this.getSessionFields=function(){return q},this.getSessionField=function(a){return q[a]?q[a].fieldValue:void 0},this.getRoomOccupantsAsArray=function(a){return C[a]?Object.keys(C[a]):null},this.getRoomOccupantsAsMap=function(a){return C[a]},this.isTurnServer=function(a){return!!b._turnServers[a]},this.getFreshIceConfig=function(a){var c={msgType:"getIceConfig",msgData:{}};a||(a=function(){}),b.webSocket.json.emit("easyrtcCmd",c,function(c){"iceConfig"===c.msgType?(Da(c.msgData.iceConfig),a(!0)):(b.showError(c.msgData.errorCode,c.msgData.errorText),a(!1))})},this.joinRoom=function(a,c,d,e){if(b.roomJoin[a])return void b.showError(b.errCodes.DEVELOPER_ERR,"Attempt to join room "+a+" which you are already in.");var f={roomName:a};if(c){try{JSON.stringify(c)}catch(a){throw b.showError(b.errCodes.DEVELOPER_ERR,"non-jsonable parameter to easyrtc.joinRoom"),"Developer error, see application error messages"}var g={};for(var h in c)c.hasOwnProperty(h)&&(g[h]=c[h]);f.roomParameter=g}var j,k,l,i={roomJoin:{}};b.webSocket?(i.roomJoin[a]=f,k=function(c,e){j=e.roomData,b.roomJoin[a]=f,d&&d(a),Fa(j)},l=function(c,d){e?e(c,d,a):b.showError(c,b.format(b.getConstantString("unableToEnterRoom"),a,d))},ca(null,"roomJoin",i,k,l)):b.roomJoin[a]=f},this.leaveRoom=function(a,c,d){var e;b.roomJoin[a]&&(b.webSocket?(e={},e[a]={roomName:a},ca(null,"roomLeave",{roomLeave:e},function(b,d){var e=d.roomData;Fa(e),c&&c(a)},function(b,c){d&&d(b,c,a)})):delete b.roomJoin[a])},this.getRoomsJoined=function(){var c,a={};for(c in b.roomJoin)b.roomJoin.hasOwnProperty(c)&&(a[c]=!0);return a},this.getRoomFields=function(a){return _&&_.rooms&&_.rooms[a]?_.rooms[a]:void 0},this.getApplicationFields=function(){return _.application},this.getConnectionFields=function(){return _.connection},this.useThisSocketConnection=function(a){aa=a},this.connect=function(a,c,d){return window.io||b.showError(b.errCodes.DEVELOPER_ERR,"Your HTML has not included the socket.io.js library"),!aa&&b.webSocket?void b.showError(b.errCodes.DEVELOPER_ERR,"Attempt to connect when already connected to socket server"):(W={},Z=null,u={},sa={},b.applicationName=a,_={rooms:{},application:{},connection:{}},b.debugPrinter&&b.debugPrinter("attempt to connect to WebRTC signalling server with application name="+a),null===d&&(d=function(a,c){b.showError(a,c)}),void Ja(c,d))}};window.easyrtc=new Easyrtc,function(){function b(b,c){function i(a,b){var c;if(a&&!document.getElementById(a))return easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"The monitor video id passed to easyApp was bad, saw "+a),!1;for(c in b)if(b.hasOwnProperty(c)){var d=b[c];if(!document.getElementById(d))return easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"The caller video id '"+d+"' passed to easyApp was bad."),!1}return!0}function j(a){return f[a.id]}function k(a,b){f[a.id]=b}function l(a){var b=j(a);return""===b||null===b||void 0===b}function m(a){return d[a]?document.getElementById(d[a]):null}function n(a,b){easyrtc.setVideoObjectSrc(a,b),a.style.visibility&&(a.style.visibility="visible")}function o(a){easyrtc.setVideoObjectSrc(a,""),a.style.visibility="hidden"}var d=c||[],e=c.length,f={},g=null,h=null;if(!i(b,d))throw"bad video element id";b&&(document.getElementById(b).muted="muted"),easyrtc.addEventListener("roomOccupants",function(a,b){var c;for(c=0;c<e;c++){var d=m(c);l(d)||easyrtc.isPeerInAnyRoom(j(d))||(h&&h(j(d),c),k(d,null))}}),easyrtc.setOnCall=function(a){g=a},easyrtc.setOnHangup=function(a){h=a},easyrtc.getIthCaller=function(a){if(a<0||a>=d.length)return null;var b=m(a);return j(b)},easyrtc.getSlotOfCaller=function(a){var b;for(b=0;b<e;b++)if(easyrtc.getIthCaller(b)===a)return b;return-1},easyrtc.setOnStreamClosed(function(a){var b;for(b=0;b<e;b++){var c=m(b);j(c)===a&&(o(c),k(c,""),h&&h(a,b))}}),easyrtc.setAcceptChecker(function(a,b){var c;for(c=0;c<e;c++){var d=m(c);if(l(d))return void b(!0)}b(!1)}),easyrtc.setStreamAcceptor(function(a,b){var c;easyrtc.debugPrinter&&easyrtc.debugPrinter("stream acceptor called");var d;for(c=0;c<e;c++)if(d=m(c),j(d)===a)return n(d,b),void(g&&g(a,c));for(c=0;c<e;c++)if(d=m(c),l(d))return k(d,a),g&&g(a,c),void n(d,b);d=m(0),d&&(easyrtc.hangup(j(d)),n(d,b),g&&g(a,0)),k(d,a)});var p,q,r,s;if(a)for(p=function(a){q=a.parentNode,k(a,""),r=document.createElement("div"),r.className="easyrtc_closeButton",r.onclick=function(){j(a)&&(easyrtc.hangup(j(a)),o(a),k(a,""))},q.appendChild(r)},s=0;s<e;s++)p(m(s));var t=null;if(easyrtc.videoEnabled&&null!==b){if(t=document.getElementById(b),!t)return void console.error("Programmer error: no object called "+b);t.muted="muted",t.defaultMuted=!0}}var a=!0;easyrtc.dontAddCloseButtons=function(){a=!1},easyrtc.easyApp=function(a,c,d,e,f){function i(){h&&h(!0,""),e(easyrtc.myEasyrtcid)}function j(){function b(a,b){h?h(!1,b):f?f(easyrtc.errCodes.CONNECT_ERR,b):easyrtc.showError(easyrtc.errCodes.CONNECT_ERR,b)}g&&g(!0,null),null!==c&&easyrtc.setVideoObjectSrc(document.getElementById(c),easyrtc.getLocalStream()),easyrtc.connect(a,i,b)}var g=null,h=null;b(c,d),easyrtc.setGotMedia=function(a){g=a},easyrtc.setPeerClosedListener(function(a){setTimeout(function(){easyrtc.getSlotOfCaller(a)>=0&&easyrtc.isPeerInAnyRoom(a)&&easyrtc.call(a,function(){},function(){},function(){})},1e3)}),easyrtc.setGotConnection=function(a){h=a};var k=easyrtc.getLocalStream(null);k?j():easyrtc.initMediaSource(j,function(a,b){g?g(!1,b):f?f(easyrtc.errCodes.MEDIA_ERR,b):easyrtc.showError(easyrtc.errCodes.MEDIA_ERR,b)},null)}}();var easyrtc_constantStrings={unableToEnterRoom:"Unable to enter room {0} because {1}",resolutionWarning:"Requested video size of {0}x{1} but got size of {2}x{3}",badUserName:"Illegal username {0}",localMediaError:"Error getting local media stream: {0}",miscSignalError:"Miscellaneous error from signalling server. It may be ignorable.",noServer:"Unable to reach the EasyRTC signalling server.",badsocket:"Socket.io connect event fired with bad websocket.",icf:"Internal communications failure",statsNotSupported:"call statistics not supported by this browser, try Chrome.",noWebrtcSupport:"Your browser doesn't appear to support WebRTC.",gumFailed:"Failed to get access to local media. Error code was {0}.",requireAudioOrVideo:"At least one of audio and video must be provided"};